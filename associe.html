<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GFA Manager ‚Äî Mon Espace</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Cormorant+Garamond:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, addDoc, updateDoc }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  ‚úÖ  CONFIGURATION FIREBASE ‚Äî Projet : gfa-manager-50a7f    ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
const firebaseConfig = {
  apiKey:            "AIzaSyB6MW35DPPsh59DoOEPVXml6FIvDNFgdI0",
  authDomain:        "gfa-manager-50a7f.firebaseapp.com",
  projectId:         "gfa-manager-50a7f",
  storageBucket:     "gfa-manager-50a7f.firebasestorage.app",
  messagingSenderId: "224596157977",
  appId:             "1:224596157977:web:c8d09907b8185010076c88"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const TOKEN = new URLSearchParams(location.search).get('token');

async function findAssocieByToken(token) {
  const gSnap = await getDocs(collection(db, "groupements"));
  for (const gDoc of gSnap.docs) {
    const aSnap = await getDocs(
      query(collection(db,"groupements",gDoc.id,"associes"), where("token","==",token))
    );
    if (!aSnap.empty) {
      const aDoc = aSnap.docs[0];
      return { groupement:{id:gDoc.id,...gDoc.data()}, associe:{id:aDoc.id,...aDoc.data()} };
    }
  }
  return null;
}

// Charge la campagne active pour le vigneron du groupement
async function getCampagneActive(vigneron) {
  const snap = await getDocs(
    query(collection(db, "campagnes"), where("vigneron","==",vigneron), where("actif","==",true))
  );
  if(snap.empty) return null;
  return {id:snap.docs[0].id, ...snap.docs[0].data()};
}

// Charge TOUTES les campagnes d'un vigneron (actives et pass√©es)
async function getCampagnesVigneron(vigneron) {
  const snap = await getDocs(
    query(collection(db, "campagnes"), where("vigneron","==",vigneron))
  );
  return snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>(b.annee||0)-(a.annee||0));
}

// Charge les vins de la campagne filtr√©s par groupement
async function getVinsCampagne(campagneId, groupementId) {
  const snap = await getDocs(
    query(collection(db,"campagnes",campagneId,"vins"), where("groupement_id","==",groupementId))
  );
  return snap.docs.map(d=>({id:d.id,...d.data()}));
}

// Charge toutes les commandes de l'associ√© (toutes campagnes confondues)
async function getCommandes(associeId) {
  // Les commandes sont maintenant dans /campagnes/{id}/commandes
  // On doit chercher dans toutes les campagnes
  const campagnesSnap = await getDocs(collection(db, "campagnes"));
  const toutesCommandes = [];
  
  for(const campDoc of campagnesSnap.docs) {
    const cmdsSnap = await getDocs(
      query(collection(db,"campagnes",campDoc.id,"commandes"), where("associe_id","==",associeId))
    );
    cmdsSnap.docs.forEach(cmdDoc => {
      toutesCommandes.push({
        id: cmdDoc.id,
        campagne_id: campDoc.id,
        ...cmdDoc.data()
      });
    });
  }
  
  return toutesCommandes.sort((a,b)=>(b.annee||0)-(a.annee||0));
}

// Sauvegarde la commande dans /campagnes/{campagneId}/commandes
async function saveCommande(campagneId, associeId, groupementId, annee, panier, modeRecup, valider, nomsSn, prixSn) {
  const existing = (await getDocs(
    query(collection(db,"campagnes",campagneId,"commandes"),
          where("associe_id","==",associeId), where("groupement_id","==",groupementId))
  )).docs[0];
  
  const data = {
    associe_id: associeId,
    groupement_id: groupementId,
    campagne_id: campagneId,
    annee,
    panier,
    mode_recup: modeRecup,
    validee: valider,
    date_maj: new Date().toISOString(),
    noms_snapshot: nomsSn||{},
    prix_snapshot: prixSn||{}
  };
  
  if (existing) {
    await updateDoc(doc(db,"campagnes",campagneId,"commandes",existing.id), data);
    return existing.id;
  } else {
    const r = await addDoc(collection(db,"campagnes",campagneId,"commandes"), data);
    return r.id;
  }
}

window.ASSOC_API = { findAssocieByToken, getCampagneActive, getCampagnesVigneron, getVinsCampagne, getCommandes, saveCommande };
window.dispatchEvent(new Event('api:ready'));
</script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--burg:#6B1E3C;--deep:#4A1228;--gold:#C9A961;--cream:#F8F5EF;--dark:#2C1810;--sage:#8B9A7E;--terra:#C67B5C}
body{font-family:'Cormorant Garamond',serif;background:var(--cream);color:var(--dark);overflow-x:hidden}
.grain{position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:.03;
  background:url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='2.5' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}
/* Header */
.hdr{background:linear-gradient(135deg,var(--burg),var(--deep));color:var(--cream);
  padding:2.8rem 2rem 2rem;text-align:center;position:relative;overflow:hidden}
.hdr::before{content:'';position:absolute;inset:0;
  background:repeating-linear-gradient(45deg,transparent,transparent 35px,rgba(255,255,255,.03) 35px,rgba(255,255,255,.03) 70px);pointer-events:none}
.logo{font-family:'Playfair Display',serif;font-size:2.6rem;font-weight:900;position:relative;z-index:2}
.logo em{color:var(--gold);font-style:italic}
.deco{width:80px;height:2px;background:var(--gold);margin:.7rem auto;position:relative;z-index:2}
.tagline{font-size:.95rem;opacity:.8;position:relative;z-index:2}
.hdr-name{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:600;
  color:var(--gold);margin-top:.4rem;position:relative;z-index:2}
/* Tabs */
.tabs{background:white;box-shadow:0 4px 20px rgba(107,30,60,.1);position:sticky;top:0;z-index:100}
.tabs-inner{max-width:960px;margin:0 auto;display:flex}
.tab{flex:1;padding:1.2rem 1rem;border:none;background:transparent;font-family:'Playfair Display',serif;
  font-size:.95rem;font-weight:600;color:var(--burg);cursor:pointer;transition:all .3s;position:relative}
.tab::after{content:'';position:absolute;bottom:-1px;left:50%;width:0;height:3px;
  background:var(--gold);transform:translateX(-50%);transition:width .3s}
.tab.active::after,.tab:hover::after{width:100%}
.tab.active{color:var(--deep);background:linear-gradient(to bottom,rgba(201,169,97,.1),transparent)}
/* Main */
.main{max-width:960px;margin:0 auto;padding:2.5rem 2rem;animation:fadeIn .5s}
/* Card */
.card{background:white;border-radius:2px;padding:2.2rem;margin-bottom:1.8rem;
  box-shadow:0 2px 4px rgba(107,30,60,.08),0 8px 16px rgba(107,30,60,.06),inset 0 0 0 1px rgba(107,30,60,.1);
  position:relative;overflow:hidden}
.card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent,rgba(201,169,97,.03));pointer-events:none}
.ctitle{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:700;color:var(--burg);margin-bottom:1.3rem}
/* Info grid */
.igrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:1.1rem}
.iitem{padding:1.1rem 1.3rem;background:linear-gradient(135deg,rgba(107,30,60,.03),rgba(201,169,97,.03));border-left:3px solid var(--burg);border-radius:2px}
.lbl{font-size:.78rem;text-transform:uppercase;letter-spacing:.1em;color:var(--burg);font-weight:600;margin-bottom:.3rem}
.val{font-family:'Playfair Display',serif;font-size:1.15rem;color:var(--dark);font-weight:600}
/* Cr√©dits */
.creds{background:linear-gradient(135deg,var(--burg),var(--deep));color:white;
  padding:2.2rem 2rem;border-radius:2px;text-align:center;margin-bottom:1.8rem;
  position:relative;overflow:hidden;box-shadow:0 8px 32px rgba(107,30,60,.3)}
.creds::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;
  background:radial-gradient(circle,rgba(201,169,97,.2) 0%,transparent 70%);animation:rotate 20s linear infinite}
.cred-amt{font-family:'Playfair Display',serif;font-size:3.2rem;font-weight:900;color:var(--gold);position:relative;z-index:2;animation:pulse 2.5s ease-in-out infinite}
.cred-lbl{font-size:.95rem;font-weight:300;letter-spacing:.12em;text-transform:uppercase;opacity:.9;position:relative;z-index:2;margin-top:.3rem}
.cred-det{font-size:.9rem;opacity:.8;position:relative;z-index:2;margin-top:.5rem}
.cbar-w{max-width:320px;margin:.7rem auto 0;background:rgba(255,255,255,.2);border-radius:4px;height:6px;position:relative;z-index:2}
.cbar{height:6px;background:var(--gold);border-radius:4px;transition:width .5s}
/* Vins */
.wgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1.4rem;margin:1.4rem 0}
.wcard{background:white;border:2px solid transparent;border-radius:2px;padding:1.6rem;
  transition:all .3s;cursor:pointer;box-shadow:0 2px 8px rgba(107,30,60,.07);position:relative}
.wcard::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;
  background:linear-gradient(to bottom,var(--burg),var(--gold));opacity:0;transition:opacity .3s}
.wcard:hover{border-color:var(--gold);transform:translateY(-2px)}
.wcard:hover::before,.wcard.sel::before{opacity:1}
.wcard.sel{border-color:var(--burg);background:linear-gradient(to bottom,rgba(107,30,60,.03),white)}
.wcard.maxed{opacity:.5;cursor:not-allowed}
.wname{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;color:var(--deep);margin-bottom:.4rem}
.wdesc{font-size:.88rem;color:#666;margin-bottom:.9rem;line-height:1.5}
.wprice{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:700;color:var(--burg)}
.wprice em{font-size:.85rem;color:var(--gold);font-style:normal;margin-left:.2rem}
.wstock{font-size:.8rem;color:var(--terra);margin-top:.3rem}
.qty{display:flex;align-items:center;justify-content:center;gap:1rem;margin-top:1.1rem}
.qb{width:36px;height:36px;border:2px solid var(--burg);border-radius:50%;background:white;
  color:var(--burg);font-size:1.1rem;cursor:pointer;transition:all .25s;display:flex;align-items:center;justify-content:center}
.qb:hover:not(:disabled){background:var(--burg);color:white;transform:scale(1.1)}
.qb:disabled{opacity:.3;cursor:not-allowed;transform:none}
.qn{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;color:var(--deep);min-width:40px;text-align:center}
/* R√©cap */
.recap{background:linear-gradient(to bottom,rgba(248,245,239,.6),white);border:2px solid var(--gold);border-radius:2px;padding:1.8rem;margin:1.5rem 0}
.rtitle{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;color:var(--burg);margin-bottom:1.3rem;text-align:center;text-transform:uppercase;letter-spacing:.05em}
.rrow{display:flex;justify-content:space-between;align-items:center;padding:.75rem 0;border-bottom:1px solid rgba(107,30,60,.09);font-size:.95rem}
.rrow:last-child{border-bottom:none;padding-top:1.2rem;border-top:2px solid var(--gold);font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:700;color:var(--deep)}
/* Mode r√©cup */
.modes{display:flex;gap:1rem;margin:.8rem 0 1.4rem}
.mopt{flex:1;padding:1rem;border:2px solid rgba(107,30,60,.2);border-radius:2px;
  text-align:center;cursor:pointer;transition:all .25s;font-family:'Playfair Display',serif;font-size:.95rem;font-weight:600}
.mopt:hover{border-color:var(--gold)}
.mopt.on{border-color:var(--burg);background:linear-gradient(135deg,rgba(107,30,60,.05),transparent);color:var(--deep)}
/* Boutons */
.btn{padding:.95rem 2.5rem;border:none;border-radius:2px;font-family:'Playfair Display',serif;
  font-size:.95rem;font-weight:600;letter-spacing:.04em;cursor:pointer;transition:all .3s;text-transform:uppercase}
.btn-p{background:linear-gradient(135deg,var(--burg),var(--deep));color:white;box-shadow:0 4px 16px rgba(107,30,60,.3)}
.btn-p:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(107,30,60,.4)}
.btn-s{background:linear-gradient(135deg,var(--sage),#6b8a5e);color:white;box-shadow:0 4px 16px rgba(139,154,126,.3)}
.btn-s:hover{transform:translateY(-2px)}
.btn-o{background:none;border:2px solid var(--burg);color:var(--burg);padding:.75rem 2rem}
.btn-o:hover{background:var(--burg);color:white}
.acts{display:flex;gap:1.2rem;justify-content:center;margin:1.8rem 0;flex-wrap:wrap}
/* Alert */
.al{padding:1rem 1.5rem;border-radius:2px;margin:.8rem 0;border-left:4px solid;animation:fadeIn .4s}
.al-ok{background:rgba(139,154,126,.1);border-color:var(--sage);color:#2d5016}
.al-err{background:rgba(198,123,92,.1);border-color:var(--terra);color:#7d3d24}
/* Valid√©e */
.val-ok{background:linear-gradient(135deg,var(--sage),#5a7a4e);color:white;border-radius:2px;padding:1.6rem;text-align:center;margin:1rem 0}
.val-ok h3{font-family:'Playfair Display',serif;font-size:1.4rem;margin-bottom:.5rem}
/* Historique */
.hcard{border:1px solid rgba(107,30,60,.12);border-radius:3px;margin-bottom:1.1rem;overflow:hidden}
.hhead{display:flex;justify-content:space-between;align-items:center;
  padding:.9rem 1.4rem;background:linear-gradient(135deg,rgba(107,30,60,.04),rgba(201,169,97,.04))}
.hannee{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;color:var(--burg)}
.hmeta{font-size:.82rem;color:#888;margin-top:.15rem}
.hbody{padding:.9rem 1.4rem}
.hrow{display:flex;justify-content:space-between;padding:.45rem 0;
  border-bottom:1px solid rgba(107,30,60,.06);font-size:.92rem}
.hrow:last-child{border-bottom:none;font-weight:700;color:var(--deep);font-family:'Playfair Display',serif;padding-top:.7rem;border-top:1px solid rgba(201,169,97,.4)}
/* Badges */
.badge{display:inline-block;padding:.22rem .7rem;border-radius:2px;font-size:.72rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase}
.b-ok{background:linear-gradient(135deg,var(--sage),#6b8a5e);color:white}
.b-draft{background:rgba(201,169,97,.25);color:#7a5a10}
.b-open{background:rgba(107,30,60,.1);color:var(--burg)}
/* Loading/Error */
.sc{text-align:center;padding:5rem 2rem}
.spin{width:44px;height:44px;border:4px solid rgba(107,30,60,.15);border-top-color:var(--burg);
  border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1.5rem}
.sc h2{font-family:'Playfair Display',serif;font-size:1.7rem;color:var(--burg);margin-bottom:.8rem}
.sc p{color:#777;line-height:1.6;font-size:1rem;max-width:420px;margin:0 auto}
.empty{color:#aaa;font-style:italic;text-align:center;padding:1.5rem 0;font-size:.95rem}
/* Section header */
.shdr{display:flex;justify-content:space-between;align-items:center;
  margin-bottom:1.2rem;padding-bottom:.7rem;border-bottom:1px solid rgba(107,30,60,.1)}
.stitle{font-family:'Playfair Display',serif;font-size:1.45rem;font-weight:700;color:var(--burg)}
/* No campagne */
.no-camp{text-align:center;padding:3.5rem 2rem}
.no-camp .ic{font-size:3rem;margin-bottom:1rem}
.no-camp h3{font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--burg);margin-bottom:.7rem}
.no-camp p{color:#888;font-size:.95rem;line-height:1.6}
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes rotate{from{transform:rotate(0)}to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.04)}}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:640px){.wgrid{grid-template-columns:1fr}.modes{flex-direction:column}.acts{flex-direction:column;align-items:stretch}.acts .btn{text-align:center}}
</style>
</head>
<body>
<div class="grain"></div>

<header class="hdr">
  <div class="logo"><em>GFA</em> Manager</div>
  <div class="deco"></div>
  <div class="tagline">Votre espace personnel</div>
  <div class="hdr-name" id="hdr-name"></div>
</header>

<nav class="tabs" id="tabs-nav" style="display:none">
  <div class="tabs-inner">
    <button class="tab active" data-tab="campagne">üç∑ Campagnes</button>
    <button class="tab" data-tab="infos">üë§ Mes informations</button>
    <button class="tab" data-tab="historique">üìã Historique</button>
  </div>
</nav>

<main class="main" id="main">
  <div class="sc"><div class="spin"></div><p>Chargement de votre espace‚Ä¶</p></div>
</main>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê √âTAT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ASSOC=null, GROUPT=null, CAMPAGNES=[], CAMP=null, VINS=[], COMMANDES=[], CMD=null;
let PANIER={}, MODE='bernard', TAB='campagne';
let CAMPAGNE_COMMANDE=null; // Campagne actuellement en cours de commande

// Fonction pour charger une campagne et passer en mode commande
async function chargerCampagne(campagneId) {
  const campagne = CAMPAGNES.find(c=>c.id===campagneId);
  if(!campagne) return;
  
  CAMPAGNE_COMMANDE = campagne;
  CAMP = campagne;
  
  // Charger les vins
  VINS = await window.ASSOC_API.getVinsCampagne(campagne.id, GROUPT.id);
  
  // Charger la commande existante si elle existe
  CMD = COMMANDES.find(c=>c.campagne_id===campagne.id && c.groupement_id===GROUPT.id) || null;
  if(CMD) {
    PANIER = CMD.panier || {};
    MODE = CMD.mode_recup || 'bernard';
  } else {
    PANIER = {};
    MODE = 'bernard';
  }
  
  TAB = 'commander';
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('api:ready', async ()=>{
  const TOKEN = new URLSearchParams(location.search).get('token');
  if (!TOKEN) return err('Lien invalide','Ce lien ne contient pas d\'identifiant. V√©rifiez que vous avez le bon lien.');
  try {
    console.log('üîç Recherche de l\'associ√© avec le token:', TOKEN);
    const r = await window.ASSOC_API.findAssocieByToken(TOKEN);
    console.log('‚úÖ Associ√© trouv√©:', r);
    
    if (!r) return err('Non reconnu','Ce lien n\'est pas reconnu. Contactez votre administrateur.');
    ASSOC=r.associe; GROUPT=r.groupement;
    if (!ASSOC.actif) return err('Acc√®s d√©sactiv√©','Votre acc√®s a √©t√© d√©sactiv√©. Contactez votre administrateur.');
    document.getElementById('hdr-name').textContent = ASSOC.prenom+' '+ASSOC.nom;

    console.log('üç∑ Chargement des campagnes pour le vigneron:', GROUPT.vigneron);
    // Charger TOUTES les campagnes du vigneron + toutes les commandes de l'associ√©
    [CAMPAGNES, COMMANDES] = await Promise.all([
      window.ASSOC_API.getCampagnesVigneron(GROUPT.vigneron),
      window.ASSOC_API.getCommandes(ASSOC.id)
    ]);
    console.log('‚úÖ Campagnes charg√©es:', CAMPAGNES.length);
    console.log('‚úÖ Commandes charg√©es:', COMMANDES.length);
    
    // Trouver la campagne active
    CAMP = CAMPAGNES.find(c=>c.actif) || null;
    console.log('üìå Campagne active:', CAMP);
    
    if (CAMP) {
      // Charger les vins filtr√©s par groupement
      console.log('üçá Chargement des vins pour campagne', CAMP.id, 'et groupement', GROUPT.id);
      VINS = await window.ASSOC_API.getVinsCampagne(CAMP.id, GROUPT.id);
      console.log('‚úÖ Vins charg√©s:', VINS.length);
      // Chercher la commande de cette campagne
      CMD  = COMMANDES.find(c=>c.campagne_id===CAMP.id && c.groupement_id===GROUPT.id)||null;
      if (CMD) { PANIER=CMD.panier||{}; MODE=CMD.mode_recup||'bernard'; }
    }
    
    document.getElementById('tabs-nav').style.display='block';
    document.querySelectorAll('.tab').forEach(b=>{
      b.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        b.classList.add('active'); TAB=b.dataset.tab; render();
      });
    });
    console.log('‚úÖ Rendu de l\'interface');
    render();
  } catch(e){ 
    console.error('‚ùå ERREUR:', e); 
    console.error('Stack:', e.stack);
    err('Erreur',`Impossible de charger vos donn√©es. D√©tails : ${e.message}`); 
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  const m=document.getElementById('main');
  if(TAB==='campagne') m.innerHTML=rCampagne();
  else if(TAB==='commander') m.innerHTML=rCommander();
  else if(TAB==='infos') m.innerHTML=rInfos();
  else m.innerHTML=rHisto();
  bind();
}

// ‚îÄ‚îÄ‚îÄ ONGLET CAMPAGNE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rCampagne(){
  if(!CAMPAGNES || !CAMPAGNES.length) return `<div class="card"><div class="no-camp">
    <div class="ic">üçá</div>
    <h3>Aucune campagne</h3>
    <p>Votre administrateur n'a pas encore cr√©√© de campagne.<br>Revenez bient√¥t !</p>
  </div></div>`;

  let h = '';
  
  // Afficher chaque campagne
  CAMPAGNES.forEach(async campagne => {
    const cmd = COMMANDES.find(c=>c.campagne_id===campagne.id && c.groupement_id===GROUPT.id);
    const estActive = campagne.actif;
    
    h += `<div class="card" style="margin-bottom:1.5rem;${!estActive?'opacity:0.8;':''}}">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
        <div class="ctitle" style="margin-bottom:0">Campagne ${campagne.annee}</div>
        <div style="display:flex;align-items:center;gap:.5rem">
          ${campagne.date_fin?`<span style="font-size:.85rem;color:#888">Cl√¥ture : ${campagne.date_fin}</span>`:''}
          <span class="badge ${estActive?'b-open':'badge-warning'}">${estActive?'Ouverte':'Cl√¥tur√©e'}</span>
        </div>
      </div>`;
    
    // Si commande valid√©e pour cette campagne
    if(cmd?.validee) {
      const lignes=Object.entries(cmd.panier||{}).filter(([,q])=>q>0);
      const tot=lignes.reduce((s,[id,q])=>s+(cmd.prix_snapshot?.[id]||0)*q,0);
      h += `<div class="val-ok" style="margin:0">
        <h3 style="font-size:1.1rem;margin-bottom:.5rem">‚úì Commande valid√©e</h3>
        <p style="font-size:.9rem;margin-bottom:.8rem">Votre commande a bien √©t√© enregistr√©e.</p>
        <div style="background:white;padding:1rem;border-radius:3px">`;
      lignes.forEach(([id,q])=>{
        const nom=cmd.noms_snapshot?.[id]||'Vin';
        const px=cmd.prix_snapshot?.[id]||0;
        h+=`<div style="display:flex;justify-content:space-between;padding:.3rem 0;border-bottom:1px solid #eee">
          <span>${e(nom)} √ó ${q}</span><span style="font-weight:600">${f(px*q)} ‚Ç¨</span></div>`;
      });
      h+=`<div style="display:flex;justify-content:space-between;padding:.5rem 0;margin-top:.5rem;font-weight:700;color:var(--burg)">
        <span>Total</span><span>${f(tot)} ‚Ç¨</span></div>
        <div style="margin-top:.5rem;font-size:.85rem;color:#888">Mode : ${e(cmd.mode_recup||'‚Äî')}</div>
      </div></div>`;
      
    } else if(estActive) {
      // Campagne active sans commande valid√©e - permettre la commande
      h += `<p style="color:#888;font-size:.95rem;margin-bottom:1rem">Cette campagne est ouverte. Cliquez ci-dessous pour passer votre commande.</p>
        <button class="btn btn-p" onclick="chargerCampagne('${campagne.id}')">üç∑ Commander</button>`;
      
    } else {
      // Campagne cl√¥tur√©e sans commande
      h += `<p style="color:#aaa;font-style:italic">Cette campagne est cl√¥tur√©e. ${cmd?'Vous aviez un brouillon non valid√©.':'Vous n\'avez pas pass√© de commande.'}</p>`;
    }
    
    h += `</div>`;
  });
  
  return h;
}

// ‚îÄ‚îÄ‚îÄ VUE COMMANDER (pour une campagne sp√©cifique) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rCommander(){
  if(!CAMPAGNE_COMMANDE || !CAMP) {
    TAB='campagne';
    return rCampagne();
  }

  if(CMD?.validee) return rValidee();

  const tot=calcTot(), util=calcUtil(), rest=tot-util, supp=calcSupplement();
  const pct=tot>0?Math.min(100,(util/tot)*100):0;
  const lignes=Object.entries(PANIER).filter(([,q])=>q>0);
  const depasse=supp>0;

  let h=`<div style="margin-bottom:1rem">
    <button class="btn btn-secondary btn-sm" onclick="TAB='campagne';CAMPAGNE_COMMANDE=null;render()">‚Üê Retour aux campagnes</button>
  </div>
  <div class="creds">
    <div class="cred-amt">${f(tot)} ‚Ç¨</div>
    <div class="cred-lbl">Cr√©dits disponibles</div>
    <div class="cred-det">Utilis√©s&nbsp;<strong>${f(util)} ‚Ç¨</strong>&nbsp;¬∑&nbsp;${depasse?`<span style="color:#c0392b;font-weight:700">Suppl√©ment √† payer&nbsp;<strong>${f(supp)} ‚Ç¨</strong></span>`:`Restants&nbsp;<strong>${f(rest)} ‚Ç¨</strong>`}</div>
    <div class="cbar-w"><div class="cbar" style="width:${pct}%;${depasse?'background:linear-gradient(135deg,#c0392b,#e74c3c)':''}"></div></div>
  </div>
  <div id="az"></div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.3rem">
      <div class="ctitle" style="margin-bottom:0">Catalogue ${CAMP.annee||''}</div>
      <span class="badge b-open">Campagne ouverte</span>
    </div>`;

  if(!VINS.length){
    h+=`<p class="empty">Aucun vin au catalogue pour cette campagne.</p>`;
  } else {
    h+=`<div class="wgrid">`;
    VINS.forEach(v=>{
      const q=PANIER[v.id]||0, mx=!!(v.stock&&q>=v.stock);
      h+=`<div class="wcard${q>0?' sel':''}${mx?' maxed':''}">
        <div class="wname">${e(v.nom)}</div>
        <div class="wdesc">${e(v.description||'')}</div>
        <div class="wprice">${f(v.prix)}<em>‚Ç¨</em></div>
        ${v.stock?`<div class="wstock">Stock limit√© : ${v.stock} bouteilles</div>`:''}
        <div class="qty">
          <button class="qb" data-id="${v.id}" data-d="-1"${q===0?' disabled':''}>‚àí</button>
          <div class="qn">${q}</div>
          <button class="qb" data-id="${v.id}" data-d="1"${mx?' disabled':''}>+</button>
        </div>
      </div>`;
    });
    h+=`</div>`;
  }
  h+=`</div>`;

  if(lignes.length){
    h+=`<div class="recap"><div class="rtitle">R√©capitulatif</div>`;
    lignes.forEach(([id,q])=>{ const v=VINS.find(x=>x.id===id); if(v) h+=`<div class="rrow"><span>${e(v.nom)} √ó ${q}</span><span>${f(v.prix*q)} ‚Ç¨</span></div>`; });
    h+=`<div class="rrow" style="border-top:1px solid rgba(107,30,60,.1);margin-top:.3rem;padding-top:.3rem">
      <span>Cr√©dits utilis√©s</span><span>${f(Math.min(util,tot))} ‚Ç¨</span>
    </div>`;
    if(depasse){
      h+=`<div class="rrow" style="color:#c0392b;font-weight:700">
        <span>üí≥ Suppl√©ment √† payer au vigneron</span><span>+ ${f(supp)} ‚Ç¨</span>
      </div>`;
    }
    h+=`<div class="rrow" style="border-top:2px solid var(--burg);padding-top:.5rem;font-size:1.1rem">
      <span>Total commande</span><span>${f(util)} ‚Ç¨</span>
    </div></div>`;
  }

  h+=`<div class="card">
    <div class="ctitle" style="margin-bottom:.7rem">Mode de r√©cup√©ration</div>
    <div class="modes">
      <div class="mopt${MODE==='bernard'?' on':''}" data-m="bernard">üè† Bernard</div>
      <div class="mopt${MODE==='vigneron'?' on':''}" data-m="vigneron">üç∑ Vigneron</div>
    </div>
  </div>
  <div class="acts">
    <button class="btn btn-p" id="b-draft">üíæ Sauvegarder en brouillon</button>
    <button class="btn btn-s" id="b-valid">‚úì Valider ma commande</button>
  </div>`;
  return h;
}

function rValidee(){
  const lignes=Object.entries(PANIER).filter(([,q])=>q>0);
  const tot=calcTot(), util=calcUtil(), supp=calcSupplement();
  const depasse=supp>0;
  let h=`<div class="val-ok"><h3>‚úì Commande valid√©e</h3>
    <p>Votre commande pour la campagne ${CAMP.annee} a bien √©t√© enregistr√©e.</p>
  </div>`;
  if(lignes.length){
    h+=`<div class="recap"><div class="rtitle">Votre commande ${CAMP.annee}</div>`;
    lignes.forEach(([id,q])=>{ const v=VINS.find(x=>x.id===id); if(v) h+=`<div class="rrow"><span>${e(v.nom)} √ó ${q}</span><span>${f(v.prix*q)} ‚Ç¨</span></div>`; });
    h+=`<div class="rrow" style="border-top:1px solid rgba(107,30,60,.1);margin-top:.3rem;padding-top:.3rem">
      <span>Cr√©dits utilis√©s</span><span>${f(Math.min(util,tot))} ‚Ç¨</span>
    </div>`;
    if(depasse){
      h+=`<div class="rrow" style="color:#c0392b;font-weight:700">
        <span>üí≥ Suppl√©ment √† payer au vigneron</span><span>+ ${f(supp)} ‚Ç¨</span>
      </div>`;
    }
    h+=`<div class="rrow" style="border-top:2px solid var(--burg);padding-top:.5rem;font-size:1.1rem">
      <span>Total</span><span>${f(util)} ‚Ç¨</span>
    </div></div>`;
  }
  h+=`<div class="acts"><button class="btn btn-o" id="b-modif">Modifier ma commande</button></div>`;
  return h;
}

// ‚îÄ‚îÄ‚îÄ ONGLET INFORMATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rInfos(){
  const tot=calcTot();
  return `<div class="card">
    <div class="shdr"><div class="stitle">Mes informations personnelles</div></div>
    <div class="igrid">
      <div class="iitem"><div class="lbl">Nom complet</div><div class="val">${e(ASSOC.prenom)} ${e(ASSOC.nom)}</div></div>
      <div class="iitem"><div class="lbl">Email</div><div class="val" style="font-size:1rem">${e(ASSOC.email||'‚Äî')}</div></div>
      <div class="iitem"><div class="lbl">T√©l√©phone</div><div class="val" style="font-size:1rem">${e(ASSOC.tel||'‚Äî')}</div></div>
      <div class="iitem"><div class="lbl">Adresse de livraison</div><div class="val" style="font-size:1rem">${e(ASSOC.adresse||'‚Äî')}</div></div>
      <div class="iitem"><div class="lbl">Nombre de parts</div><div class="val">${ASSOC.parts||0}</div></div>
      <div class="iitem"><div class="lbl">Cr√©dits disponibles</div><div class="val" style="color:var(--burg);font-weight:700">${f(tot)} ‚Ç¨</div></div>
      <div class="iitem"><div class="lbl">Mode de retrait</div><div class="val" style="text-transform:capitalize">${e(ASSOC.etat||'‚Äî')}</div></div>
    </div>
  </div>
  <div class="card">
    <div class="shdr"><div class="stitle">Mon groupement</div></div>
    <div class="igrid">
      <div class="iitem"><div class="lbl">Groupement</div><div class="val">${e(GROUPT.nom)}</div></div>
      <div class="iitem"><div class="lbl">Vigneron</div><div class="val">${e(GROUPT.vigneron||'‚Äî')}</div></div>
      <div class="iitem"><div class="lbl">Appellation</div><div class="val">${e(GROUPT.appellation||'‚Äî')}</div></div>
      <div class="iitem"><div class="lbl">Parts totales</div>
        <div class="val">${GROUPT.nombre_total_parts||0} <span style="font-size:.85rem;color:#999;font-weight:400">(${GROUPT.parts_pour_bouteille||1}/bouteille)</span></div></div>
      <div class="iitem"><div class="lbl">Prix r√©f√©rence bouteille</div><div class="val">${GROUPT.prix_bouteille_reference||'‚Äî'} ‚Ç¨</div></div>
      <div class="iitem"><div class="lbl">Date cr√©ation</div><div class="val">${e(GROUPT.date_creation||'‚Äî')}</div></div>
      <div class="iitem"><div class="lbl">Campagnes</div><div class="val">${CAMPAGNES.length} <span style="font-size:.85rem;color:#999;font-weight:400">(${CAMPAGNES.filter(c=>c.actif).length} active${CAMPAGNES.filter(c=>c.actif).length>1?'s':''})</span></div></div>
    </div>
    ${GROUPT.commentaire?`<div style="margin-top:1.5rem;padding:1rem;background:rgba(248,245,239,.6);border-left:3px solid var(--gold);border-radius:2px">
      <div style="font-weight:600;color:var(--burg);margin-bottom:.5rem">üìù Note du groupement</div>
      <div style="font-size:.95rem;color:#555;line-height:1.6;white-space:pre-wrap">${e(GROUPT.commentaire)}</div>
    </div>`:''}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ ONGLET HISTORIQUE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rHisto(){
  const passees = COMMANDES.filter(c=>!CAMP||c.campagne_id!==CAMP.id||c.validee);
  let h=`<div class="card"><div class="shdr"><div class="stitle">Historique des commandes</div></div>`;
  if(!passees.length){ h+=`<p class="empty">Aucune commande valid√©e pour le moment.</p></div>`; return h; }

  passees.forEach(cmd=>{
    const lignes=Object.entries(cmd.panier||{}).filter(([,q])=>q>0);
    const tot=lignes.reduce((s,[id,q])=>s+(cmd.prix_snapshot?.[id]||0)*q,0);
    const badge=cmd.validee?`<span class="badge b-ok">Valid√©e</span>`:`<span class="badge b-draft">Brouillon</span>`;
    const date=cmd.date_maj?new Date(cmd.date_maj).toLocaleDateString('fr-FR'):'';

    h+=`<div class="hcard">
      <div class="hhead">
        <div>
          <div class="hannee">Campagne ${cmd.annee||'‚Äî'}</div>
          <div class="hmeta">Mode&nbsp;: ${e(cmd.mode_recup||'‚Äî')}${date?'&nbsp;¬∑&nbsp;Mis √† jour le '+date:''}</div>
        </div>${badge}
      </div>`;

    if(lignes.length){
      h+=`<div class="hbody">`;
      lignes.forEach(([id,q])=>{
        const nom=cmd.noms_snapshot?.[id]||`Vin #${id}`;
        const px=cmd.prix_snapshot?.[id]||0;
        h+=`<div class="hrow"><span>${e(nom)} √ó ${q}</span><span>${px?f(px*q)+' ‚Ç¨':'‚Äî'}</span></div>`;
      });
      if(tot>0) h+=`<div class="hrow"><span>Total</span><span>${f(tot)} ‚Ç¨</span></div>`;
      h+=`</div>`;
    } else {
      h+=`<div class="hbody"><p class="empty" style="padding:.5rem 0">Aucun vin s√©lectionn√©</p></div>`;
    }
    h+=`</div>`;
  });
  h+=`</div>`;
  return h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BIND EVENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function bind(){
  document.querySelectorAll('.qb').forEach(b=>b.addEventListener('click',()=>{
    if(b.disabled)return; chgQty(b.dataset.id,parseInt(b.dataset.d));
  }));
  document.querySelectorAll('.mopt').forEach(o=>o.addEventListener('click',()=>{
    MODE=o.dataset.m;
    document.querySelectorAll('.mopt').forEach(x=>x.classList.remove('on'));
    o.classList.add('on');
  }));
  const bd=document.getElementById('b-draft');
  const bv=document.getElementById('b-valid');
  const bm=document.getElementById('b-modif');
  if(bd) bd.addEventListener('click',()=>sauv(false));
  if(bv) bv.addEventListener('click',()=>sauv(true));
  if(bm) bm.addEventListener('click',async()=>{
    const ns={},ps={};
    VINS.forEach(v=>{ns[v.id]=v.nom;ps[v.id]=v.prix;});
    await window.ASSOC_API.saveCommande(CAMP.id,ASSOC.id,GROUPT.id,CAMP.annee,PANIER,MODE,false,ns,ps);
    if(CMD) CMD.validee=false; render();
  });
}

function chgQty(id,d){
  const v=VINS.find(x=>x.id===id); if(!v)return;
  const cur=PANIER[id]||0, nw=Math.max(0,cur+d);
  if(d>0&&calcUtil()+v.prix>calcTot()+.001){al('Cr√©dits insuffisants pour ajouter cette bouteille.',false);return;}
  if(d>0&&v.stock&&nw>v.stock){al('Stock limit√© atteint.',false);return;}
  if(nw===0)delete PANIER[id]; else PANIER[id]=nw;
  render();
}

async function sauv(valider){
  if(valider&&!Object.keys(PANIER).length){al('S√©lectionnez au moins une bouteille avant de valider.',false);return;}
  const ns={},ps={};
  VINS.forEach(v=>{ns[v.id]=v.nom;ps[v.id]=v.prix;});
  try {
    const id=await window.ASSOC_API.saveCommande(CAMP.id,ASSOC.id,GROUPT.id,CAMP.annee,PANIER,MODE,valider,ns,ps);
    CMD={id,campagne_id:CAMP.id,groupement_id:GROUPT.id,panier:PANIER,mode_recup:MODE,validee:valider,
         annee:CAMP.annee,noms_snapshot:ns,prix_snapshot:ps,date_maj:new Date().toISOString()};
    const i=COMMANDES.findIndex(c=>c.campagne_id===CAMP.id && c.groupement_id===GROUPT.id);
    if(i>=0) COMMANDES[i]=CMD; else COMMANDES.push(CMD);
    if(valider) render(); else al('Brouillon sauvegard√©.',true);
  } catch(x){console.error(x);al('Erreur lors de la sauvegarde. R√©essayez.',false);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcTot(){
  const ppb=GROUPT.parts_pour_bouteille||1;
  const prix=GROUPT.prix_bouteille_reference||0;
  return (ASSOC.parts/ppb)*prix;
}
function calcUtil(){
  return Object.entries(PANIER).reduce((s,[id,q])=>{
    const v=VINS.find(x=>x.id===id); return s+(v?v.prix*q:0);
  },0);
}
function calcSupplement(){
  const tot=calcTot(), util=calcUtil();
  return Math.max(0, util-tot);
}
function err(t,m){ document.getElementById('main').innerHTML=`<div class="sc"><h2>${t}</h2><p>${m}</p></div>`; }
function al(m,ok){ const z=document.getElementById('az'); if(z){z.innerHTML=`<div class="al ${ok?'al-ok':'al-err'}">${m}</div>`;setTimeout(()=>{if(z)z.innerHTML=''},4000);} }
function f(n){ return Number(n||0).toFixed(2); }
function e(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>
