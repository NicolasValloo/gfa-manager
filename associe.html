<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GFA Manager â€” Mon Espace</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Cormorant+Garamond:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, addDoc, updateDoc }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘  âœ…  CONFIGURATION FIREBASE â€” Projet : gfa-manager-50a7f    â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey:            "AIzaSyB6MW35DPPsh59DoOEPVXml6FIvDNFgdI0",
  authDomain:        "gfa-manager-50a7f.firebaseapp.com",
  projectId:         "gfa-manager-50a7f",
  storageBucket:     "gfa-manager-50a7f.firebasestorage.app",
  messagingSenderId: "224596157977",
  appId:             "1:224596157977:web:c8d09907b8185010076c88"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const TOKEN = new URLSearchParams(location.search).get('token');

async function findAssocieByToken(token) {
  const gSnap = await getDocs(collection(db, "groupements"));
  for (const gDoc of gSnap.docs) {
    const aSnap = await getDocs(
      query(collection(db,"groupements",gDoc.id,"associes"), where("token","==",token))
    );
    if (!aSnap.empty) {
      const aDoc = aSnap.docs[0];
      return { groupement:{id:gDoc.id,...gDoc.data()}, associe:{id:aDoc.id,...aDoc.data()} };
    }
  }
  return null;
}

async function getCampagnes(gId) {
  const snap = await getDocs(collection(db,"groupements",gId,"campagnes"));
  return snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.annee||0)-(a.annee||0));
}

async function getVinsCampagne(gId, cId) {
  const snap = await getDocs(collection(db,"groupements",gId,"campagnes",cId,"vins"));
  return snap.docs.map(d=>({id:d.id,...d.data()}));
}

async function getCommandes(gId, aId) {
  const snap = await getDocs(
    query(collection(db,"groupements",gId,"commandes"), where("associe_id","==",aId))
  );
  return snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.annee||0)-(a.annee||0));
}

async function saveCommande(gId, aId, cId, annee, panier, modeRecup, valider, nomsSn, prixSn) {
  const existing = (await getDocs(
    query(collection(db,"groupements",gId,"commandes"),
          where("associe_id","==",aId), where("campagne_id","==",cId))
  )).docs[0];
  const data = {
    associe_id:aId, campagne_id:cId, annee, panier, mode_recup:modeRecup,
    validee:valider, date_maj:new Date().toISOString(),
    noms_snapshot:nomsSn||{}, prix_snapshot:prixSn||{}
  };
  if (existing) { await updateDoc(doc(db,"groupements",gId,"commandes",existing.id),data); return existing.id; }
  else { const r=await addDoc(collection(db,"groupements",gId,"commandes"),data); return r.id; }
}

window.ASSOC_API = { findAssocieByToken, getCampagnes, getVinsCampagne, getCommandes, saveCommande };
window.dispatchEvent(new Event('api:ready'));
</script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--burg:#6B1E3C;--deep:#4A1228;--gold:#C9A961;--cream:#F8F5EF;--dark:#2C1810;--sage:#8B9A7E;--terra:#C67B5C}
body{font-family:'Cormorant Garamond',serif;background:var(--cream);color:var(--dark);overflow-x:hidden}
.grain{position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:.03;
  background:url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='2.5' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}
/* Header */
.hdr{background:linear-gradient(135deg,var(--burg),var(--deep));color:var(--cream);
  padding:2.8rem 2rem 2rem;text-align:center;position:relative;overflow:hidden}
.hdr::before{content:'';position:absolute;inset:0;
  background:repeating-linear-gradient(45deg,transparent,transparent 35px,rgba(255,255,255,.03) 35px,rgba(255,255,255,.03) 70px);pointer-events:none}
.logo{font-family:'Playfair Display',serif;font-size:2.6rem;font-weight:900;position:relative;z-index:2}
.logo em{color:var(--gold);font-style:italic}
.deco{width:80px;height:2px;background:var(--gold);margin:.7rem auto;position:relative;z-index:2}
.tagline{font-size:.95rem;opacity:.8;position:relative;z-index:2}
.hdr-name{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:600;
  color:var(--gold);margin-top:.4rem;position:relative;z-index:2}
/* Tabs */
.tabs{background:white;box-shadow:0 4px 20px rgba(107,30,60,.1);position:sticky;top:0;z-index:100}
.tabs-inner{max-width:960px;margin:0 auto;display:flex}
.tab{flex:1;padding:1.2rem 1rem;border:none;background:transparent;font-family:'Playfair Display',serif;
  font-size:.95rem;font-weight:600;color:var(--burg);cursor:pointer;transition:all .3s;position:relative}
.tab::after{content:'';position:absolute;bottom:-1px;left:50%;width:0;height:3px;
  background:var(--gold);transform:translateX(-50%);transition:width .3s}
.tab.active::after,.tab:hover::after{width:100%}
.tab.active{color:var(--deep);background:linear-gradient(to bottom,rgba(201,169,97,.1),transparent)}
/* Main */
.main{max-width:960px;margin:0 auto;padding:2.5rem 2rem;animation:fadeIn .5s}
/* Card */
.card{background:white;border-radius:2px;padding:2.2rem;margin-bottom:1.8rem;
  box-shadow:0 2px 4px rgba(107,30,60,.08),0 8px 16px rgba(107,30,60,.06),inset 0 0 0 1px rgba(107,30,60,.1);
  position:relative;overflow:hidden}
.card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent,rgba(201,169,97,.03));pointer-events:none}
.ctitle{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:700;color:var(--burg);margin-bottom:1.3rem}
/* Info grid */
.igrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:1.1rem}
.iitem{padding:1.1rem 1.3rem;background:linear-gradient(135deg,rgba(107,30,60,.03),rgba(201,169,97,.03));border-left:3px solid var(--burg);border-radius:2px}
.lbl{font-size:.78rem;text-transform:uppercase;letter-spacing:.1em;color:var(--burg);font-weight:600;margin-bottom:.3rem}
.val{font-family:'Playfair Display',serif;font-size:1.15rem;color:var(--dark);font-weight:600}
/* CrÃ©dits */
.creds{background:linear-gradient(135deg,var(--burg),var(--deep));color:white;
  padding:2.2rem 2rem;border-radius:2px;text-align:center;margin-bottom:1.8rem;
  position:relative;overflow:hidden;box-shadow:0 8px 32px rgba(107,30,60,.3)}
.creds::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;
  background:radial-gradient(circle,rgba(201,169,97,.2) 0%,transparent 70%);animation:rotate 20s linear infinite}
.cred-amt{font-family:'Playfair Display',serif;font-size:3.2rem;font-weight:900;color:var(--gold);position:relative;z-index:2;animation:pulse 2.5s ease-in-out infinite}
.cred-lbl{font-size:.95rem;font-weight:300;letter-spacing:.12em;text-transform:uppercase;opacity:.9;position:relative;z-index:2;margin-top:.3rem}
.cred-det{font-size:.9rem;opacity:.8;position:relative;z-index:2;margin-top:.5rem}
.cbar-w{max-width:320px;margin:.7rem auto 0;background:rgba(255,255,255,.2);border-radius:4px;height:6px;position:relative;z-index:2}
.cbar{height:6px;background:var(--gold);border-radius:4px;transition:width .5s}
/* Vins */
.wgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1.4rem;margin:1.4rem 0}
.wcard{background:white;border:2px solid transparent;border-radius:2px;padding:1.6rem;
  transition:all .3s;cursor:pointer;box-shadow:0 2px 8px rgba(107,30,60,.07);position:relative}
.wcard::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;
  background:linear-gradient(to bottom,var(--burg),var(--gold));opacity:0;transition:opacity .3s}
.wcard:hover{border-color:var(--gold);transform:translateY(-2px)}
.wcard:hover::before,.wcard.sel::before{opacity:1}
.wcard.sel{border-color:var(--burg);background:linear-gradient(to bottom,rgba(107,30,60,.03),white)}
.wcard.maxed{opacity:.5;cursor:not-allowed}
.wname{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;color:var(--deep);margin-bottom:.4rem}
.wdesc{font-size:.88rem;color:#666;margin-bottom:.9rem;line-height:1.5}
.wprice{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:700;color:var(--burg)}
.wprice em{font-size:.85rem;color:var(--gold);font-style:normal;margin-left:.2rem}
.wstock{font-size:.8rem;color:var(--terra);margin-top:.3rem}
.qty{display:flex;align-items:center;justify-content:center;gap:1rem;margin-top:1.1rem}
.qb{width:36px;height:36px;border:2px solid var(--burg);border-radius:50%;background:white;
  color:var(--burg);font-size:1.1rem;cursor:pointer;transition:all .25s;display:flex;align-items:center;justify-content:center}
.qb:hover:not(:disabled){background:var(--burg);color:white;transform:scale(1.1)}
.qb:disabled{opacity:.3;cursor:not-allowed;transform:none}
.qn{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;color:var(--deep);min-width:40px;text-align:center}
/* RÃ©cap */
.recap{background:linear-gradient(to bottom,rgba(248,245,239,.6),white);border:2px solid var(--gold);border-radius:2px;padding:1.8rem;margin:1.5rem 0}
.rtitle{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;color:var(--burg);margin-bottom:1.3rem;text-align:center;text-transform:uppercase;letter-spacing:.05em}
.rrow{display:flex;justify-content:space-between;align-items:center;padding:.75rem 0;border-bottom:1px solid rgba(107,30,60,.09);font-size:.95rem}
.rrow:last-child{border-bottom:none;padding-top:1.2rem;border-top:2px solid var(--gold);font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:700;color:var(--deep)}
/* Mode rÃ©cup */
.modes{display:flex;gap:1rem;margin:.8rem 0 1.4rem}
.mopt{flex:1;padding:1rem;border:2px solid rgba(107,30,60,.2);border-radius:2px;
  text-align:center;cursor:pointer;transition:all .25s;font-family:'Playfair Display',serif;font-size:.95rem;font-weight:600}
.mopt:hover{border-color:var(--gold)}
.mopt.on{border-color:var(--burg);background:linear-gradient(135deg,rgba(107,30,60,.05),transparent);color:var(--deep)}
/* Boutons */
.btn{padding:.95rem 2.5rem;border:none;border-radius:2px;font-family:'Playfair Display',serif;
  font-size:.95rem;font-weight:600;letter-spacing:.04em;cursor:pointer;transition:all .3s;text-transform:uppercase}
.btn-p{background:linear-gradient(135deg,var(--burg),var(--deep));color:white;box-shadow:0 4px 16px rgba(107,30,60,.3)}
.btn-p:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(107,30,60,.4)}
.btn-s{background:linear-gradient(135deg,var(--sage),#6b8a5e);color:white;box-shadow:0 4px 16px rgba(139,154,126,.3)}
.btn-s:hover{transform:translateY(-2px)}
.btn-o{background:none;border:2px solid var(--burg);color:var(--burg);padding:.75rem 2rem}
.btn-o:hover{background:var(--burg);color:white}
.acts{display:flex;gap:1.2rem;justify-content:center;margin:1.8rem 0;flex-wrap:wrap}
/* Alert */
.al{padding:1rem 1.5rem;border-radius:2px;margin:.8rem 0;border-left:4px solid;animation:fadeIn .4s}
.al-ok{background:rgba(139,154,126,.1);border-color:var(--sage);color:#2d5016}
.al-err{background:rgba(198,123,92,.1);border-color:var(--terra);color:#7d3d24}
/* ValidÃ©e */
.val-ok{background:linear-gradient(135deg,var(--sage),#5a7a4e);color:white;border-radius:2px;padding:1.6rem;text-align:center;margin:1rem 0}
.val-ok h3{font-family:'Playfair Display',serif;font-size:1.4rem;margin-bottom:.5rem}
/* Historique */
.hcard{border:1px solid rgba(107,30,60,.12);border-radius:3px;margin-bottom:1.1rem;overflow:hidden}
.hhead{display:flex;justify-content:space-between;align-items:center;
  padding:.9rem 1.4rem;background:linear-gradient(135deg,rgba(107,30,60,.04),rgba(201,169,97,.04))}
.hannee{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;color:var(--burg)}
.hmeta{font-size:.82rem;color:#888;margin-top:.15rem}
.hbody{padding:.9rem 1.4rem}
.hrow{display:flex;justify-content:space-between;padding:.45rem 0;
  border-bottom:1px solid rgba(107,30,60,.06);font-size:.92rem}
.hrow:last-child{border-bottom:none;font-weight:700;color:var(--deep);font-family:'Playfair Display',serif;padding-top:.7rem;border-top:1px solid rgba(201,169,97,.4)}
/* Badges */
.badge{display:inline-block;padding:.22rem .7rem;border-radius:2px;font-size:.72rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase}
.b-ok{background:linear-gradient(135deg,var(--sage),#6b8a5e);color:white}
.b-draft{background:rgba(201,169,97,.25);color:#7a5a10}
.b-open{background:rgba(107,30,60,.1);color:var(--burg)}
/* Loading/Error */
.sc{text-align:center;padding:5rem 2rem}
.spin{width:44px;height:44px;border:4px solid rgba(107,30,60,.15);border-top-color:var(--burg);
  border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1.5rem}
.sc h2{font-family:'Playfair Display',serif;font-size:1.7rem;color:var(--burg);margin-bottom:.8rem}
.sc p{color:#777;line-height:1.6;font-size:1rem;max-width:420px;margin:0 auto}
.empty{color:#aaa;font-style:italic;text-align:center;padding:1.5rem 0;font-size:.95rem}
/* Section header */
.shdr{display:flex;justify-content:space-between;align-items:center;
  margin-bottom:1.2rem;padding-bottom:.7rem;border-bottom:1px solid rgba(107,30,60,.1)}
.stitle{font-family:'Playfair Display',serif;font-size:1.45rem;font-weight:700;color:var(--burg)}
/* No campagne */
.no-camp{text-align:center;padding:3.5rem 2rem}
.no-camp .ic{font-size:3rem;margin-bottom:1rem}
.no-camp h3{font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--burg);margin-bottom:.7rem}
.no-camp p{color:#888;font-size:.95rem;line-height:1.6}
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes rotate{from{transform:rotate(0)}to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.04)}}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:640px){.wgrid{grid-template-columns:1fr}.modes{flex-direction:column}.acts{flex-direction:column;align-items:stretch}.acts .btn{text-align:center}}
</style>
</head>
<body>
<div class="grain"></div>

<header class="hdr">
  <div class="logo"><em>GFA</em> Manager</div>
  <div class="deco"></div>
  <div class="tagline">Votre espace personnel</div>
  <div class="hdr-name" id="hdr-name"></div>
</header>

<nav class="tabs" id="tabs-nav" style="display:none">
  <div class="tabs-inner">
    <button class="tab active" data-tab="campagne">ğŸ· Campagne en cours</button>
    <button class="tab" data-tab="infos">ğŸ‘¤ Mes informations</button>
    <button class="tab" data-tab="historique">ğŸ“‹ Historique</button>
  </div>
</nav>

<main class="main" id="main">
  <div class="sc"><div class="spin"></div><p>Chargement de votre espaceâ€¦</p></div>
</main>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Ã‰TAT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ASSOC=null, GROUPT=null, CAMPAGNES=[], CAMP=null, VINS=[], COMMANDES=[], CMD=null;
let PANIER={}, MODE='bernard', TAB='campagne';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('api:ready', async ()=>{
  const TOKEN = new URLSearchParams(location.search).get('token');
  if (!TOKEN) return err('Lien invalide','Ce lien ne contient pas d\'identifiant. VÃ©rifiez que vous avez le bon lien.');
  try {
    const r = await window.ASSOC_API.findAssocieByToken(TOKEN);
    if (!r) return err('Non reconnu','Ce lien n\'est pas reconnu. Contactez votre administrateur.');
    ASSOC=r.associe; GROUPT=r.groupement;
    if (!ASSOC.actif) return err('AccÃ¨s dÃ©sactivÃ©','Votre accÃ¨s a Ã©tÃ© dÃ©sactivÃ©. Contactez votre administrateur.');
    document.getElementById('hdr-name').textContent = ASSOC.prenom+' '+ASSOC.nom;

    [CAMPAGNES, COMMANDES] = await Promise.all([
      window.ASSOC_API.getCampagnes(GROUPT.id),
      window.ASSOC_API.getCommandes(GROUPT.id, ASSOC.id)
    ]);
    CAMP = CAMPAGNES.find(c=>c.actif)||null;
    if (CAMP) {
      VINS = await window.ASSOC_API.getVinsCampagne(GROUPT.id, CAMP.id);
      CMD  = COMMANDES.find(c=>c.campagne_id===CAMP.id)||null;
      if (CMD) { PANIER=CMD.panier||{}; MODE=CMD.mode_recup||'bernard'; }
    }
    document.getElementById('tabs-nav').style.display='block';
    document.querySelectorAll('.tab').forEach(b=>{
      b.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        b.classList.add('active'); TAB=b.dataset.tab; render();
      });
    });
    render();
  } catch(e){ console.error(e); err('Erreur','Impossible de charger vos donnÃ©es. RÃ©essayez.'); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RENDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  const m=document.getElementById('main');
  if(TAB==='campagne') m.innerHTML=rCampagne();
  else if(TAB==='infos') m.innerHTML=rInfos();
  else m.innerHTML=rHisto();
  bind();
}

// â”€â”€â”€ ONGLET CAMPAGNE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rCampagne(){
  if(!CAMP) return `<div class="card"><div class="no-camp">
    <div class="ic">ğŸ‡</div>
    <h3>Aucune campagne en cours</h3>
    <p>Votre administrateur n'a pas encore ouvert de campagne pour cette annÃ©e.<br>Revenez bientÃ´t !</p>
  </div></div>`;

  if(CMD?.validee) return rValidee();

  const tot=calcTot(), util=calcUtil(), rest=tot-util;
  const pct=tot>0?Math.min(100,(util/tot)*100):0;
  const lignes=Object.entries(PANIER).filter(([,q])=>q>0);

  let h=`<div class="creds">
    <div class="cred-amt">${f(tot)} â‚¬</div>
    <div class="cred-lbl">CrÃ©dits disponibles</div>
    <div class="cred-det">UtilisÃ©s&nbsp;<strong>${f(util)} â‚¬</strong>&nbsp;Â·&nbsp;Restants&nbsp;<strong>${f(rest)} â‚¬</strong></div>
    <div class="cbar-w"><div class="cbar" style="width:${pct}%"></div></div>
  </div>
  <div id="az"></div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.3rem">
      <div class="ctitle" style="margin-bottom:0">Catalogue ${CAMP.annee||''}</div>
      <span class="badge b-open">Campagne ouverte</span>
    </div>`;

  if(!VINS.length){
    h+=`<p class="empty">Aucun vin au catalogue pour cette campagne.</p>`;
  } else {
    h+=`<div class="wgrid">`;
    VINS.forEach(v=>{
      const q=PANIER[v.id]||0, mx=!!(v.stock&&q>=v.stock);
      h+=`<div class="wcard${q>0?' sel':''}${mx?' maxed':''}">
        <div class="wname">${e(v.nom)}</div>
        <div class="wdesc">${e(v.description||'')}</div>
        <div class="wprice">${f(v.prix)}<em>â‚¬</em></div>
        ${v.stock?`<div class="wstock">Stock limitÃ© : ${v.stock} bouteilles</div>`:''}
        <div class="qty">
          <button class="qb" data-id="${v.id}" data-d="-1"${q===0?' disabled':''}>âˆ’</button>
          <div class="qn">${q}</div>
          <button class="qb" data-id="${v.id}" data-d="1"${mx?' disabled':''}>+</button>
        </div>
      </div>`;
    });
    h+=`</div>`;
  }
  h+=`</div>`;

  if(lignes.length){
    h+=`<div class="recap"><div class="rtitle">RÃ©capitulatif</div>`;
    lignes.forEach(([id,q])=>{ const v=VINS.find(x=>x.id===id); if(v) h+=`<div class="rrow"><span>${e(v.nom)} Ã— ${q}</span><span>${f(v.prix*q)} â‚¬</span></div>`; });
    h+=`<div class="rrow"><span>Total</span><span>${f(util)} â‚¬ <span style="font-size:.82rem;font-weight:400;color:#888">/ ${f(tot)} â‚¬</span></span></div></div>`;
  }

  h+=`<div class="card">
    <div class="ctitle" style="margin-bottom:.7rem">Mode de rÃ©cupÃ©ration</div>
    <div class="modes">
      <div class="mopt${MODE==='bernard'?' on':''}" data-m="bernard">ğŸ  Bernard</div>
      <div class="mopt${MODE==='vigneron'?' on':''}" data-m="vigneron">ğŸ· Vigneron</div>
    </div>
  </div>
  <div class="acts">
    <button class="btn btn-p" id="b-draft">ğŸ’¾ Sauvegarder en brouillon</button>
    <button class="btn btn-s" id="b-valid">âœ“ Valider ma commande</button>
  </div>`;
  return h;
}

function rValidee(){
  const lignes=Object.entries(PANIER).filter(([,q])=>q>0);
  const tot=calcTot(), util=calcUtil();
  let h=`<div class="val-ok"><h3>âœ“ Commande validÃ©e</h3>
    <p>Votre commande pour la campagne ${CAMP.annee} a bien Ã©tÃ© enregistrÃ©e.</p>
  </div>`;
  if(lignes.length){
    h+=`<div class="recap"><div class="rtitle">Votre commande ${CAMP.annee}</div>`;
    lignes.forEach(([id,q])=>{ const v=VINS.find(x=>x.id===id); if(v) h+=`<div class="rrow"><span>${e(v.nom)} Ã— ${q}</span><span>${f(v.prix*q)} â‚¬</span></div>`; });
    h+=`<div class="rrow"><span>Total</span><span>${f(util)} â‚¬</span></div></div>`;
  }
  h+=`<div class="acts"><button class="btn btn-o" id="b-modif">Modifier ma commande</button></div>`;
  return h;
}

// â”€â”€â”€ ONGLET INFORMATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rInfos(){
  return `<div class="card">
    <div class="shdr"><div class="stitle">Mes informations</div></div>
    <div class="igrid">
      <div class="iitem"><div class="lbl">Nom complet</div><div class="val">${e(ASSOC.prenom)} ${e(ASSOC.nom)}</div></div>
      <div class="iitem"><div class="lbl">Groupement</div><div class="val">${e(GROUPT.nom)}</div></div>
      <div class="iitem"><div class="lbl">Vigneron</div><div class="val">${e(GROUPT.vigneron||'â€”')}</div></div>
      <div class="iitem"><div class="lbl">Appellation</div><div class="val">${e(GROUPT.appellation||'â€”')}</div></div>
      <div class="iitem"><div class="lbl">Nombre de parts</div><div class="val">${ASSOC.parts||0}</div></div>
      <div class="iitem"><div class="lbl">Mode de retrait</div><div class="val" style="text-transform:capitalize">${e(ASSOC.etat||'â€”')}</div></div>
      <div class="iitem"><div class="lbl">Adresse de livraison</div><div class="val" style="font-size:1rem">${e(ASSOC.adresse||'â€”')}</div></div>
      <div class="iitem"><div class="lbl">Email</div><div class="val" style="font-size:1rem">${e(ASSOC.email||'â€”')}</div></div>
      <div class="iitem"><div class="lbl">TÃ©lÃ©phone</div><div class="val" style="font-size:1rem">${e(ASSOC.tel||'â€”')}</div></div>
    </div>
  </div>
  <div class="card">
    <div class="shdr"><div class="stitle">Mon groupement</div></div>
    <div class="igrid">
      <div class="iitem"><div class="lbl">Parts totales</div>
        <div class="val">${GROUPT.nombre_total_parts||0} <span style="font-size:.85rem;color:#999;font-weight:400">(${GROUPT.parts_pour_bouteille||1}/bouteille)</span></div></div>
      <div class="iitem"><div class="lbl">CrÃ©Ã© le</div><div class="val">${e(GROUPT.date_creation||'â€”')}</div></div>
      <div class="iitem"><div class="lbl">Campagnes</div><div class="val">${CAMPAGNES.length}</div></div>
    </div>
  </div>`;
}

// â”€â”€â”€ ONGLET HISTORIQUE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rHisto(){
  const passees = COMMANDES.filter(c=>!CAMP||c.campagne_id!==CAMP.id||c.validee);
  let h=`<div class="card"><div class="shdr"><div class="stitle">Historique des commandes</div></div>`;
  if(!passees.length){ h+=`<p class="empty">Aucune commande validÃ©e pour le moment.</p></div>`; return h; }

  passees.forEach(cmd=>{
    const lignes=Object.entries(cmd.panier||{}).filter(([,q])=>q>0);
    const tot=lignes.reduce((s,[id,q])=>s+(cmd.prix_snapshot?.[id]||0)*q,0);
    const badge=cmd.validee?`<span class="badge b-ok">ValidÃ©e</span>`:`<span class="badge b-draft">Brouillon</span>`;
    const date=cmd.date_maj?new Date(cmd.date_maj).toLocaleDateString('fr-FR'):'';

    h+=`<div class="hcard">
      <div class="hhead">
        <div>
          <div class="hannee">Campagne ${cmd.annee||'â€”'}</div>
          <div class="hmeta">Mode&nbsp;: ${e(cmd.mode_recup||'â€”')}${date?'&nbsp;Â·&nbsp;Mis Ã  jour le '+date:''}</div>
        </div>${badge}
      </div>`;

    if(lignes.length){
      h+=`<div class="hbody">`;
      lignes.forEach(([id,q])=>{
        const nom=cmd.noms_snapshot?.[id]||`Vin #${id}`;
        const px=cmd.prix_snapshot?.[id]||0;
        h+=`<div class="hrow"><span>${e(nom)} Ã— ${q}</span><span>${px?f(px*q)+' â‚¬':'â€”'}</span></div>`;
      });
      if(tot>0) h+=`<div class="hrow"><span>Total</span><span>${f(tot)} â‚¬</span></div>`;
      h+=`</div>`;
    } else {
      h+=`<div class="hbody"><p class="empty" style="padding:.5rem 0">Aucun vin sÃ©lectionnÃ©</p></div>`;
    }
    h+=`</div>`;
  });
  h+=`</div>`;
  return h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BIND EVENTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function bind(){
  document.querySelectorAll('.qb').forEach(b=>b.addEventListener('click',()=>{
    if(b.disabled)return; chgQty(b.dataset.id,parseInt(b.dataset.d));
  }));
  document.querySelectorAll('.mopt').forEach(o=>o.addEventListener('click',()=>{
    MODE=o.dataset.m;
    document.querySelectorAll('.mopt').forEach(x=>x.classList.remove('on'));
    o.classList.add('on');
  }));
  const bd=document.getElementById('b-draft');
  const bv=document.getElementById('b-valid');
  const bm=document.getElementById('b-modif');
  if(bd) bd.addEventListener('click',()=>sauv(false));
  if(bv) bv.addEventListener('click',()=>sauv(true));
  if(bm) bm.addEventListener('click',async()=>{
    const ns={},ps={};
    VINS.forEach(v=>{ns[v.id]=v.nom;ps[v.id]=v.prix;});
    await window.ASSOC_API.saveCommande(GROUPT.id,ASSOC.id,CAMP.id,CAMP.annee,PANIER,MODE,false,ns,ps);
    if(CMD) CMD.validee=false; render();
  });
}

function chgQty(id,d){
  const v=VINS.find(x=>x.id===id); if(!v)return;
  const cur=PANIER[id]||0, nw=Math.max(0,cur+d);
  if(d>0&&calcUtil()+v.prix>calcTot()+.001){al('CrÃ©dits insuffisants pour ajouter cette bouteille.',false);return;}
  if(d>0&&v.stock&&nw>v.stock){al('Stock limitÃ© atteint.',false);return;}
  if(nw===0)delete PANIER[id]; else PANIER[id]=nw;
  render();
}

async function sauv(valider){
  if(valider&&!Object.keys(PANIER).length){al('SÃ©lectionnez au moins une bouteille avant de valider.',false);return;}
  const ns={},ps={};
  VINS.forEach(v=>{ns[v.id]=v.nom;ps[v.id]=v.prix;});
  try {
    const id=await window.ASSOC_API.saveCommande(GROUPT.id,ASSOC.id,CAMP.id,CAMP.annee,PANIER,MODE,valider,ns,ps);
    CMD={id,campagne_id:CAMP.id,panier:PANIER,mode_recup:MODE,validee:valider,
         annee:CAMP.annee,noms_snapshot:ns,prix_snapshot:ps,date_maj:new Date().toISOString()};
    const i=COMMANDES.findIndex(c=>c.campagne_id===CAMP.id);
    if(i>=0) COMMANDES[i]=CMD; else COMMANDES.push(CMD);
    if(valider) render(); else al('Brouillon sauvegardÃ©.',true);
  } catch(x){console.error(x);al('Erreur lors de la sauvegarde. RÃ©essayez.',false);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HELPERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcTot(){
  const ppb=GROUPT.parts_pour_bouteille||1;
  const prix=CAMP?.prix_bouteille_reference||GROUPT.prix_bouteille_reference||0;
  return (ASSOC.parts/ppb)*prix;
}
function calcUtil(){
  return Object.entries(PANIER).reduce((s,[id,q])=>{
    const v=VINS.find(x=>x.id===id); return s+(v?v.prix*q:0);
  },0);
}
function err(t,m){ document.getElementById('main').innerHTML=`<div class="sc"><h2>${t}</h2><p>${m}</p></div>`; }
function al(m,ok){ const z=document.getElementById('az'); if(z){z.innerHTML=`<div class="al ${ok?'al-ok':'al-err'}">${m}</div>`;setTimeout(()=>{if(z)z.innerHTML=''},4000);} }
function f(n){ return Number(n||0).toFixed(2); }
function e(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>
