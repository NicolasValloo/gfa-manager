<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GFA Manager ‚Äî Mon Espace</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Cormorant+Garamond:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, addDoc, updateDoc, orderBy }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  ‚úÖ  CONFIGURATION FIREBASE ‚Äî Projet : gfa-manager-50a7f    ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
const firebaseConfig = {
  apiKey:            "AIzaSyB6MW35DPPsh59DoOEPVXml6FIvDNFgdI0",
  authDomain:        "gfa-manager-50a7f.firebaseapp.com",
  projectId:         "gfa-manager-50a7f",
  storageBucket:     "gfa-manager-50a7f.firebasestorage.app",
  messagingSenderId: "224596157977",
  appId:             "1:224596157977:web:c8d09907b8185010076c88"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const TOKEN = new URLSearchParams(location.search).get('token');

async function findAssocieByToken(token) {
  const gSnap = await getDocs(collection(db, "groupements"));
  for (const gDoc of gSnap.docs) {
    const aSnap = await getDocs(
      query(collection(db,"groupements",gDoc.id,"associes"), where("token","==",token))
    );
    if (!aSnap.empty) {
      const aDoc = aSnap.docs[0];
      return { groupement:{id:gDoc.id,...gDoc.data()}, associe:{id:aDoc.id,...aDoc.data()} };
    }
  }
  return null;
}

// Charge la campagne active pour un groupement
async function getCampagneActive(groupementId) {
  const snap = await getDocs(
    query(collection(db, "groupements", groupementId, "campagnes"), where("actif","==",true))
  );
  if(snap.empty) return null;
  return {id:snap.docs[0].id, ...snap.docs[0].data()};
}

// Charge TOUTES les campagnes d'un groupement
async function getCampagnesGroupement(groupementId) {
  const snap = await getDocs(collection(db, "groupements", groupementId, "campagnes"));
  return snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>(b.annee||0)-(a.annee||0));
}

// Charge les vins d'une campagne (NOUVEAU : depuis collection vins avec tri)
async function getVinsCampagne(campagneId, campagneData) {
  if (!campagneData || !campagneData.vinsIds || !campagneData.vinsIds.length) {
    return [];
  }
  
  // R√©cup√©rer tous les vins r√©f√©renc√©s dans la campagne
  const vinsPromises = campagneData.vinsIds.map(async (vinId) => {
    const vinDoc = await getDocs(query(collection(db, "vins"), where("__name__", "==", vinId)));
    if (!vinDoc.empty) {
      return { id: vinDoc.docs[0].id, ...vinDoc.docs[0].data() };
    }
    return null;
  });
  
  const vins = (await Promise.all(vinsPromises)).filter(v => v !== null);
  
  // Tri par type puis par prix (d√©j√† fait normalement par Firestore, mais on s'assure)
  const typeOrder = { blanc: 1, ros√©: 2, rouge: 3, p√©tillant: 4, doux: 5 };
  vins.sort((a, b) => {
    const typeA = typeOrder[a.type] || 999;
    const typeB = typeOrder[b.type] || 999;
    if (typeA !== typeB) return typeA - typeB;
    return (a.prixUnitaire || 0) - (b.prixUnitaire || 0);
  });
  
  return vins;
}

// Charge toutes les commandes de l'associ√©
async function getCommandes(groupementId, associeId) {
  const campagnesSnap = await getDocs(collection(db, "groupements", groupementId, "campagnes"));
  const toutesCommandes = [];
  
  for(const campDoc of campagnesSnap.docs) {
    const cmdsSnap = await getDocs(
      query(collection(db,"groupements",groupementId,"campagnes",campDoc.id,"commandes"), 
            where("associe_id","==",associeId))
    );
    cmdsSnap.docs.forEach(cmdDoc => {
      toutesCommandes.push({
        id: cmdDoc.id,
        campagne_id: campDoc.id,
        ...cmdDoc.data()
      });
    });
  }
  
  return toutesCommandes.sort((a,b)=>(b.annee||0)-(a.annee||0));
}

// Sauvegarde la commande
async function saveCommande(groupementId, campagneId, associeId, annee, panier, modeRecup, valider, nomsSn, prixSn) {
  const existing = (await getDocs(
    query(collection(db,"groupements",groupementId,"campagnes",campagneId,"commandes"),
          where("associe_id","==",associeId))
  )).docs[0];
  
  const data = {
    associe_id: associeId,
    groupement_id: groupementId,
    campagne_id: campagneId,
    annee,
    panier,
    mode_recup: modeRecup,
    validee: valider,
    date_maj: new Date().toISOString(),
    noms_snapshot: nomsSn||{},
    prix_snapshot: prixSn||{}
  };
  
  if (existing) {
    await updateDoc(doc(db,"groupements",groupementId,"campagnes",campagneId,"commandes",existing.id), data);
    return existing.id;
  } else {
    const r = await addDoc(collection(db,"groupements",groupementId,"campagnes",campagneId,"commandes"), data);
    return r.id;
  }
}

window.ASSOC_API = { findAssocieByToken, getCampagneActive, getCampagnesGroupement, getVinsCampagne, getCommandes, saveCommande };
window.dispatchEvent(new Event('api:ready'));
</script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--burg:#6B1E3C;--deep:#4A1228;--gold:#C9A961;--cream:#F8F5EF;--dark:#2C1810;--sage:#8B9A7E;--terra:#C67B5C}
body{font-family:'Cormorant Garamond',serif;background:var(--cream);color:var(--dark);overflow-x:hidden}
.grain{position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:.03;
  background:url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='2.5' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}
/* Header */
.hdr{background:linear-gradient(135deg,var(--burg),var(--deep));color:var(--cream);
  padding:2.8rem 2rem 2rem;text-align:center;position:relative;overflow:hidden}
.hdr::before{content:'';position:absolute;inset:0;
  background:repeating-linear-gradient(45deg,transparent,transparent 35px,rgba(255,255,255,.03) 35px,rgba(255,255,255,.03) 70px);pointer-events:none}
.logo{font-family:'Playfair Display',serif;font-size:2.6rem;font-weight:900;position:relative;z-index:2}
.logo em{color:var(--gold);font-style:italic}
.deco{width:80px;height:2px;background:var(--gold);margin:.7rem auto;position:relative;z-index:2}
.tagline{font-size:.95rem;opacity:.8;position:relative;z-index:2}
.hdr-name{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:600;
  color:var(--gold);margin-top:.4rem;position:relative;z-index:2}
/* Tabs */
.tabs{background:white;box-shadow:0 4px 20px rgba(107,30,60,.1);position:sticky;top:0;z-index:100}
.tabs-inner{max-width:960px;margin:0 auto;display:flex}
.tab{flex:1;padding:1.2rem 1rem;border:none;background:transparent;font-family:'Playfair Display',serif;
  font-size:.95rem;font-weight:600;color:var(--burg);cursor:pointer;transition:all .3s;position:relative}
.tab::after{content:'';position:absolute;bottom:-1px;left:50%;width:0;height:3px;
  background:var(--gold);transform:translateX(-50%);transition:width .3s}
.tab.active::after,.tab:hover::after{width:100%}
.tab.active{color:var(--deep);background:linear-gradient(to bottom,rgba(201,169,97,.1),transparent)}
/* Main */
.main{max-width:960px;margin:0 auto;padding:2.5rem 2rem;animation:fadeIn .5s}
/* Card */
.card{background:white;border-radius:2px;padding:2.2rem;margin-bottom:1.8rem;
  box-shadow:0 2px 4px rgba(107,30,60,.08),0 8px 16px rgba(107,30,60,.06),inset 0 0 0 1px rgba(107,30,60,.1);
  position:relative;overflow:hidden}
.card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent,rgba(201,169,97,.03));pointer-events:none}
.ctitle{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:700;color:var(--burg);margin-bottom:1.3rem}
/* Info grid */
.igrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:1.1rem}
.iitem{padding:1.1rem 1.3rem;background:linear-gradient(135deg,rgba(107,30,60,.03),rgba(201,169,97,.03));border-left:3px solid var(--burg);border-radius:2px}
.lbl{font-size:.78rem;text-transform:uppercase;letter-spacing:.1em;color:var(--burg);font-weight:600;margin-bottom:.3rem}
.val{font-family:'Playfair Display',serif;font-size:1.15rem;color:var(--dark);font-weight:600}

/* NOUVEAU : Montant (remplace Cr√©dits) avec meilleur alignement */
.montant-box{background:linear-gradient(135deg,var(--burg),var(--deep));color:white;
  padding:2.2rem 2rem;border-radius:2px;margin-bottom:1.8rem;
  position:relative;overflow:hidden;box-shadow:0 8px 32px rgba(107,30,60,.3)}
.montant-box::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;
  background:radial-gradient(circle,rgba(201,169,97,.2) 0%,transparent 70%);animation:rotate 20s linear infinite}
.montant-header{text-align:center;position:relative;z-index:2}
.montant-amt{font-family:'Playfair Display',serif;font-size:3.2rem;font-weight:900;color:var(--gold);animation:pulse 2.5s ease-in-out infinite}
.montant-lbl{font-size:.95rem;font-weight:300;letter-spacing:.12em;text-transform:uppercase;opacity:.9;margin-top:.3rem}
.montant-det{font-size:.9rem;opacity:.8;margin-top:.5rem}
.montant-bar-w{max-width:320px;margin:.7rem auto 0;background:rgba(255,255,255,.2);border-radius:4px;height:6px}
.montant-bar{height:6px;background:var(--gold);border-radius:4px;transition:width .5s}
.montant-breakdown{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.5rem;margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid rgba(255,255,255,.2);position:relative;z-index:2}
.montant-item{text-align:center}
.montant-item-val{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;color:var(--gold)}
.montant-item-lbl{font-size:.8rem;opacity:.8;margin-top:.3rem;text-transform:uppercase;letter-spacing:.08em}

/* NOUVEAU : Encart info multiples de 3 */
.info-panachage{
  background:linear-gradient(135deg,rgba(201,169,97,.15),rgba(201,169,97,.08));
  border-left:4px solid var(--gold);
  padding:1.2rem 1.5rem;
  border-radius:2px;
  margin-bottom:1.5rem;
  display:flex;
  align-items:start;
  gap:1rem;
}
.info-panachage-icon{
  font-size:1.8rem;
  flex-shrink:0;
}
.info-panachage-content h4{
  font-family:'Playfair Display',serif;
  font-size:1.1rem;
  font-weight:700;
  color:var(--burg);
  margin-bottom:.5rem;
}
.info-panachage-content p{
  font-size:.95rem;
  color:var(--dark);
  line-height:1.5;
}
.info-panachage-content .highlight{
  font-weight:700;
  color:var(--burg);
}

/* NOUVEAU : Tableau des vins (remplace la grille) */
.vins-table-wrapper{overflow-x:auto;margin:1.5rem 0}
.vins-table{width:100%;border-collapse:collapse;background:white;border-radius:2px;overflow:hidden;box-shadow:0 2px 8px rgba(107,30,60,.06)}
.vins-table thead{background:linear-gradient(135deg,var(--burg),var(--deep));color:white}
.vins-table th{padding:1rem 1.2rem;text-align:left;font-family:'Playfair Display',serif;font-size:.95rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase}
.vins-table th:last-child{text-align:center;width:180px}
.vins-table tbody tr{border-bottom:1px solid rgba(107,30,60,.08);transition:background .2s}
.vins-table tbody tr:hover{background:rgba(201,169,97,.05)}
.vins-table tbody tr:last-child{border-bottom:none}
.vins-table td{padding:1rem 1.2rem;font-size:.95rem}
.vins-table .vin-nom{font-weight:600;color:var(--dark)}
.vins-table .vin-details{font-size:.85rem;color:#666;margin-top:.2rem}
.vins-table .vin-prix{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;color:var(--burg)}
.vins-table .vin-stock{font-size:.8rem;color:#999;font-style:italic}

/* Section par type de vin */
.type-section{margin-bottom:2rem}
.type-header{
  font-family:'Playfair Display',serif;
  font-size:1.3rem;
  font-weight:700;
  color:var(--burg);
  margin-bottom:1rem;
  padding-bottom:.5rem;
  border-bottom:2px solid rgba(201,169,97,.3);
  display:flex;
  align-items:center;
  gap:.7rem;
}
.type-badge{
  display:inline-block;
  padding:.35rem .8rem;
  border-radius:4px;
  font-size:.85rem;
  font-weight:600;
  text-transform:uppercase;
}
.type-blanc{background:#ffe;color:#997;border:1px solid #ddb}
.type-ros√©{background:#ffe0f0;color:#c06;border:1px solid #faa}
.type-rouge{background:#fee;color:#c33;border:1px solid #faa}
.type-p√©tillant{background:#e0f0ff;color:#369;border:1px solid #9cf}
.type-doux{background:#fff0e0;color:#c90;border:1px solid #fc9}

/* Contr√¥les quantit√© */
.qty-ctrl{display:flex;align-items:center;gap:.5rem;justify-content:center}
.qty-btn{width:32px;height:32px;border:2px solid var(--burg);background:white;color:var(--burg);
  border-radius:4px;font-size:1.2rem;font-weight:700;cursor:pointer;transition:all .2s;
  display:flex;align-items:center;justify-content:center}
.qty-btn:hover{background:var(--burg);color:white}
.qty-btn:active{transform:scale(.95)}
.qty-val{min-width:40px;text-align:center;font-family:'Playfair Display',serif;
  font-size:1.1rem;font-weight:700;color:var(--dark)}

/* R√©capitulatif */
.recap{background:linear-gradient(135deg,rgba(107,30,60,.05),rgba(201,169,97,.05));
  padding:1.8rem;border-radius:2px;border:2px solid var(--gold);margin-bottom:1.5rem}
.recap-title{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;
  color:var(--burg);margin-bottom:1.2rem;text-align:center}
.recap-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1.2rem;margin-bottom:1.2rem}
.recap-item{text-align:center;padding:1rem;background:white;border-radius:2px;box-shadow:0 2px 6px rgba(107,30,60,.08)}
.recap-item-val{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:900;color:var(--burg)}
.recap-item-lbl{font-size:.85rem;color:#666;margin-top:.3rem;text-transform:uppercase;letter-spacing:.05em}
.recap-total{padding:1.2rem;background:white;border-radius:2px;text-align:center;margin-top:1rem;border:2px solid var(--gold)}
.recap-total-val{font-family:'Playfair Display',serif;font-size:2rem;font-weight:900;color:var(--burg)}
.recap-total-lbl{font-size:.9rem;color:#666;margin-top:.3rem;text-transform:uppercase;letter-spacing:.08em}
.supplement-notice{background:#fff3cd;color:#856404;padding:1rem;border-radius:2px;margin-top:1rem;text-align:center;font-size:.9rem;border:1px solid #ffeaa7}

/* NOUVEAU : Alerte multiples de 3 */
.alert-multiple3{
  background:#fff3cd;
  color:#856404;
  padding:1rem 1.2rem;
  border-radius:4px;
  border-left:4px solid #ffc107;
  margin-bottom:1rem;
  font-size:.95rem;
  display:flex;
  align-items:center;
  gap:.8rem;
}
.alert-multiple3.error{
  background:#f8d7da;
  color:#721c24;
  border-left-color:#dc3545;
}
.alert-multiple3.success{
  background:#d4edda;
  color:#155724;
  border-left-color:#28a745;
}

/* Mode r√©cup√©ration */
.mode-recup{display:flex;gap:1rem;margin:1.5rem 0}
.mode-opt{flex:1;padding:1.2rem;border:2px solid #ddd;border-radius:2px;cursor:pointer;
  text-align:center;transition:all .2s;background:white}
.mode-opt:hover{border-color:var(--gold);transform:translateY(-2px)}
.mode-opt.active{border-color:var(--burg);background:linear-gradient(135deg,rgba(107,30,60,.05),rgba(201,169,97,.05))}
.mode-opt-icon{font-size:2rem;margin-bottom:.5rem}
.mode-opt-title{font-family:'Playfair Display',serif;font-weight:600;color:var(--burg);margin-bottom:.3rem}
.mode-opt-desc{font-size:.85rem;color:#666}

/* Actions */
.actions{display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;margin-top:1.5rem}
.btn{padding:1rem 2rem;border:none;border-radius:4px;font-family:'Playfair Display',serif;
  font-size:1rem;font-weight:600;cursor:pointer;transition:all .2s;text-transform:uppercase;
  letter-spacing:.08em;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.btn-prim{background:linear-gradient(135deg,var(--burg),var(--deep));color:white}
.btn-prim:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(107,30,60,.3)}
.btn-prim:disabled{opacity:.5;cursor:not-allowed}
.btn-sec{background:white;color:var(--burg);border:2px solid var(--burg)}
.btn-sec:hover{background:var(--burg);color:white}
.btn-ter{background:var(--gold);color:white}
.btn-ter:hover{background:var(--gold-dark);transform:translateY(-2px)}

/* Historique */
.hist-list{display:grid;gap:1rem}
.hist-item{background:white;padding:1.5rem;border-radius:2px;border-left:4px solid var(--burg);
  box-shadow:0 2px 8px rgba(107,30,60,.06)}
.hist-item.validee{border-left-color:var(--sage)}
.hist-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
.hist-annee{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;color:var(--burg)}
.hist-status{padding:.4rem .8rem;border-radius:4px;font-size:.8rem;font-weight:600;text-transform:uppercase}
.hist-status.validee{background:#d4edda;color:#155724}
.hist-status.brouillon{background:#fff3cd;color:#856404}
.hist-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.8rem;font-size:.9rem}
.hist-vins{margin-top:1rem;padding-top:1rem;border-top:1px solid #eee}
.hist-vins-title{font-weight:600;color:var(--burg);margin-bottom:.5rem;font-size:.9rem}
.hist-vin{padding:.5rem 0;border-bottom:1px solid #f5f5f5;display:flex;justify-content:space-between}
.hist-vin:last-child{border:none}

/* Alerts */
.al{position:fixed;bottom:2rem;right:2rem;padding:1rem 1.5rem;border-radius:4px;
  box-shadow:0 4px 16px rgba(0,0,0,.3);z-index:1000;animation:slideIn .3s;min-width:250px}
.al-ok{background:#28a745;color:white}
.al-err{background:#dc3545;color:white}

/* Screen */
.sc{text-align:center;padding:4rem 2rem}
.sc h2{font-family:'Playfair Display',serif;font-size:2rem;color:var(--burg);margin-bottom:1rem}
.sc p{font-size:1.1rem;color:#666}

/* Animations */
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}

/* Responsive */
@media(max-width:768px){
  .hdr{padding:2rem 1.5rem}
  .logo{font-size:2rem}
  .main{padding:2rem 1rem}
  .tabs-inner{flex-direction:column}
  .tab{padding:1rem}
  .igrid{grid-template-columns:1fr}
  .montant-breakdown{grid-template-columns:1fr;gap:1rem}
  .vins-table{font-size:.85rem}
  .vins-table th,.vins-table td{padding:.8rem}
  .qty-ctrl{gap:.3rem}
  .qty-btn{width:28px;height:28px;font-size:1rem}
  .recap-grid{grid-template-columns:1fr}
  .actions{flex-direction:column}
  .btn{width:100%}
  .mode-recup{flex-direction:column}
}
</style>

</head>
<body>
<div class="grain"></div>

<header class="hdr">
  <h1 class="logo">GFA <em>Manager</em></h1>
  <div class="deco"></div>
  <div class="tagline">Votre espace personnel</div>
  <div class="hdr-name" id="hdr-name"></div>
</header>

<nav class="tabs">
  <div class="tabs-inner">
    <button class="tab active" data-tab="info">Mes Informations</button>
    <button class="tab" data-tab="commande">Commander</button>
    <button class="tab" data-tab="historique">Historique</button>
  </div>
</nav>

<main class="main" id="main">
  <div class="sc"><h2>Chargement...</h2></div>
</main>

<div id="az"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  √âTAT GLOBAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let GROUPT, ASSOC, CAMP, VINS=[], PANIER={}, MODE='livraison', COMMANDES=[], CMD=null, TAB='info';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INITIALISATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('api:ready', async ()=>{
  const t=new URLSearchParams(location.search).get('token');
  if(!t){ err('Acc√®s refus√©','Token manquant dans l\'URL.'); return; }
  
  const res=await window.ASSOC_API.findAssocieByToken(t);
  if(!res){ err('Acc√®s refus√©','Token invalide ou expir√©.'); return; }
  
  GROUPT=res.groupement; ASSOC=res.associe;
  document.getElementById('hdr-name').textContent=`${ASSOC.prenom} ${ASSOC.nom}`;
  
  // Charger campagne active
  CAMP = await window.ASSOC_API.getCampagneActive(GROUPT.id);
  
  if(CAMP){
    VINS = await window.ASSOC_API.getVinsCampagne(CAMP.id, CAMP);
  }
  
  // Charger commandes
  COMMANDES = await window.ASSOC_API.getCommandes(GROUPT.id, ASSOC.id);
  CMD = COMMANDES.find(c => c.campagne_id === CAMP?.id && c.groupement_id === GROUPT.id);
  
  if(CMD){
    PANIER = CMD.panier || {};
    MODE = CMD.mode_recup || 'livraison';
  }
  
  render();
  
  // Navigation
  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      TAB=t.dataset.tab;
      render();
    });
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  const m=document.getElementById('main');
  if(TAB==='info') m.innerHTML=renderInfo();
  else if(TAB==='commande') m.innerHTML=renderCommande();
  else if(TAB==='historique') m.innerHTML=renderHistorique();
  attachListeners();
}

function renderInfo(){
  const tot=calcTot();
  const ppb=GROUPT.parts_pour_bouteille||1;
  const nbBout=ASSOC.parts/ppb;
  
  return `
    <div class="card">
      <h2 class="ctitle">Informations Personnelles</h2>
      <div class="igrid">
        <div class="iitem"><div class="lbl">Groupement</div><div class="val">${e(GROUPT.nom)}</div></div>
        <div class="iitem"><div class="lbl">Vigneron</div><div class="val">${e(GROUPT.vigneron||'‚Äî')}</div></div>
        <div class="iitem"><div class="lbl">Mes Parts</div><div class="val">${ASSOC.parts}</div></div>
        <div class="iitem"><div class="lbl">√âquivalent Bouteilles</div><div class="val">${nbBout.toFixed(1)}</div></div>
      </div>
    </div>
    
    <div class="montant-box">
      <div class="montant-header">
        <div class="montant-amt">${f(tot)} ‚Ç¨</div>
        <div class="montant-lbl">Montant Disponible</div>
        <div class="montant-det">Calcul√© sur ${nbBout.toFixed(1)} bouteille${nbBout>1?'s':''} √ó ${f((GROUPT.prix_bouteille_reference||0))} ‚Ç¨</div>
        <div class="montant-bar-w">
          <div class="montant-bar" style="width:100%"></div>
        </div>
      </div>
      <div class="montant-breakdown">
        <div class="montant-item">
          <div class="montant-item-val">${ASSOC.parts}</div>
          <div class="montant-item-lbl">Parts</div>
        </div>
        <div class="montant-item">
          <div class="montant-item-val">${ppb}</div>
          <div class="montant-item-lbl">Parts/Bouteille</div>
        </div>
        <div class="montant-item">
          <div class="montant-item-val">${f(GROUPT.prix_bouteille_reference||0)} ‚Ç¨</div>
          <div class="montant-item-lbl">Prix R√©f√©rence</div>
        </div>
      </div>
    </div>
    
    ${!CAMP ? `
      <div class="card">
        <h2 class="ctitle">Campagne ${new Date().getFullYear()}</h2>
        <p style="color:#999;font-style:italic;text-align:center;padding:2rem">
          Aucune campagne active pour le moment. Vous serez notifi√© par email d√®s l'ouverture de la prochaine campagne.
        </p>
      </div>
    ` : `
      <div class="card">
        <h2 class="ctitle">Campagne Active : ${CAMP.annee||new Date().getFullYear()}</h2>
        <div class="igrid">
          <div class="iitem"><div class="lbl">Ann√©e</div><div class="val">${CAMP.annee||'‚Äî'}</div></div>
          <div class="iitem"><div class="lbl">Vins Disponibles</div><div class="val">${VINS.length}</div></div>
          ${CAMP.date_fin ? `<div class="iitem"><div class="lbl">Date Limite</div><div class="val">${CAMP.date_fin}</div></div>` : ''}
          <div class="iitem">
            <div class="lbl">Statut Commande</div>
            <div class="val">${CMD?.validee ? '‚úÖ Valid√©e' : 'üìù Brouillon'}</div>
          </div>
        </div>
      </div>
    `}
  `;
}

function renderCommande(){
  if(!CAMP){
    return `<div class="card"><h2 class="ctitle">Commander</h2><p style="text-align:center;color:#999;padding:2rem">Aucune campagne active.</p></div>`;
  }
  
  const tot=calcTot(), util=calcUtil(), reste=tot-util, supp=calcSupplement();
  const totalBouteilles = Object.values(PANIER).reduce((s,q)=>s+q,0);
  const estMultipleDe3 = totalBouteilles % 3 === 0;
  const prochainMultiple = Math.ceil(totalBouteilles / 3) * 3;
  const bouteill√©sManquantes = estMultipleDe3 ? 0 : prochainMultiple - totalBouteilles;
  
  // Grouper les vins par type
  const vinsByType = {
    blanc: [],
    ros√©: [],
    rouge: [],
    p√©tillant: [],
    doux: []
  };
  
  VINS.forEach(v => {
    const type = v.type || 'rouge';
    if (vinsByType[type]) {
      vinsByType[type].push(v);
    }
  });
  
  const typesLabels = {
    blanc: 'Vins Blancs',
    ros√©: 'Vins Ros√©s',
    rouge: 'Vins Rouges',
    p√©tillant: 'Vins P√©tillants',
    doux: 'Vins Doux'
  };
  
  let vinsHTML = '';
  Object.keys(vinsByType).forEach(type => {
    const vinsType = vinsByType[type];
    if (!vinsType.length) return;
    
    vinsHTML += `
      <div class="type-section">
        <div class="type-header">
          <span class="type-badge type-${type}">${typesLabels[type]}</span>
          <span style="font-size:.9rem;color:#666;font-weight:400">(${vinsType.length})</span>
        </div>
        <div class="vins-table-wrapper">
          <table class="vins-table">
            <thead>
              <tr>
                <th>Vin</th>
                <th>Prix</th>
                <th>Quantit√©</th>
              </tr>
            </thead>
            <tbody>
              ${vinsType.map(v => {
                const qty = PANIER[v.id] || 0;
                return `
                  <tr>
                    <td>
                      <div class="vin-nom">${e(v.nom)}</div>
                      <div class="vin-details">
                        ${v.appellation ? e(v.appellation) : ''}${v.millesime ? ' ‚Ä¢ ' + e(v.millesime) : ''}
                      </div>
                    </td>
                    <td>
                      <div class="vin-prix">${f(v.prixUnitaire)} ‚Ç¨</div>
                      ${v.stock ? `<div class="vin-stock">Stock: ${v.stock}</div>` : ''}
                    </td>
                    <td>
                      <div class="qty-ctrl">
                        <button class="qty-btn" onclick="chgQty('${v.id}',-1)">‚àí</button>
                        <div class="qty-val">${qty}</div>
                        <button class="qty-btn" onclick="chgQty('${v.id}',1)">+</button>
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
  });
  
  return `
    <div class="card">
      <h2 class="ctitle">Ma Commande ${CAMP.annee||''}</h2>
      
      <div class="info-panachage">
        <div class="info-panachage-icon">‚ÑπÔ∏è</div>
        <div class="info-panachage-content">
          <h4>R√®gle du panachage</h4>
          <p>
            Les commandes doivent √™tre pass√©es par <span class="highlight">multiples de 3 bouteilles</span>.
            Vous pouvez mixer diff√©rents vins, mais le total doit √™tre un multiple de 3 (3, 6, 9, 12...).
          </p>
        </div>
      </div>
      
      ${totalBouteilles > 0 ? `
        <div class="alert-multiple3 ${estMultipleDe3 ? 'success' : 'error'}">
          ${estMultipleDe3 
            ? `‚úÖ Parfait ! Vous avez s√©lectionn√© ${totalBouteilles} bouteille${totalBouteilles>1?'s':''} (multiple de 3).`
            : `‚ö†Ô∏è Attention : ${totalBouteilles} bouteille${totalBouteilles>1?'s':''} s√©lectionn√©e${totalBouteilles>1?'s':''}. Ajoutez ${bouteill√©sManquantes} bouteille${bouteill√©sManquantes>1?'s':''} pour atteindre ${prochainMultiple}.`
          }
        </div>
      ` : ''}
      
      ${vinsHTML}
      
      <div class="recap">
        <div class="recap-title">üìä R√©capitulatif</div>
        <div class="recap-grid">
          <div class="recap-item">
            <div class="recap-item-val">${totalBouteilles}</div>
            <div class="recap-item-lbl">Bouteilles</div>
          </div>
          <div class="recap-item">
            <div class="recap-item-val">${f(util)} ‚Ç¨</div>
            <div class="recap-item-lbl">Total</div>
          </div>
          <div class="recap-item">
            <div class="recap-item-val">${f(tot)} ‚Ç¨</div>
            <div class="recap-item-lbl">Montant Dispo</div>
          </div>
          <div class="recap-item">
            <div class="recap-item-val" style="color:${reste>=0?'var(--sage)':'var(--terra)'}">${f(reste)} ‚Ç¨</div>
            <div class="recap-item-lbl">Reste</div>
          </div>
        </div>
        ${supp > 0 ? `
          <div class="supplement-notice">
            ‚ö†Ô∏è Suppl√©ment de <strong>${f(supp)} ‚Ç¨</strong> √† r√©gler
          </div>
        ` : ''}
      </div>
      
      <div style="margin-top:2rem">
        <h3 style="font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;color:var(--burg);margin-bottom:1rem">
          Mode de r√©cup√©ration
        </h3>
        <div class="mode-recup">
          <div class="mode-opt ${MODE==='livraison'?'active':''}" onclick="MODE='livraison';render()">
            <div class="mode-opt-icon">üöö</div>
            <div class="mode-opt-title">Livraison</div>
            <div class="mode-opt-desc">Livr√© √† domicile</div>
          </div>
          <div class="mode-opt ${MODE==='retrait'?'active':''}" onclick="MODE='retrait';render()">
            <div class="mode-opt-icon">üè™</div>
            <div class="mode-opt-title">Retrait</div>
            <div class="mode-opt-desc">√Ä retirer sur place</div>
          </div>
        </div>
      </div>
      
      <div class="actions">
        <button class="btn btn-sec" id="btn-panacher">üé≤ Panachage Auto</button>
        <button class="btn btn-sec" id="btn-repeter">üîÑ R√©p√©ter Ann√©e Pr√©c√©dente</button>
        <button class="btn btn-ter" id="btn-sauv">üíæ Sauvegarder Brouillon</button>
        <button class="btn btn-prim" id="btn-valid" ${!estMultipleDe3 || totalBouteilles===0 ? 'disabled' : ''}>
          ‚úÖ Valider la Commande
        </button>
      </div>
      
      ${!estMultipleDe3 && totalBouteilles > 0 ? `
        <p style="text-align:center;color:#856404;margin-top:1rem;font-size:.9rem">
          ‚ö†Ô∏è Vous ne pouvez pas valider tant que le total n'est pas un multiple de 3 bouteilles.
        </p>
      ` : ''}
    </div>
  `;
}

function renderHistorique(){
  if(!COMMANDES.length){
    return `<div class="card"><h2 class="ctitle">Historique</h2><p style="text-align:center;color:#999;padding:2rem">Aucune commande pour le moment.</p></div>`;
  }
  
  return `
    <div class="card">
      <h2 class="ctitle">Mes Commandes</h2>
      <div class="hist-list">
        ${COMMANDES.map(c=>{
          const nbVins = Object.keys(c.panier||{}).length;
          const nbBout = Object.values(c.panier||{}).reduce((s,q)=>s+q,0);
          const total = Object.entries(c.panier||{}).reduce((s,[id,q])=>{
            const prix = c.prix_snapshot?.[id] || 0;
            return s + (prix * q);
          }, 0);
          
          return `
            <div class="hist-item ${c.validee?'validee':''}">
              <div class="hist-header">
                <div class="hist-annee">Campagne ${c.annee||'‚Äî'}</div>
                <div class="hist-status ${c.validee?'validee':'brouillon'}">
                  ${c.validee ? '‚úÖ Valid√©e' : 'üìù Brouillon'}
                </div>
              </div>
              <div class="hist-details">
                <div><strong>Vins:</strong> ${nbVins}</div>
                <div><strong>Bouteilles:</strong> ${nbBout}</div>
                <div><strong>Total:</strong> ${f(total)} ‚Ç¨</div>
                <div><strong>Mode:</strong> ${c.mode_recup==='livraison'?'üöö Livraison':'üè™ Retrait'}</div>
                ${c.date_maj ? `<div style="grid-column:1/-1"><strong>Modifi√©e:</strong> ${new Date(c.date_maj).toLocaleDateString('fr-FR')}</div>` : ''}
              </div>
              ${nbVins > 0 ? `
                <div class="hist-vins">
                  <div class="hist-vins-title">D√©tail de la commande:</div>
                  ${Object.entries(c.panier||{}).map(([id,q])=>{
                    const nom = c.noms_snapshot?.[id] || 'Vin inconnu';
                    const prix = c.prix_snapshot?.[id] || 0;
                    return `
                      <div class="hist-vin">
                        <span>${e(nom)} <span style="color:#999">√ó${q}</span></span>
                        <span style="font-weight:600">${f(prix * q)} ‚Ç¨</span>
                      </div>
                    `;
                  }).join('')}
                </div>
              ` : ''}
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LISTENERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function attachListeners(){
  const bv=document.getElementById('btn-valid');
  const bs=document.getElementById('btn-sauv');
  const bp=document.getElementById('btn-panacher');
  const br=document.getElementById('btn-repeter');
  
  if(bv) bv.addEventListener('click',async()=>{
    const totalBouteilles = Object.values(PANIER).reduce((s,q)=>s+q,0);
    if (totalBouteilles % 3 !== 0) {
      al('La commande doit √™tre un multiple de 3 bouteilles.', false);
      return;
    }
    if(!Object.keys(PANIER).length){al('S√©lectionnez au moins une bouteille.',false);return;}
    if(!confirm('Valider d√©finitivement cette commande ?')) return;
    await sauv(true);
    al('‚úÖ Commande valid√©e avec succ√®s !',true);
    setTimeout(()=>{ TAB='historique'; render(); },1500);
  });
  
  if(bs) bs.addEventListener('click',async()=>{
    const ns={},ps={};
    VINS.forEach(v=>{ns[v.id]=v.nom;ps[v.id]=v.prixUnitaire;});
    await window.ASSOC_API.saveCommande(GROUPT.id,CAMP.id,ASSOC.id,CAMP.annee,PANIER,MODE,false,ns,ps);
    if(CMD) CMD.validee=false; 
    al('üíæ Brouillon sauvegard√©',true);
    render();
  });
  
  if(bp) bp.addEventListener('click',()=>panacherAuto());
  if(br) br.addEventListener('click',()=>repeterAnneePrecedente());
}

function chgQty(id,d){
  const v=VINS.find(x=>x.id===id); if(!v)return;
  const cur=PANIER[id]||0, nw=Math.max(0,cur+d);
  if(d>0&&v.stock&&nw>v.stock){al('Stock limit√© atteint.',false);return;}
  if(nw===0)delete PANIER[id]; else PANIER[id]=nw;
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FONCTIONS INTELLIGENTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function panacherAuto(){
  const credits = calcTot();
  const nbVins = VINS.length;
  
  if(nbVins===0) return;
  
  PANIER = {};
  
  // Calculer combien on peut d√©penser par vin
  const budgetParVin = credits / nbVins;
  
  const vinsAvecQty = VINS.map(v => {
    const qtyIdeal = Math.floor(budgetParVin / v.prixUnitaire);
    return {
      id: v.id,
      prix: v.prixUnitaire,
      qty: Math.max(1, qtyIdeal),
      stock: v.stock
    };
  });
  
  let totalActuel = vinsAvecQty.reduce((s,v)=>s+(v.prix*v.qty),0);
  let totalBouteilles = vinsAvecQty.reduce((s,v)=>s+v.qty,0);
  
  // Ajuster pour multiples de 3
  vinsAvecQty.sort((a,b)=>a.prix-b.prix);
  
  while(totalBouteilles % 3 !== 0 && totalActuel < credits){
    for(const v of vinsAvecQty){
      if(totalActuel + v.prix <= credits){
        if(!v.stock || v.qty < v.stock){
          v.qty++;
          totalActuel += v.prix;
          totalBouteilles++;
          if(totalBouteilles % 3 === 0) break;
        }
      }
    }
    if(totalBouteilles % 3 === 0) break;
  }
  
  // Si on a d√©pass√©, retirer des bouteilles
  while(totalBouteilles % 3 !== 0){
    const vinARed = vinsAvecQty.find(v => v.qty > 1);
    if(vinARed){
      vinARed.qty--;
      totalBouteilles--;
      totalActuel -= vinARed.prix;
    } else break;
  }
  
  vinsAvecQty.forEach(v => {
    if(v.qty > 0) PANIER[v.id] = v.qty;
  });
  
  al(`Panachage auto : ${totalBouteilles} bouteilles (${f(totalActuel)} ‚Ç¨)`, true);
  render();
}

function repeterAnneePrecedente(){
  const commandesPrecedentes = COMMANDES.filter(c => 
    c.validee && 
    c.campagne_id !== CAMP.id &&
    c.groupement_id === GROUPT.id
  ).sort((a,b)=>(b.annee||0)-(a.annee||0));
  
  if(!commandesPrecedentes.length){
    al('Aucune commande pr√©c√©dente trouv√©e.', false);
    return;
  }
  
  const cmdPrecedente = commandesPrecedentes[0];
  const panierPrecedent = cmdPrecedente.panier || {};
  const nomsPrecedents = cmdPrecedente.noms_snapshot || {};
  
  PANIER = {};
  
  let nbCorrespondances = 0;
  let nbNonTrouves = 0;
  
  Object.entries(panierPrecedent).forEach(([oldId, qty]) => {
    const nomVin = nomsPrecedents[oldId];
    if(!nomVin) return;
    
    const vinActuel = VINS.find(v => v.nom === nomVin);
    
    if(vinActuel){
      const qtyFinale = vinActuel.stock ? Math.min(qty, vinActuel.stock) : qty;
      PANIER[vinActuel.id] = qtyFinale;
      nbCorrespondances++;
    } else {
      nbNonTrouves++;
    }
  });
  
  if(nbCorrespondances > 0){
    al(`Commande ${cmdPrecedente.annee||'pr√©c√©dente'} recharg√©e : ${nbCorrespondances} vin${nbCorrespondances>1?'s':''} retrouv√©${nbCorrespondances>1?'s':''}${nbNonTrouves>0?`, ${nbNonTrouves} non disponible${nbNonTrouves>1?'s':''}`:''}.`, true);
  } else {
    al('Aucun vin de votre commande pr√©c√©dente n\'est disponible cette ann√©e.', false);
  }
  
  render();
}

async function sauv(valider){
  const totalBouteilles = Object.values(PANIER).reduce((s,q)=>s+q,0);
  
  if(valider){
    if(!Object.keys(PANIER).length){al('S√©lectionnez au moins une bouteille avant de valider.',false);return;}
    if(totalBouteilles % 3 !== 0){al('La commande doit √™tre un multiple de 3 bouteilles.',false);return;}
  }
  
  const ns={},ps={};
  VINS.forEach(v=>{ns[v.id]=v.nom;ps[v.id]=v.prixUnitaire;});
  
  try {
    const id=await window.ASSOC_API.saveCommande(GROUPT.id,CAMP.id,ASSOC.id,CAMP.annee,PANIER,MODE,valider,ns,ps);
    CMD={id,campagne_id:CAMP.id,groupement_id:GROUPT.id,panier:PANIER,mode_recup:MODE,validee:valider,
         annee:CAMP.annee,noms_snapshot:ns,prix_snapshot:ps,date_maj:new Date().toISOString()};
    const i=COMMANDES.findIndex(c=>c.campagne_id===CAMP.id && c.groupement_id===GROUPT.id);
    if(i>=0) COMMANDES[i]=CMD; else COMMANDES.push(CMD);
    if(valider) render(); else al('Brouillon sauvegard√©.',true);
  } catch(x){console.error(x);al('Erreur lors de la sauvegarde. R√©essayez.',false);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcTot(){
  const ppb=GROUPT.parts_pour_bouteille||1;
  const prix = GROUPT.prix_bouteille_reference||0;
  return (ASSOC.parts/ppb)*prix;
}

function calcUtil(){
  return Object.entries(PANIER).reduce((s,[id,q])=>{
    const v=VINS.find(x=>x.id===id); 
    return s+(v?v.prixUnitaire*q:0);
  },0);
}

function calcSupplement(){
  const tot=calcTot(), util=calcUtil();
  return Math.max(0, util-tot);
}

function err(t,m){ 
  document.getElementById('main').innerHTML=`<div class="sc"><h2>${t}</h2><p>${m}</p></div>`; 
}

function al(m,ok){ 
  const z=document.getElementById('az'); 
  if(z){
    z.innerHTML=`<div class="al ${ok?'al-ok':'al-err'}">${m}</div>`;
    setTimeout(()=>{if(z)z.innerHTML=''},4000);
  } 
}

function f(n){ return Number(n||0).toFixed(2); }
function e(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>
