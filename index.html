<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GFA Manager â€” Administration</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Cormorant+Garamond:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<script>
// â”€â”€ Ouvre le client mail avec texte prÃ©-rempli (associÃ© individuel) â”€â”€
function ouvrirMailAssocie(associe, groupement) {
  const lien = `${location.origin}/associe.html?token=${associe.token}`;
  const sujet = encodeURIComponent(
    `Votre accÃ¨s GFA Manager â€” ${groupement.nom}`
  );
  const corps = encodeURIComponent(
`Bonjour ${associe.prenom},

Vous Ãªtes associÃ©(e) au groupement "${groupement.nom}" (${groupement.vigneron || ''}).

Retrouvez votre espace personnel â€” informations, crÃ©dits et commandes â€” via le lien ci-dessous :

${lien}

Ce lien vous est personnel. Conservez-le prÃ©cieusement.

Cordialement`
  );
  window.location.href = `mailto:${associe.email}?subject=${sujet}&body=${corps}`;
}

// â”€â”€ Ouvre le client mail pour une campagne (associÃ© individuel) â”€â”€
function ouvrirMailCampagne(associe, groupement, annee, dateFin) {
  const lien  = `${location.origin}/associe.html?token=${associe.token}`;
  const ppb   = groupement.parts_pour_bouteille || 1;
  const prix  = groupement.prix_bouteille_reference || 0;
  const creds = ((associe.parts || 0) / ppb * prix).toFixed(2);
  const sujet = encodeURIComponent(
    `ğŸ· Campagne GFA ${annee} â€” Passez votre commande`
  );
  const corps = encodeURIComponent(
`Bonjour ${associe.prenom},

La campagne ${annee} est maintenant ouverte pour le groupement "${groupement.nom}".

Vos crÃ©dits disponibles : ${creds} â‚¬${dateFin ? `\nDate limite de commande : ${dateFin}` : ''}

AccÃ©dez Ã  votre espace pour passer votre commande :

${lien}

Cordialement`
  );
  window.location.href = `mailto:${associe.email}?subject=${sujet}&body=${corps}`;
}

window.MAIL = { ouvrirMailAssocie, ouvrirMailCampagne };
</script>

<!-- â•â• FIREBASE (v10 CDN) â•â• -->
<script type="module">
import { initializeApp }                    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
                                            from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, doc, getDocs, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot }
                                            from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘  âœ…  CONFIGURATION FIREBASE â€” Projet : gfa-manager-50a7f    â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey:            "AIzaSyB6MW35DPPsh59DoOEPVXml6FIvDNFgdI0",
  authDomain:        "gfa-manager-50a7f.firebaseapp.com",
  projectId:         "gfa-manager-50a7f",
  storageBucket:     "gfa-manager-50a7f.firebasestorage.app",
  messagingSenderId: "224596157977",
  appId:             "1:224596157977:web:c8d09907b8185010076c88"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

// â”€â”€ Utilitaires Firestore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getGroupements() {
  const snap = await getDocs(collection(db, "groupements"));
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}
async function saveGroupement(g) {
  if (g.id) {
    await updateDoc(doc(db, "groupements", g.id), g);
    return g.id;
  } else {
    const ref = await addDoc(collection(db, "groupements"), g);
    return ref.id;
  }
}
async function deleteGroupement(id) {
  await deleteDoc(doc(db, "groupements", id));
}
async function saveAssocie(groupementId, associe) {
  const ref = associe.id
    ? doc(db, "groupements", groupementId, "associes", associe.id)
    : doc(collection(db, "groupements", groupementId, "associes"));
  await setDoc(ref, associe);
  return ref.id;
}
async function deleteAssocie(groupementId, associeId) {
  await deleteDoc(doc(db, "groupements", groupementId, "associes", associeId));
}
async function getAssocies(groupementId) {
  const snap = await getDocs(collection(db, "groupements", groupementId, "associes"));
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

// â”€â”€ GÃ©nÃ©ration de token unique pour un associÃ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function genToken() {
  return [...crypto.getRandomValues(new Uint8Array(24))].map(b=>b.toString(16).padStart(2,'0')).join('');
}

// â”€â”€ Exposer sur window pour les fonctions inline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.GFA = { auth, db, getGroupements, saveGroupement, deleteGroupement,
               saveAssocie, deleteAssocie, getAssocies, genToken,
               signInWithEmailAndPassword, onAuthStateChanged, signOut };

// â”€â”€ Amorcer l'app dÃ¨s que Firebase est prÃªt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onAuthStateChanged(auth, (user) => {
  document.dispatchEvent(new CustomEvent('gfa:authchange', { detail: user }));
});
</script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --burg:#6B1E3C;--deep:#4A1228;--gold:#C9A961;
  --cream:#F8F5EF;--dark:#2C1810;--sage:#8B9A7E;--terra:#C67B5C;
}
body{font-family:'Cormorant Garamond',serif;background:var(--cream);color:var(--dark);overflow-x:hidden}

/* â”€â”€ GRAIN â”€â”€ */
.grain{position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:.03;
  background:url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='2.5' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}

/* â”€â”€ LOGIN â”€â”€ */
#login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,var(--burg),var(--deep))}
.login-box{background:white;border-radius:4px;padding:3rem;width:100%;max-width:440px;
  box-shadow:0 24px 64px rgba(0,0,0,.35);animation:fadeIn .5s}
.login-logo{font-family:'Playfair Display',serif;font-size:2.8rem;font-weight:900;
  color:var(--burg);text-align:center;margin-bottom:.3rem}
.login-logo span{color:var(--gold);font-style:italic}
.login-sub{text-align:center;color:#999;font-size:1rem;margin-bottom:2.5rem}
.login-err{background:#fdf0f0;border:1px solid #f5c6c6;border-radius:2px;
  padding:.8rem 1rem;color:#a00;font-size:.95rem;margin-bottom:1rem}
.finput{width:100%;padding:1rem 1.1rem;border:2px solid rgba(107,30,60,.2);border-radius:2px;
  font-family:'Cormorant Garamond',serif;font-size:1.05rem;color:var(--dark);
  transition:border-color .25s;margin-bottom:1.2rem;background:white}
.finput:focus{outline:none;border-color:var(--burg);box-shadow:0 0 0 3px rgba(107,30,60,.08)}

/* â”€â”€ HEADER â”€â”€ */
.header{background:linear-gradient(135deg,var(--burg),var(--deep));color:var(--cream);
  padding:2.5rem 2rem;position:relative;overflow:hidden}
.header::before{content:'';position:absolute;inset:0;
  background:repeating-linear-gradient(45deg,transparent,transparent 35px,rgba(255,255,255,.03) 35px,rgba(255,255,255,.03) 70px),
             repeating-linear-gradient(-45deg,transparent,transparent 35px,rgba(255,255,255,.03) 35px,rgba(255,255,255,.03) 70px);
  pointer-events:none}
.header-inner{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;position:relative;z-index:2}
.logo{font-family:'Playfair Display',serif;font-size:2.8rem;font-weight:900;letter-spacing:-.02em}
.logo span{color:var(--gold);font-style:italic}
.tagline{font-size:1rem;opacity:.8;font-weight:300}
.logout-btn{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:white;
  font-family:'Playfair Display',serif;font-size:.9rem;padding:.6rem 1.4rem;border-radius:2px;
  cursor:pointer;transition:all .25s}
.logout-btn:hover{background:rgba(255,255,255,.25)}

/* â”€â”€ NAV â”€â”€ */
.nav-bar{background:white;box-shadow:0 4px 20px rgba(107,30,60,.1);position:sticky;top:0;z-index:100}
.nav-inner{max-width:1400px;margin:0 auto;display:flex}
.nav-btn{flex:1;max-width:300px;padding:1.4rem 2rem;border:none;background:transparent;
  font-family:'Playfair Display',serif;font-size:1.05rem;font-weight:600;color:var(--burg);
  cursor:pointer;transition:all .35s;position:relative;border-bottom:3px solid transparent}
.nav-btn::after{content:'';position:absolute;bottom:0;left:50%;width:0;height:3px;
  background:var(--gold);transform:translateX(-50%);transition:width .35s}
.nav-btn:hover::after,.nav-btn.active::after{width:100%}
.nav-btn.active{color:var(--deep);background:linear-gradient(to bottom,rgba(201,169,97,.1),transparent)}

/* â”€â”€ MAIN â”€â”€ */
.main{max-width:1400px;margin:0 auto;padding:3rem 2rem;animation:fadeIn .5s}

/* â”€â”€ CARD â”€â”€ */
.card{background:white;border-radius:2px;padding:2.5rem;margin-bottom:2rem;
  box-shadow:0 2px 4px rgba(107,30,60,.08),0 8px 16px rgba(107,30,60,.06),inset 0 0 0 1px rgba(107,30,60,.1);
  transition:transform .3s,box-shadow .3s;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,transparent,rgba(201,169,97,.03));pointer-events:none}
.card-header{display:flex;justify-content:space-between;align-items:center;
  margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:1px solid rgba(107,30,60,.1)}
.card-title{font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;color:var(--burg)}

/* â”€â”€ BOUTONS â”€â”€ */
.btn{padding:1rem 2.5rem;border:none;border-radius:2px;font-family:'Playfair Display',serif;
  font-size:1rem;font-weight:600;letter-spacing:.04em;cursor:pointer;
  transition:all .3s;text-transform:uppercase;position:relative;overflow:hidden}
.btn-primary{background:linear-gradient(135deg,var(--burg),var(--deep));color:white;
  box-shadow:0 4px 16px rgba(107,30,60,.3)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(107,30,60,.4)}
.btn-success{background:linear-gradient(135deg,var(--sage),#6b8a5e);color:white;
  box-shadow:0 4px 16px rgba(139,154,126,.3)}
.btn-gold{background:linear-gradient(135deg,var(--gold),#b89451);color:var(--deep);
  box-shadow:0 4px 16px rgba(201,169,97,.4)}
.btn-secondary{background:#e8e4dc;color:var(--dark)}
.btn-secondary:hover{background:#ddd8cf}
.btn-danger-confirm{background:linear-gradient(135deg,#c0392b,#8B1A1A);color:white;
  box-shadow:0 4px 12px rgba(192,57,43,.3)}
.btn-sm{padding:.65rem 1.4rem;font-size:.85rem}

/* â”€â”€ BADGES â”€â”€ */
.badge{display:inline-block;padding:.4rem 1rem;border-radius:2px;font-size:.82rem;
  font-weight:600;letter-spacing:.05em;text-transform:uppercase}
.badge-success{background:linear-gradient(135deg,var(--sage),#6b8a5e);color:white}
.badge-warning{background:linear-gradient(135deg,var(--terra),#b56a4e);color:white}

/* â”€â”€ INFO ITEMS â”€â”€ */
.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.2rem;margin-top:1.5rem}
.info-item{padding:1.2rem 1.4rem;background:linear-gradient(135deg,rgba(107,30,60,.03),rgba(201,169,97,.03));
  border-left:3px solid var(--burg);border-radius:2px}
.lbl{font-size:.85rem;text-transform:uppercase;letter-spacing:.1em;color:var(--burg);font-weight:600;margin-bottom:.4rem}
.val{font-family:'Playfair Display',serif;font-size:1.25rem;color:var(--dark);font-weight:600}

/* â”€â”€ GROUPEMENT ROW â”€â”€ */
.glist{display:flex;flex-direction:column;gap:1rem}
.grow{display:flex;align-items:stretch;border:1px solid rgba(107,30,60,.12);border-radius:4px;overflow:hidden}
.gcell{flex:1;padding:1.3rem 1.5rem;border-right:1px solid rgba(107,30,60,.1);min-width:0}
.gcell:last-child{border-right:none}
.gcell--name{flex:1.4;background:linear-gradient(135deg,rgba(107,30,60,.03),transparent)}
.gcell--parts{flex:.9}.gcell--nb{flex:.8}
.gcell--actions{flex:0 0 auto;display:flex;flex-direction:column;gap:.6rem;
  padding:1.1rem 1.4rem;background:rgba(248,245,239,.6);align-items:stretch}
.gnom{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:700;color:var(--deep)}
.gdate{font-size:.82rem;color:#999;font-style:italic;margin-top:.2rem}
.parts-sub{font-size:.82rem;color:#999;font-weight:400;margin-left:.3rem}

/* â”€â”€ MODAL â”€â”€ */
.backdrop{position:fixed;inset:0;background:rgba(44,24,16,.55);z-index:500;
  display:flex;align-items:center;justify-content:center;padding:1.5rem;animation:fadeIn .2s}
.mbox{background:white;border-radius:4px;width:100%;max-width:700px;
  max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(107,30,60,.35)}
.mbox--sm{max-width:480px}
.mhead{background:linear-gradient(135deg,var(--burg),var(--deep));color:white;
  padding:1.6rem 2rem;display:flex;justify-content:space-between;align-items:center}
.mhead--danger{background:linear-gradient(135deg,#8B1A1A,#c0392b)}
.mtitle{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700}
.mclose{background:none;border:none;color:white;font-size:1.3rem;cursor:pointer;opacity:.8}
.mclose:hover{opacity:1}
.mbody{padding:2rem}
.mfoot{padding:1.4rem 2rem;border-top:1px solid rgba(107,30,60,.1);
  display:flex;justify-content:flex-end;gap:1rem;background:rgba(248,245,239,.5)}
.mfoot--between{justify-content:space-between}
.form2{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem}
.fg{display:flex;flex-direction:column;gap:.5rem;margin-bottom:1.4rem}
.flbl{font-family:'Playfair Display',serif;font-size:.9rem;font-weight:600;
  color:var(--burg);text-transform:uppercase;letter-spacing:.05em}
select.finput,textarea.finput{background:white;cursor:pointer;resize:vertical}
.danger-icon{font-size:3rem;text-align:center;margin:1rem 0}
.danger-msg{text-align:center;font-size:1.1rem;line-height:1.6;margin-bottom:.8rem}
.danger-sub{text-align:center;font-size:.92rem;color:#888;line-height:1.5}
.confirm-box{background:#fdf0f0;border:1px solid #f5c6c6;border-radius:4px;padding:1rem;margin-top:1.2rem}
.btn-del-outline{background:none;border:2px solid #c0392b;color:#c0392b;
  font-family:'Playfair Display',serif;font-size:.85rem;font-weight:600;
  padding:.55rem 1.2rem;border-radius:2px;cursor:pointer;transition:all .25s}
.btn-del-outline:hover{background:#c0392b;color:white}

/* â”€â”€ FICHE â”€â”€ */
.fiche{animation:fadeIn .35s}
.breadcrumb{display:flex;align-items:center;gap:.8rem;margin-bottom:2rem;font-size:1rem;color:#888}
.bc-back{background:none;border:none;color:var(--burg);font-family:'Cormorant Garamond',serif;
  font-size:1rem;font-weight:600;cursor:pointer;padding:0;transition:opacity .2s}
.bc-back:hover{opacity:.7}
.fhead{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:2rem}
.ftitle{font-family:'Playfair Display',serif;font-size:2.6rem;font-weight:900;color:var(--deep)}
.fsub{font-size:.95rem;color:#999;font-style:italic;margin-top:.3rem}
.fhead-right{display:flex;align-items:center;gap:1rem}
.section-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem}
.section-title{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:var(--burg)}

/* â”€â”€ BOUTON SUPPRIMER GROUPEMENT â”€â”€ */
.btn-del-header{background:none;border:2px solid #c0392b;color:#c0392b;
  font-family:'Playfair Display',serif;font-size:.88rem;font-weight:600;
  padding:.5rem 1.1rem;border-radius:2px;cursor:pointer;transition:all .25s}
.btn-del-header:hover{background:#c0392b;color:white}

/* â”€â”€ TABLEAU ASSOCIÃ‰S â”€â”€ */
.twrap{overflow-x:auto;border:1px solid rgba(107,30,60,.1);border-radius:3px}
.tbl{width:100%;border-collapse:collapse;font-size:.92rem}
.tbl th{background:linear-gradient(to bottom,var(--burg),var(--deep));color:var(--cream);
  padding:.85rem 1rem;text-align:left;font-family:'Playfair Display',serif;
  font-size:.82rem;text-transform:uppercase;letter-spacing:.06em;white-space:nowrap}
.tbl td{padding:.8rem 1rem;border-bottom:1px solid rgba(107,30,60,.07);vertical-align:middle}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:rgba(248,245,239,.7)}
.row-off td{opacity:.45}
.td-b{font-weight:700;color:var(--deep)}
.td-c{text-align:center;font-weight:600}
.td-sm{font-size:.85rem;color:#666;max-width:180px}
.td-link{color:var(--burg);text-decoration:none;font-size:.85rem}
.td-link:hover{text-decoration:underline}
.td-nw{white-space:nowrap}
.etat{display:inline-block;padding:.25rem .8rem;border-radius:2px;font-size:.78rem;font-weight:700;text-transform:capitalize}
.etat-bernard{background:rgba(201,169,97,.2);color:#7a5a10}
.etat-vigneron{background:rgba(107,30,60,.12);color:var(--deep)}
.edit-btn{background:none;border:none;font-size:.95rem;cursor:pointer;
  padding:.25rem .45rem;border-radius:3px;opacity:.55;transition:all .2s}
.edit-btn:hover{background:rgba(107,30,60,.08);opacity:1}

/* â”€â”€ LIEN ASSOCIÃ‰ â”€â”€ */
.link-box{display:flex;align-items:center;gap:.8rem;margin-top:.5rem}
.link-input{flex:1;padding:.5rem .8rem;border:1px solid rgba(107,30,60,.2);border-radius:2px;
  font-size:.82rem;color:#555;background:#fafafa;font-family:'Cormorant Garamond',serif}
.copy-btn{background:var(--burg);color:white;border:none;padding:.5rem 1rem;
  border-radius:2px;cursor:pointer;font-size:.82rem;font-weight:600;transition:all .2s;white-space:nowrap}
.copy-btn:hover{background:var(--deep)}
.copy-ok{color:var(--sage);font-size:.82rem;font-weight:600}

/* â”€â”€ COMMENTAIRE â”€â”€ */
.comment-area{width:100%;padding:1rem 1.2rem;border:2px solid rgba(107,30,60,.15);border-radius:2px;
  font-family:'Cormorant Garamond',serif;font-size:1.05rem;color:var(--dark);
  resize:vertical;min-height:110px;transition:border-color .25s;margin-top:1rem}
.comment-area:focus{outline:none;border-color:var(--burg);box-shadow:0 0 0 3px rgba(107,30,60,.07)}
.save-ok{color:var(--sage);font-weight:600;font-size:.95rem}

/* â”€â”€ DOCS â”€â”€ */
.doc-row{display:flex;align-items:center;gap:1rem;padding:.9rem 0;border-bottom:1px solid rgba(107,30,60,.07)}
.doc-row:last-child{border-bottom:none}
.doc-icon{font-size:1.4rem;flex-shrink:0}
.doc-info{flex:1;min-width:0}
.doc-name{font-weight:600;color:var(--dark);font-size:.95rem}
.doc-date{font-size:.82rem;color:#999;margin-top:.15rem}
.btn-link{color:var(--burg);font-weight:600;font-size:.85rem;text-decoration:none;
  border:1px solid rgba(107,30,60,.25);padding:.35rem .8rem;border-radius:2px;white-space:nowrap;transition:all .2s}
.btn-link:hover{background:var(--burg);color:white}

/* â”€â”€ CATALOGUES/COMMANDES â”€â”€ */
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:2rem;margin-bottom:2rem}
.annee-row{display:flex;align-items:flex-start;gap:1.5rem;padding:.9rem 0;border-bottom:1px solid rgba(107,30,60,.07)}
.annee-row:last-child{border-bottom:none}
.annee-lbl{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:700;color:var(--burg);min-width:50px}
.annee-links{display:flex;flex-direction:column;gap:.4rem}
.alink{font-size:.88rem;font-weight:600;text-decoration:none;padding:.3rem .8rem;border-radius:2px;transition:all .2s;display:inline-block}
.alink-cat{background:rgba(201,169,97,.15);color:#7a5a10;border:1px solid rgba(201,169,97,.4)}
.alink-cat:hover{background:var(--gold);color:var(--deep)}
.alink-cmd{background:rgba(107,30,60,.08);color:var(--burg);border:1px solid rgba(107,30,60,.2)}
.alink-cmd:hover{background:var(--burg);color:white}

/* â”€â”€ CATALOGUE STANDARD â”€â”€ */
.cat-tags{display:flex;flex-wrap:wrap;gap:.6rem;margin:1.2rem 0 1.4rem}
.ctag{display:flex;align-items:center;gap:.45rem;background:rgba(201,169,97,.15);
  border:1px solid rgba(201,169,97,.5);border-radius:2px;padding:.4rem .8rem .4rem 1rem;
  font-size:.92rem;font-weight:500;color:#6b4c10}
.ctag:hover{background:rgba(201,169,97,.25)}
.ctag-rm{background:none;border:none;cursor:pointer;color:#b89451;font-size:1rem;font-weight:700;transition:color .2s}
.ctag-rm:hover{color:#c0392b}
.cat-add{display:flex;gap:.8rem;align-items:center;margin-top:.5rem}
.cat-add .finput{flex:1;margin-bottom:0}

/* â”€â”€ LOADING â”€â”€ */
.loading{text-align:center;padding:4rem 2rem;font-size:1.3rem;color:var(--burg);
  font-family:'Playfair Display',serif}
.empty{text-align:center;color:#aaa;font-style:italic;padding:1rem 0}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:2rem;right:2rem;background:white;border-left:4px solid var(--sage);
  padding:1rem 1.5rem;border-radius:2px;box-shadow:0 8px 24px rgba(0,0,0,.15);
  font-size:1rem;font-weight:600;color:var(--dark);z-index:9000;animation:slideUp .3s}
.toast-err{border-color:#c0392b;color:#c0392b}

/* â”€â”€ ANIMATIONS â”€â”€ */
@keyframes fadeIn{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeInDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:900px){.two-col{grid-template-columns:1fr}.form2{grid-template-columns:1fr}}
@media(max-width:700px){
  .grow{flex-direction:column}
  .gcell{border-right:none;border-bottom:1px solid rgba(107,30,60,.08)}
  .gcell--actions{flex-direction:row}
}
</style>
</head>
<body>
<div class="grain"></div>

<!-- â•â• Ã‰CRAN DE CONNEXION â•â• -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo"><span>GFA</span> Manager</div>
    <div class="login-sub">Espace Administrateur</div>
    <div id="login-err" class="login-err" style="display:none"></div>
    <div class="fg">
      <label class="flbl">Email</label>
      <input class="finput" id="l-email" type="email" placeholder="admin@votredomaine.fr" autocomplete="email">
    </div>
    <div class="fg">
      <label class="flbl">Mot de passe</label>
      <input class="finput" id="l-pwd" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
    </div>
    <button class="btn btn-primary" style="width:100%" id="l-btn">Se connecter</button>
  </div>
</div>

<!-- â•â• APP PRINCIPALE â•â• -->
<div id="app" style="display:none">
  <header class="header">
    <div class="header-inner">
      <div>
        <div class="logo"><span>GFA</span> Manager</div>
        <div class="tagline">Gestion des Groupements Fonciers Agricoles</div>
      </div>
      <button class="logout-btn" id="logout-btn">DÃ©connexion</button>
    </div>
  </header>
  <nav class="nav-bar">
    <div class="nav-inner">
      <button class="nav-btn active" data-tab="admin">Administration</button>
      <button class="nav-btn" data-tab="campagnes">Campagnes</button>
      <button class="nav-btn" data-tab="associes">Vue AssociÃ©s</button>
    </div>
  </nav>
  <main class="main" id="main-content">
    <div class="loading">Chargementâ€¦</div>
  </main>
</div>

<!-- â•â• CONTENEUR MODAUX â•â• -->
<div id="modals"></div>
<!-- â•â• TOAST â•â• -->
<div id="toast" style="display:none"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ã‰TAT GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATE = {
  user: null,
  groupements: [],
  campagnes: [],
  ficheId: null,
  campagneId: null,
  activeTab: 'admin',
};

const CATALOGUE_STD_DEFAULT = [
  "Bourgogne AligotÃ©","Bourgogne Chardonnay","Bourgogne Pinot Noir",
  "Haute CÃ´te de Beaune Rouge","Haute CÃ´te de Beaune Blanc",
  "CÃ´te de Beaune Village","Beaune Premier Cru",
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITAIRES UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function $(id){ return document.getElementById(id); }
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){
    if(k==='class') e.className=v;
    else if(k.startsWith('on')) e.addEventListener(k.slice(2).toLowerCase(),v);
    else e.setAttribute(k,v);
  }
  children.forEach(c=>{ if(c!=null) e.append(typeof c==='string'?document.createTextNode(c):c); });
  return e;
}
function html(tag, content, cls=''){
  const e = document.createElement(tag);
  e.className=cls; e.innerHTML=content; return e;
}
function toast(msg, err=false){
  const t=$('toast'); t.textContent=msg; t.className='toast'+(err?' toast-err':'');
  t.style.display='block'; setTimeout(()=>t.style.display='none',3000);
}
function openModal(content){
  const wrap=document.createElement('div');
  wrap.className='backdrop';
  wrap.addEventListener('click',e=>{ if(e.target===wrap) closeModal(); });
  wrap.appendChild(content);
  $('modals').innerHTML=''; $('modals').appendChild(wrap);
}
function closeModal(){ $('modals').innerHTML=''; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('gfa:authchange', e => {
  STATE.user = e.detail;
  if(STATE.user){
    $('login-screen').style.display='none';
    $('app').style.display='block';
    loadAll();
  } else {
    $('login-screen').style.display='flex';
    $('app').style.display='none';
  }
});

$('l-btn').addEventListener('click', async () => {
  const email=$('l-email').value.trim(), pwd=$('l-pwd').value;
  if(!email||!pwd) return;
  $('l-btn').textContent='Connexionâ€¦'; $('l-btn').disabled=true;
  try {
    await window.GFA.signInWithEmailAndPassword(window.GFA.auth, email, pwd);
  } catch(err){
    $('login-err').textContent='Email ou mot de passe incorrect.';
    $('login-err').style.display='block';
  }
  $('l-btn').textContent='Se connecter'; $('l-btn').disabled=false;
});

$('l-pwd').addEventListener('keydown', e=>{ if(e.key==='Enter') $('l-btn').click(); });

$('logout-btn').addEventListener('click', () => window.GFA.signOut(window.GFA.auth));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    STATE.activeTab=btn.dataset.tab;
    STATE.ficheId=null;
    render();
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHARGEMENT DONNÃ‰ES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAll(){
  $('main-content').innerHTML='<div class="loading">Chargementâ€¦</div>';
  
  // Charger groupements + associÃ©s
  STATE.groupements = await window.GFA.getGroupements();
  for(const g of STATE.groupements){
    g.associes = await window.GFA.getAssocies(g.id);
  }
  
  // Charger campagnes
  const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
  const campSnap = await getDocs(collection(window.GFA.db, 'campagnes'));
  STATE.campagnes = await Promise.all(campSnap.docs.map(async (doc) => {
    const data = {id:doc.id, ...doc.data()};
    // Compter vins et commandes
    const vinsSnap = await getDocs(collection(window.GFA.db, 'campagnes', doc.id, 'vins'));
    const cmdsSnap = await getDocs(collection(window.GFA.db, 'campagnes', doc.id, 'commandes'));
    data.nb_vins = vinsSnap.size;
    data.nb_commandes = cmdsSnap.size;
    return data;
  }));
  STATE.campagnes.sort((a,b)=>(b.annee||0)-(a.annee||0));
  
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER PRINCIPAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  const mc=$('main-content');
  mc.innerHTML='';
  if(STATE.activeTab==='admin'){
    if(STATE.ficheId){
      const g=STATE.groupements.find(x=>x.id===STATE.ficheId);
      if(g) mc.appendChild(renderFiche(g));
    } else {
      mc.appendChild(renderAdmin());
    }
  } else if(STATE.activeTab==='campagnes'){
    mc.appendChild(renderCampagnes());
  } else {
    mc.appendChild(renderAllAssocies());
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VUE ADMIN â€” LISTE GROUPEMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAdmin(){
  const wrap=el('div');
  const card=el('div',{class:'card'});
  const hdr=el('div',{class:'card-header'});
  hdr.appendChild(html('h2','Groupements Actifs','card-title'));
  const btnWrap=el('div',{style:'display:flex;gap:.8rem'});
  btnWrap.appendChild(el('button',{class:'btn btn-primary',onClick:()=>openModalNouvelleCampagne()},'+ Nouvelle Campagne'));
  btnWrap.appendChild(el('button',{class:'btn btn-gold',onClick:()=>openModalGroupement()},'+ Nouveau Groupement'));
  hdr.appendChild(btnWrap);
  card.appendChild(hdr);

  const list=el('div',{class:'glist'});
  if(STATE.groupements.length===0){
    list.appendChild(html('p','Aucun groupement. Cliquez sur "+ Nouveau Groupement" pour commencer.','empty'));
  } else {
    STATE.groupements.forEach(g=>list.appendChild(renderGroupementRow(g)));
  }
  card.appendChild(list);
  wrap.appendChild(card);
  return wrap;
}

function renderGroupementRow(g){
  const row=el('div',{class:'grow'});

  const name=el('div',{class:'gcell gcell--name'});
  name.appendChild(html('div','Groupement','lbl'));
  name.appendChild(html('div',esc(g.nom),'gnom'));
  name.appendChild(html('div',g.date_creation?'CrÃ©Ã© le '+esc(g.date_creation):'','gdate'));
  row.appendChild(name);

  const vig=el('div',{class:'gcell'});
  vig.appendChild(html('div','Vigneron','lbl'));
  vig.appendChild(html('div',esc(g.vigneron),'val'));
  row.appendChild(vig);

  const app=el('div',{class:'gcell'});
  app.appendChild(html('div','Appellation','lbl'));
  app.appendChild(html('div',esc(g.appellation),'val'));
  row.appendChild(app);

  const parts=el('div',{class:'gcell gcell--parts'});
  parts.appendChild(html('div','Parts totales','lbl'));
  parts.appendChild(html('div',
    `<span class="val">${g.nombre_total_parts||0}</span><span class="parts-sub">${g.parts_pour_bouteille||1} / bouteille</span>`
  ));
  row.appendChild(parts);

  const nb=el('div',{class:'gcell gcell--nb'});
  nb.appendChild(html('div','AssociÃ©s','lbl'));
  nb.appendChild(html('div',
    `<span class="val">${(g.associes||[]).length}</span>&nbsp;<span class="badge badge-success">Actif</span>`
  ));
  row.appendChild(nb);

  const actions=el('div',{class:'gcell gcell--actions'});
  actions.appendChild(el('button',{class:'btn btn-primary btn-sm',
    onClick:()=>{ STATE.ficheId=g.id; render(); }},'Voir DÃ©tails'));
  row.appendChild(actions);
  return row;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VUE FICHE GROUPEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFiche(g){
  const wrap=el('div',{class:'fiche'});

  // Breadcrumb
  const bc=el('div',{class:'breadcrumb'});
  bc.appendChild(el('button',{class:'bc-back',onClick:()=>{ STATE.ficheId=null; render(); }},'â† Retour aux groupements'));
  bc.appendChild(document.createTextNode(' / '));
  bc.appendChild(html('span',esc(g.nom)));
  wrap.appendChild(bc);

  // En-tÃªte
  const fhead=el('div',{class:'fhead'});
  const ftl=el('div');
  ftl.appendChild(html('h2',esc(g.nom),'ftitle'));
  ftl.appendChild(html('div',g.date_creation?'CrÃ©Ã© le '+esc(g.date_creation):'','fsub'));
  fhead.appendChild(ftl);
  const fhr=el('div',{class:'fhead-right'});
  fhr.appendChild(html('span',g.actif?'Actif':'Inactif','badge badge-success'));
  fhr.appendChild(el('button',{class:'btn-del-header',
    onClick:()=>openConfirmSupprimerGroupement(g)},'ğŸ—‘ Supprimer'));
  fhead.appendChild(fhr);
  wrap.appendChild(fhead);

  // Infos
  const cardInfo=el('div',{class:'card'});
  cardInfo.appendChild(html('h3','Informations du groupement','section-title'));
  const igrid=el('div',{class:'info-grid',style:'margin-top:1.5rem'});
  [[g.vigneron,'Vigneron'],[g.appellation,'Appellation'],
   [`${g.nombre_total_parts||0} <span class="parts-sub">${g.parts_pour_bouteille||1} / bouteille</span>`,'Parts totales'],
   [`${(g.associes||[]).length} <span class="parts-sub">(${(g.associes||[]).filter(a=>a.actif).length} actifs)</span>`,'AssociÃ©s']
  ].forEach(([val,lbl])=>{
    const it=el('div',{class:'info-item'});
    it.appendChild(html('div',lbl,'lbl'));
    it.appendChild(html('div',val,'val'));
    igrid.appendChild(it);
  });
  cardInfo.appendChild(igrid);
  wrap.appendChild(cardInfo);

  // AssociÃ©s
  wrap.appendChild(renderTableAssocies(g));

  // Commentaire
  wrap.appendChild(renderCommentaire(g));

  // Catalogue standard
  wrap.appendChild(renderCatalogueStd(g));

  // Deux colonnes
  const two=el('div',{class:'two-col'});
  two.appendChild(renderDocuments(g));
  two.appendChild(renderAnnees(g));
  wrap.appendChild(two);
  return wrap;
}

// â”€â”€ Tableau AssociÃ©s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTableAssocies(g){
  const card=el('div',{class:'card'});
  const hdr=el('div',{class:'section-hdr'});
  hdr.appendChild(html('h3','AssociÃ©s','section-title'));
  hdr.appendChild(el('button',{class:'btn btn-gold btn-sm',
    onClick:()=>openModalAssocie(g, null)},'+  Ajouter un associÃ©'));
  card.appendChild(hdr);

  const twrap=el('div',{class:'twrap'});
  const tbl=el('table',{class:'tbl'});
  tbl.innerHTML=`<thead><tr>
    <th>Nom</th><th>PrÃ©nom</th><th>Parts</th><th>Adresse livraison</th>
    <th>Email</th><th>TÃ©lÃ©phone</th><th>Ã‰tat</th><th>Statut</th><th>Lien</th><th></th>
  </tr></thead>`;
  const tbody=el('tbody');
  (g.associes||[]).forEach(a=>{
    const tr=el('tr',{class:a.actif?'':'row-off'});
    const token=a.token||'';
    const lien=token?`${location.origin}/associe.html?token=${token}`:'';
    tr.innerHTML=`
      <td class="td-b">${esc(a.nom)}</td>
      <td>${esc(a.prenom)}</td>
      <td class="td-c">${a.parts||0}</td>
      <td class="td-sm">${esc(a.adresse||'')}</td>
      <td><a href="mailto:${esc(a.email)}" class="td-link">${esc(a.email||'')}</a></td>
      <td class="td-nw">${esc(a.tel||'')}</td>
      <td><span class="etat etat-${a.etat}">${esc(a.etat||'')}</span></td>
      <td><span class="badge ${a.actif?'badge-success':'badge-warning'}" style="font-size:.7rem;padding:.2rem .7rem">
        ${a.actif?'Actif':'Inactif'}</span></td>
      <td style="min-width:300px">
        ${lien?`
        <div class="link-box">
          <input class="link-input" value="${esc(lien)}" readonly id="link-${a.id}">
          <button class="copy-btn" data-aid="${a.id}" title="Copier le lien">ğŸ“‹</button>
          <button class="send-btn" data-aid="${a.id}" title="Envoyer par email">âœ‰ï¸</button>
        </div>`:'<span style="font-size:.82rem;color:#bbb;font-style:italic">â€”</span>'}
      </td>
      <td><button class="edit-btn" data-aid="${a.id}" title="Modifier">âœï¸</button></td>`;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
  twrap.appendChild(tbl);
  card.appendChild(twrap);

  // Events sur les boutons du tableau
  card.querySelectorAll('.edit-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const a=(g.associes||[]).find(x=>x.id===btn.dataset.aid);
      if(a) openModalAssocie(g,a);
    });
  });
  card.querySelectorAll('.copy-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const inp=$(`link-${btn.dataset.aid}`);
      if(inp){ inp.select(); navigator.clipboard.writeText(inp.value); toast('Lien copiÃ© !'); }
    });
  });
  card.querySelectorAll('.send-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const a=(g.associes||[]).find(x=>x.id===btn.dataset.aid);
      if(!a||!a.email){ toast('Cet associÃ© n\'a pas d\'adresse email.', true); return; }
      if(!a.token){ toast('Cet associÃ© n\'a pas encore de lien gÃ©nÃ©rÃ©.', true); return; }
      window.MAIL.ouvrirMailAssocie(a, g);
    });
  });
  return card;
}

// â”€â”€ Commentaire â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCommentaire(g){
  const card=el('div',{class:'card'});
  card.appendChild(html('h3','Commentaires','section-title'));
  const ta=el('textarea',{class:'comment-area',rows:'4',
    placeholder:'Ajoutez vos notes et commentaires sur ce groupementâ€¦'});
  ta.value=g.commentaire||'';
  card.appendChild(ta);
  const row=el('div',{style:'display:flex;align-items:center;gap:1rem;margin-top:1rem'});
  const ok=html('span','','save-ok');
  const btn=el('button',{class:'btn btn-primary btn-sm',onClick:async()=>{
    g.commentaire=ta.value;
    await window.GFA.saveGroupement(g);
    ok.textContent='âœ“ SauvegardÃ©'; setTimeout(()=>ok.textContent='',2500);
  }},'Enregistrer');
  row.appendChild(btn); row.appendChild(ok);
  card.appendChild(row);
  return card;
}

// â”€â”€ Catalogue standard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCatalogueStd(g){
  if(!g.catalogue_std) g.catalogue_std=[...CATALOGUE_STD_DEFAULT];
  const card=el('div',{class:'card'});
  const hdr=el('div',{class:'section-hdr'});
  hdr.appendChild(html('h3','Catalogue standard','section-title'));
  hdr.appendChild(html('span','Liste des appellations de rÃ©fÃ©rence','parts-sub'));
  card.appendChild(hdr);

  const tags=el('div',{class:'cat-tags'}); card.appendChild(tags);
  const renderTags=()=>{
    tags.innerHTML='';
    (g.catalogue_std||[]).forEach(app=>{
      const t=el('div',{class:'ctag'});
      t.appendChild(document.createTextNode(app));
      const rm=el('button',{class:'ctag-rm',title:'Retirer',onClick:async()=>{
        g.catalogue_std=g.catalogue_std.filter(x=>x!==app);
        await window.GFA.saveGroupement(g);
        renderTags();
      }},'Ã—');
      t.appendChild(rm); tags.appendChild(t);
    });
  };
  renderTags();

  const addRow=el('div',{class:'cat-add'});
  const inp=el('input',{class:'finput',placeholder:'Ajouter une appellationâ€¦'});
  const btn=el('button',{class:'btn btn-gold btn-sm',onClick:async()=>{
    const v=inp.value.trim();
    if(v&&!(g.catalogue_std||[]).includes(v)){
      if(!g.catalogue_std) g.catalogue_std=[];
      g.catalogue_std.push(v);
      await window.GFA.saveGroupement(g);
      inp.value=''; renderTags();
    }
  }},'+  Ajouter');
  inp.addEventListener('keydown',e=>{ if(e.key==='Enter') btn.click(); });
  addRow.appendChild(inp); addRow.appendChild(btn);
  card.appendChild(addRow);
  return card;
}

// â”€â”€ Documents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDocuments(g){
  const card=el('div',{class:'card'});
  const hdr=el('div',{class:'section-hdr'});
  hdr.appendChild(html('h3','Documents','section-title'));
  hdr.appendChild(el('button',{class:'btn btn-gold btn-sm'},'+ Ajouter'));
  card.appendChild(hdr);
  (g.documents||[]).forEach(d=>{
    const row=el('div',{class:'doc-row'});
    row.appendChild(html('span','ğŸ“„','doc-icon'));
    const info=el('div',{class:'doc-info'});
    info.appendChild(html('div',esc(d.nom),'doc-name'));
    info.appendChild(html('div',esc(d.date||''),'doc-date'));
    row.appendChild(info);
    row.appendChild(el('a',{href:d.url||'#',class:'btn-link',target:'_blank'},'TÃ©lÃ©charger'));
    card.appendChild(row);
  });
  if(!(g.documents||[]).length) card.appendChild(html('p','Aucun document','empty'));
  return card;
}

// â”€â”€ AnnÃ©es â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAnnees(g){
  const card=el('div',{class:'card'});
  card.appendChild(html('h3','Catalogues & Commandes par annÃ©e','section-title'));
  const cats=g.catalogues||[], cmds=g.commandes||[];
  const annees=[...new Set([...cats.map(x=>x.annee),...cmds.map(x=>x.annee)])].sort((a,b)=>b-a);
  if(!annees.length){ card.appendChild(html('p','Aucune annÃ©e','empty')); return card; }
  annees.forEach(annee=>{
    const row=el('div',{class:'annee-row'});
    row.appendChild(html('div',String(annee),'annee-lbl'));
    const links=el('div',{class:'annee-links'});
    const cat=cats.find(x=>x.annee===annee);
    const cmd=cmds.find(x=>x.annee===annee);
    if(cat) links.appendChild(el('a',{href:cat.url,class:'alink alink-cat',target:'_blank'},'ğŸ“‹ '+cat.label));
    if(cmd) links.appendChild(el('a',{href:cmd.url,class:'alink alink-cmd',target:'_blank'},'ğŸ›’ '+cmd.label));
    row.appendChild(links); card.appendChild(row);
  });
  return card;
}

// â”€â”€ Vue tous les associÃ©s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAllAssocies(){
  const wrap=el('div');
  STATE.groupements.forEach(g=>{
    const card=el('div',{class:'card'});
    card.appendChild(html('h3',esc(g.nom),'section-title'));
    card.appendChild(renderTableAssocies(g));
    wrap.appendChild(card);
  });
  if(!STATE.groupements.length) wrap.appendChild(html('p','Aucun groupement','empty'));
  return wrap;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL â€” NOUVEAU / MODIFIER GROUPEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModalGroupement(g=null){
  const isEdit=!!g;
  const box=el('div',{class:'mbox'});
  box.innerHTML=`
    <div class="mhead">
      <span class="mtitle">${isEdit?'Modifier le groupement':'Nouveau Groupement'}</span>
      <button class="mclose">âœ•</button>
    </div>
    <div class="mbody">
      <div class="form2">
        <div class="fg"><label class="flbl">Nom *</label>
          <input class="finput" id="mg-nom" value="${esc(g?.nom||'')}" placeholder="ex. Les Vignerons du Clos"></div>
        <div class="fg"><label class="flbl">Vigneron *</label>
          <input class="finput" id="mg-vig" value="${esc(g?.vigneron||'')}" placeholder="ex. Domaine Loic Durand"></div>
      </div>
      <div class="form2">
        <div class="fg"><label class="flbl">Appellation *</label>
          <input class="finput" id="mg-app" value="${esc(g?.appellation||'')}" placeholder="ex. Haute CÃ´te de Beaune"></div>
        <div class="fg"><label class="flbl">Date de crÃ©ation</label>
          <input class="finput" id="mg-date" value="${esc(g?.date_creation||'')}" placeholder="ex. 15 janvier 2024"></div>
      </div>
      <div class="form2">
        <div class="fg"><label class="flbl">Nombre total de parts *</label>
          <input class="finput" id="mg-parts" type="number" value="${g?.nombre_total_parts||''}" placeholder="120"></div>
        <div class="fg"><label class="flbl">Parts par bouteille *</label>
          <input class="finput" id="mg-ppb" type="number" value="${g?.parts_pour_bouteille||''}" placeholder="3"></div>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-secondary" id="mg-cancel">Annuler</button>
      <button class="btn btn-gold" id="mg-save">${isEdit?'Enregistrer':'CrÃ©er le groupement'}</button>
    </div>`;
  box.querySelector('.mclose').onclick=closeModal;
  box.querySelector('#mg-cancel').onclick=closeModal;
  box.querySelector('#mg-save').onclick=async()=>{
    const nom=box.querySelector('#mg-nom').value.trim();
    const vig=box.querySelector('#mg-vig').value.trim();
    const app=box.querySelector('#mg-app').value.trim();
    if(!nom||!vig||!app){ toast('Nom, vigneron et appellation requis.', true); return; }
    const data={ ...(g||{}), nom, vigneron:vig, appellation:app,
      date_creation:box.querySelector('#mg-date').value.trim(),
      nombre_total_parts:parseInt(box.querySelector('#mg-parts').value)||0,
      parts_pour_bouteille:parseInt(box.querySelector('#mg-ppb').value)||1,
      actif:true, documents:g?.documents||[], catalogues:g?.catalogues||[],
      commandes:g?.commandes||[], commentaire:g?.commentaire||'',
      catalogue_std:g?.catalogue_std||[...CATALOGUE_STD_DEFAULT] };
    const id=await window.GFA.saveGroupement(data);
    if(!data.id) data.id=id;
    closeModal(); await loadAll();
    toast(isEdit?'Groupement mis Ã  jour.':'Groupement crÃ©Ã©.');
  };
  openModal(box);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL â€” CONFIRM SUPPRESSION GROUPEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openConfirmSupprimerGroupement(g){
  const box=el('div',{class:'mbox mbox--sm'});
  box.innerHTML=`
    <div class="mhead mhead--danger">
      <span class="mtitle">Supprimer le groupement</span>
      <button class="mclose">âœ•</button>
    </div>
    <div class="mbody">
      <div class="danger-icon">âš ï¸</div>
      <p class="danger-msg">Vous Ãªtes sur le point de supprimer<br><strong>Â« ${esc(g.nom)} Â»</strong></p>
      <p class="danger-sub">Cette action est irrÃ©versible. Toutes les donnÃ©es seront perdues : associÃ©s, documents, catalogues et historique des commandes.</p>
    </div>
    <div class="mfoot">
      <button class="btn btn-secondary" id="ds-cancel">Annuler</button>
      <button class="btn btn-danger-confirm" id="ds-ok">Confirmer la suppression</button>
    </div>`;
  box.querySelector('.mclose').onclick=closeModal;
  box.querySelector('#ds-cancel').onclick=closeModal;
  box.querySelector('#ds-ok').onclick=async()=>{
    await window.GFA.deleteGroupement(g.id);
    STATE.ficheId=null; closeModal(); await loadAll();
    toast('Groupement supprimÃ©.');
  };
  openModal(box);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL â€” NOUVEAU / MODIFIER ASSOCIÃ‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModalAssocie(g, a=null){
  const isEdit=!!a;
  const box=el('div',{class:'mbox'});
  box.innerHTML=`
    <div class="mhead">
      <span class="mtitle">${isEdit?'Modifier l\'associÃ©':'Nouvel AssociÃ©'}</span>
      <button class="mclose">âœ•</button>
    </div>
    <div class="mbody">
      <div class="form2">
        <div class="fg"><label class="flbl">Nom *</label>
          <input class="finput" id="ma-nom" value="${esc(a?.nom||'')}"></div>
        <div class="fg"><label class="flbl">PrÃ©nom *</label>
          <input class="finput" id="ma-prenom" value="${esc(a?.prenom||'')}"></div>
      </div>
      <div class="form2">
        <div class="fg"><label class="flbl">Nombre de parts *</label>
          <input class="finput" id="ma-parts" type="number" value="${a?.parts||''}"></div>
        <div class="fg"><label class="flbl">TÃ©lÃ©phone</label>
          <input class="finput" id="ma-tel" value="${esc(a?.tel||'')}"></div>
      </div>
      <div class="fg"><label class="flbl">Adresse de livraison</label>
        <input class="finput" id="ma-adresse" value="${esc(a?.adresse||'')}"></div>
      <div class="fg"><label class="flbl">Email *</label>
        <input class="finput" id="ma-email" type="email" value="${esc(a?.email||'')}"></div>
      <div class="form2">
        <div class="fg"><label class="flbl">Ã‰tat</label>
          <select class="finput" id="ma-etat">
            <option value="bernard" ${(a?.etat||'bernard')==='bernard'?'selected':''}>Bernard</option>
            <option value="vigneron" ${a?.etat==='vigneron'?'selected':''}>Vigneron</option>
          </select></div>
        <div class="fg"><label class="flbl">Statut</label>
          <select class="finput" id="ma-actif">
            <option value="1" ${a?.actif!==false?'selected':''}>Actif</option>
            <option value="0" ${a?.actif===false?'selected':''}>Inactif</option>
          </select></div>
      </div>
      <div id="ma-confirm-del"></div>
    </div>
    <div class="mfoot ${isEdit?'mfoot--between':''}">
      ${isEdit?`<button class="btn-del-outline" id="ma-del">ğŸ—‘ Supprimer</button>`:''}
      <div style="display:flex;gap:1rem">
        <button class="btn btn-secondary" id="ma-cancel">Annuler</button>
        <button class="btn btn-gold" id="ma-save">Enregistrer</button>
      </div>
    </div>`;
  box.querySelector('.mclose').onclick=closeModal;
  box.querySelector('#ma-cancel').onclick=closeModal;

  if(isEdit){
    box.querySelector('#ma-del').onclick=()=>{
      const cd=box.querySelector('#ma-confirm-del');
      cd.innerHTML=`<div class="confirm-box">
        <p>Confirmer la suppression de <strong>${esc(a.prenom)} ${esc(a.nom)}</strong> ?</p>
        <div style="display:flex;gap:.8rem;margin-top:.8rem">
          <button class="btn btn-danger-confirm btn-sm" id="ma-del-ok">Oui, supprimer</button>
          <button class="btn btn-secondary btn-sm" id="ma-del-no">Annuler</button>
        </div></div>`;
      cd.querySelector('#ma-del-ok').onclick=async()=>{
        await window.GFA.deleteAssocie(g.id, a.id);
        g.associes=g.associes.filter(x=>x.id!==a.id);
        closeModal(); render(); toast('AssociÃ© supprimÃ©.');
      };
      cd.querySelector('#ma-del-no').onclick=()=>{ cd.innerHTML=''; };
    };
  }

  box.querySelector('#ma-save').onclick=async()=>{
    const nom=box.querySelector('#ma-nom').value.trim();
    const prenom=box.querySelector('#ma-prenom').value.trim();
    const email=box.querySelector('#ma-email').value.trim();
    if(!nom||!prenom||!email){ toast('Nom, prÃ©nom et email requis.', true); return; }
    const token=a?.token||window.GFA.genToken();
    const data={
      ...(a||{}), nom, prenom, email,
      parts:parseInt(box.querySelector('#ma-parts').value)||0,
      tel:box.querySelector('#ma-tel').value.trim(),
      adresse:box.querySelector('#ma-adresse').value.trim(),
      etat:box.querySelector('#ma-etat').value,
      actif:box.querySelector('#ma-actif').value==='1',
      token, groupement_id:g.id
    };
    const newId = await window.GFA.saveAssocie(g.id, data);
    if(!data.id) data.id = newId;
    if(!g.associes) g.associes = [];
    const idx = g.associes.findIndex(x => x.id === data.id);
    if(idx >= 0) g.associes[idx] = data; else g.associes.push(data);
    closeModal(); render();

    // Ã€ la crÃ©ation : ouvre directement le client mail avec le lien prÃ©-rempli
    if(!isEdit && data.email) {
      window.MAIL.ouvrirMailAssocie(data, g);
    } else {
      toast(isEdit ? 'AssociÃ© mis Ã  jour.' : 'AssociÃ© crÃ©Ã©.');
    }
  };
  openModal(box);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VUE CAMPAGNES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCampagnes(){
  const wrap=el('div');
  const card=el('div',{class:'card'});
  const hdr=el('div',{class:'card-header'});
  hdr.appendChild(html('h2','Campagnes','card-title'));
  hdr.appendChild(el('button',{class:'btn btn-gold',onClick:()=>openModalNouvelleCampagne()},'+ Nouvelle Campagne'));
  card.appendChild(hdr);

  if(!STATE.campagnes||!STATE.campagnes.length){
    card.appendChild(html('p','Aucune campagne. Cliquez sur "+ Nouvelle Campagne" pour en crÃ©er une.','empty'));
  } else {
    const list=el('div',{style:'display:flex;flex-direction:column;gap:1rem;margin-top:1.5rem'});
    STATE.campagnes.forEach(c=>{
      const ccard=el('div',{style:'border:1px solid rgba(107,30,60,.12);border-radius:4px;overflow:hidden'});
      const chead=el('div',{style:'display:flex;justify-content:space-between;align-items:center;padding:1.2rem 1.5rem;background:linear-gradient(135deg,rgba(107,30,60,.04),rgba(201,169,97,.04))'});
      const cleft=el('div');
      cleft.appendChild(html('div',`Campagne ${c.annee} â€” ${esc(c.vigneron)}`,'val',{style:'font-family:"Playfair Display",serif;font-size:1.3rem;font-weight:700;color:var(--burg)'}));
      cleft.appendChild(html('div',c.date_fin?`ClÃ´ture : ${c.date_fin}`:'','',{style:'font-size:.85rem;color:#888;margin-top:.2rem'}));
      chead.appendChild(cleft);
      const cright=el('div',{style:'display:flex;align-items:center;gap:.8rem'});
      cright.appendChild(html('span',c.actif?'Active':'ClÃ´turÃ©e',`badge ${c.actif?'badge-success':'badge-warning'}`));
      cright.appendChild(el('button',{class:'btn btn-primary btn-sm',onClick:()=>{ STATE.campagneId=c.id; STATE.activeTab='campagnes'; render(); }},'DÃ©tails'));
      chead.appendChild(cright);
      ccard.appendChild(chead);
      
      const cbody=el('div',{style:'padding:1rem 1.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem'});
      cbody.appendChild(html('div',`<div class="lbl">Vins au catalogue</div><div class="val">${c.nb_vins||0}</div>`,'info-item'));
      cbody.appendChild(html('div',`<div class="lbl">Commandes reÃ§ues</div><div class="val">${c.nb_commandes||0}</div>`,'info-item'));
      cbody.appendChild(html('div',`<div class="lbl">Prix rÃ©fÃ©rence</div><div class="val">${c.prix_bouteille_reference||'â€”'} â‚¬</div>`,'info-item'));
      ccard.appendChild(cbody);
      list.appendChild(ccard);
    });
    card.appendChild(list);
  }
  wrap.appendChild(card);
  return wrap;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL â€” NOUVELLE CAMPAGNE (sÃ©lection vigneron, agrÃ©gation groupements)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModalNouvelleCampagne() {
  const box = el('div', {class:'mbox'});
  const anneeActuelle = new Date().getFullYear();
  
  // Liste unique des vignerons depuis tous les groupements
  const vignerons = [...new Set(STATE.groupements.map(g=>g.vigneron).filter(Boolean))].sort();
  
  if(!vignerons.length){
    toast('CrÃ©ez d'abord un groupement avant de crÃ©er une campagne.',true);
    return;
  }

  box.innerHTML = `
    <div class="mhead">
      <span class="mtitle">Nouvelle Campagne</span>
      <button class="mclose">âœ•</button>
    </div>
    <div class="mbody">
      <div class="form2">
        <div class="fg"><label class="flbl">AnnÃ©e *</label>
          <input class="finput" id="nc-annee" type="number" value="${anneeActuelle}" required></div>
        <div class="fg"><label class="flbl">Date de clÃ´ture</label>
          <input class="finput" id="nc-fin" placeholder="ex. 15 mars ${anneeActuelle}"></div>
      </div>
      
      <div class="fg"><label class="flbl">Vigneron *</label>
        <select class="finput" id="nc-vigneron" required>
          <option value="">-- SÃ©lectionnez un vigneron --</option>
          ${vignerons.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join('')}
        </select>
      </div>
      
      <div class="fg"><label class="flbl">Prix de rÃ©fÃ©rence par bouteille (â‚¬)</label>
        <input class="finput" id="nc-prix-ref" type="number" step="0.01" placeholder="ex. 12.50"></div>
      
      <div id="nc-catalogue-zone" style="display:none;margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid rgba(107,30,60,.1)">
        <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;color:var(--burg);margin-bottom:.5rem">
          Catalogue des vins
        </div>
        <div id="nc-groupements-info" style="font-size:.88rem;color:#777;margin-bottom:1rem"></div>
        <div id="nc-vins-list" style="display:grid;gap:.8rem;max-height:300px;overflow-y:auto;padding-right:.5rem"></div>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-secondary" id="nc-cancel">Annuler</button>
      <button class="btn btn-gold" id="nc-create" disabled>CrÃ©er la campagne</button>
    </div>`;

  box.querySelector('.mclose').onclick = closeModal;
  box.querySelector('#nc-cancel').onclick = closeModal;

  // Changement de vigneron â†’ afficher les groupements + catalogue
  box.querySelector('#nc-vigneron').addEventListener('change', (e) => {
    const vigneron = e.target.value;
    const catalogueZone = box.querySelector('#nc-catalogue-zone');
    const createBtn = box.querySelector('#nc-create');
    
    if(!vigneron){
      catalogueZone.style.display='none';
      createBtn.disabled=true;
      return;
    }

    // Filtrer les groupements de ce vigneron
    const groupementsVigneron = STATE.groupements.filter(g=>g.vigneron===vigneron);
    
    // AgrÃ©ger tous les catalogues standards
    const toutesAppellations = [];
    groupementsVigneron.forEach(g=>{
      (g.catalogue_std||[]).forEach(app=>{
        if(!toutesAppellations.find(a=>a.nom===app)){
          toutesAppellations.push({nom:app, groupement_id:g.id, groupement_nom:g.nom});
        }
      });
    });

    // Afficher infos groupements
    const infoDiv = box.querySelector('#nc-groupements-info');
    infoDiv.textContent = `${groupementsVigneron.length} groupement(s) : ${groupementsVigneron.map(g=>g.nom).join(', ')}`;

    // Afficher liste vins
    const vinsDiv = box.querySelector('#nc-vins-list');
    if(!toutesAppellations.length){
      vinsDiv.innerHTML='<p style="color:#aaa;font-style:italic;font-size:.9rem">Aucune appellation dans les catalogues de ce vigneron.</p>';
    } else {
      vinsDiv.innerHTML = toutesAppellations.map(app=>`
        <div style="display:flex;align-items:center;gap:.8rem;padding:.7rem;background:rgba(248,245,239,.6);border-radius:2px">
          <div style="flex:1.5">
            <div style="font-weight:600;color:var(--dark)">${esc(app.nom)}</div>
            <div style="font-size:.8rem;color:#999">${esc(app.groupement_nom)}</div>
          </div>
          <div style="flex:1;display:flex;align-items:center;gap:.5rem">
            <input class="finput vin-prix" data-nom="${esc(app.nom)}" data-gid="${app.groupement_id}" type="number" step="0.01" 
              placeholder="Prix â‚¬" style="margin:0;flex:1">
            <input class="finput vin-stock" type="number" placeholder="Stock" 
              style="margin:0;width:90px" title="Stock limitÃ© (laisser vide = illimitÃ©)">
          </div>
        </div>
      `).join('');
    }

    catalogueZone.style.display='block';
    createBtn.disabled=false;
  });

  // Bouton crÃ©er
  box.querySelector('#nc-create').onclick = async () => {
    const annee     = parseInt(box.querySelector('#nc-annee').value) || anneeActuelle;
    const fin       = box.querySelector('#nc-fin').value.trim();
    const vigneron  = box.querySelector('#nc-vigneron').value;
    const prixRef   = parseFloat(box.querySelector('#nc-prix-ref').value) || null;
    const createBtn = box.querySelector('#nc-create');
    
    if(!vigneron){
      toast('Veuillez sÃ©lectionner un vigneron.',true);
      return;
    }

    // Collecter les vins
    const vins = [];
    box.querySelectorAll('.vin-prix').forEach(inp => {
      const prix = parseFloat(inp.value);
      const nom  = inp.dataset.nom;
      const gid  = inp.dataset.gid;
      const stock= inp.nextElementSibling?.value ? parseInt(inp.nextElementSibling.value) : null;
      if (prix && prix > 0) {
        vins.push({ nom, prix, stock, groupement_id:gid, description: '' });
      }
    });

    if (vins.length === 0) {
      toast('Veuillez indiquer au moins un prix pour crÃ©er la campagne.', true);
      return;
    }

    createBtn.textContent = 'CrÃ©ation en coursâ€¦';
    createBtn.disabled = true;

    try {
      const { db } = window.GFA;
      const { collection, doc, setDoc, addDoc, getDocs, updateDoc, query, where } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

      // CrÃ©er la campagne Ã  la racine
      const campagneRef = doc(collection(db, 'campagnes'));
      await setDoc(campagneRef, {
        annee,
        vigneron,
        actif: true,
        date_fin: fin,
        prix_bouteille_reference: prixRef,
        cree_le: new Date().toISOString()
      });

      // DÃ©sactiver les autres campagnes de ce vigneron
      const autresCampagnes = await getDocs(
        query(collection(db, 'campagnes'), where('vigneron', '==', vigneron), where('actif', '==', true))
      );
      for (const campDoc of autresCampagnes.docs) {
        if (campDoc.id !== campagneRef.id) {
          await updateDoc(doc(db, 'campagnes', campDoc.id), { actif: false });
        }
      }

      // CrÃ©er les vins
      for (const vin of vins) {
        await addDoc(collection(db, 'campagnes', campagneRef.id, 'vins'), {
          nom: vin.nom,
          prix: vin.prix,
          stock: vin.stock,
          groupement_id: vin.groupement_id,
          description: vin.description
        });
      }

      closeModal();
      toast(`Campagne ${annee} crÃ©Ã©e avec ${vins.length} vin${vins.length>1?'s':''}.`);
      setTimeout(() => location.reload(), 1500);

    } catch(err) {
      console.error(err);
      toast('Erreur lors de la crÃ©ation. VÃ©rifiez la console.', true);
      createBtn.textContent = 'CrÃ©er la campagne';
      createBtn.disabled = false;
    }
  };

  openModal(box);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL â€” ANCIENNE VERSION (sera supprimÃ©e)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModalNouvelleCampagne_OLD(g) {
  const box = el('div', {class:'mbox'});
  const anneeActuelle = new Date().getFullYear();
  const associesActifs = (g.associes||[]).filter(a=>a.actif&&a.email&&a.token);
  const catalogue = g.catalogue_std || [];

  box.innerHTML = `
    <div class="mhead">
      <span class="mtitle">Nouvelle Campagne â€” ${esc(g.nom)}</span>
      <button class="mclose">âœ•</button>
    </div>
    <div class="mbody">
      <div class="form2">
        <div class="fg"><label class="flbl">AnnÃ©e *</label>
          <input class="finput" id="nc-annee" type="number" value="${anneeActuelle}" required></div>
        <div class="fg"><label class="flbl">Date de clÃ´ture</label>
          <input class="finput" id="nc-fin" placeholder="ex. 15 mars ${anneeActuelle}"></div>
      </div>
      <div class="fg"><label class="flbl">Prix de rÃ©fÃ©rence par bouteille (â‚¬)</label>
        <input class="finput" id="nc-prix-ref" type="number" step="0.01" value="${g.prix_bouteille_reference||''}" placeholder="ex. 12.50"></div>
      
      <div style="margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid rgba(107,30,60,.1)">
        <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;color:var(--burg);margin-bottom:.8rem">
          Catalogue des vins
        </div>
        ${!catalogue.length ? `
          <p style="color:#aaa;font-style:italic;font-size:.9rem;margin-bottom:1rem">
            Aucune appellation dans le catalogue standard. Ajoutez-en dans la fiche du groupement, puis recrÃ©ez la campagne.
          </p>
        ` : `
          <div style="font-size:.88rem;color:#777;margin-bottom:1rem">
            Indiquez le prix pour chaque appellation. Laissez vide pour ne pas inclure ce vin dans la campagne.
          </div>
          <div style="display:grid;gap:.8rem;max-height:300px;overflow-y:auto;padding-right:.5rem">
            ${catalogue.map((app,i)=>`
              <div style="display:flex;align-items:center;gap:.8rem;padding:.7rem;background:rgba(248,245,239,.6);border-radius:2px">
                <div style="flex:1.5;font-weight:600;color:var(--dark)">${esc(app)}</div>
                <div style="flex:1;display:flex;align-items:center;gap:.5rem">
                  <input class="finput vin-prix" data-nom="${esc(app)}" type="number" step="0.01" 
                    placeholder="Prix â‚¬" style="margin:0;flex:1">
                  <input class="finput vin-stock" type="number" placeholder="Stock" 
                    style="margin:0;width:90px" title="Stock limitÃ© (laisser vide = illimitÃ©)">
                </div>
              </div>
            `).join('')}
          </div>
        `}
      </div>

      <div style="margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid rgba(107,30,60,.1)">
        <div style="font-family:'Playfair Display',serif;font-size:1rem;font-weight:600;color:var(--burg);margin-bottom:.8rem">
          Notifier les associÃ©s (${associesActifs.length})
        </div>
        <div style="font-size:.88rem;color:#777;margin-bottom:.8rem">
          Cliquez sur chaque associÃ© pour ouvrir un email prÃ©-rempli avec son lien personnel.
        </div>
        <div id="nc-assoc-list" style="display:flex;flex-direction:column;gap:.5rem;max-height:200px;overflow-y:auto">
          ${associesActifs.map(a=>`
            <div style="display:flex;align-items:center;justify-content:space-between;
              padding:.6rem 1rem;border:1px solid rgba(107,30,60,.12);border-radius:3px;
              background:rgba(248,245,239,.6)">
              <span style="font-size:.9rem"><strong>${esc(a.prenom)} ${esc(a.nom)}</strong>
                <span style="color:#999;font-size:.82rem;margin-left:.5rem">${esc(a.email)}</span>
              </span>
              <button class="nc-mail-btn btn btn-gold btn-sm" data-aid="${a.id}" style="flex-shrink:0">
                âœ‰ï¸ Envoyer
              </button>
            </div>`).join('')}
          ${!associesActifs.length ? '<p style="color:#aaa;font-style:italic;font-size:.85rem">Aucun associÃ© actif.</p>' : ''}
        </div>
      </div>
    </div>
    <div class="mfoot" style="justify-content:space-between">
      <button class="btn btn-secondary" id="nc-cancel">Annuler</button>
      <div style="display:flex;gap:.8rem">
        ${associesActifs.length > 1 ? `<button class="btn btn-primary" id="nc-all">âœ‰ï¸ Envoyer Ã  tous</button>` : ''}
        <button class="btn btn-gold" id="nc-create">CrÃ©er la campagne</button>
      </div>
    </div>`;

  box.querySelector('.mclose').onclick = closeModal;
  box.querySelector('#nc-cancel').onclick = closeModal;

  // Bouton crÃ©er campagne
  box.querySelector('#nc-create').onclick = async () => {
    const annee   = parseInt(box.querySelector('#nc-annee').value) || anneeActuelle;
    const fin     = box.querySelector('#nc-fin').value.trim();
    const prixRef = parseFloat(box.querySelector('#nc-prix-ref').value) || null;
    const createBtn = box.querySelector('#nc-create');
    
    // Collecter les vins avec prix
    const vins = [];
    box.querySelectorAll('.vin-prix').forEach(inp => {
      const prix  = parseFloat(inp.value);
      const nom   = inp.dataset.nom;
      const stock = inp.nextElementSibling?.value ? parseInt(inp.nextElementSibling.value) : null;
      if (prix && prix > 0) {
        vins.push({ nom, prix, stock, description: '' });
      }
    });

    if (vins.length === 0) {
      toast('Veuillez indiquer au moins un prix pour crÃ©er la campagne.', true);
      return;
    }

    createBtn.textContent = 'CrÃ©ation en coursâ€¦';
    createBtn.disabled = true;

    try {
      const { db } = window.GFA;
      const { collection, doc, setDoc, addDoc, getDocs, updateDoc, query, where } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

      // 1. Sauvegarder prix de rÃ©fÃ©rence si fourni
      if (prixRef) {
        g.prix_bouteille_reference = prixRef;
        await window.GFA.saveGroupement(g);
      }

      // 2. CrÃ©er la campagne
      const campagneRef = doc(collection(db, 'groupements', g.id, 'campagnes'));
      await setDoc(campagneRef, {
        annee,
        actif: true,
        date_fin: fin,
        prix_bouteille_reference: prixRef,
        cree_le: new Date().toISOString()
      });

      // DÃ©sactiver les autres campagnes actives du groupement
      const autresCampagnes = await getDocs(
        query(collection(db, 'groupements', g.id, 'campagnes'), where('actif', '==', true))
      );
      for (const campDoc of autresCampagnes.docs) {
        if (campDoc.id !== campagneRef.id) {
          await updateDoc(doc(db, 'groupements', g.id, 'campagnes', campDoc.id), { actif: false });
        }
      }

      // 3. CrÃ©er les vins dans la sous-collection
      for (const vin of vins) {
        await addDoc(collection(db, 'groupements', g.id, 'campagnes', campagneRef.id, 'vins'), {
          nom: vin.nom,
          prix: vin.prix,
          stock: vin.stock,
          description: vin.description
        });
      }

      closeModal();
      toast(`Campagne ${annee} crÃ©Ã©e avec ${vins.length} vin${vins.length>1?'s':''}.`);
      
      // Recharger pour afficher la nouvelle campagne
      setTimeout(() => location.reload(), 1500);

    } catch(err) {
      console.error(err);
      toast('Erreur lors de la crÃ©ation. VÃ©rifiez la console.', true);
      createBtn.textContent = 'CrÃ©er la campagne';
      createBtn.disabled = false;
    }
  };

  // Boutons email individuels
  box.querySelectorAll('.nc-mail-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const a = associesActifs.find(x => x.id === btn.dataset.aid);
      if (!a) return;
      const annee = parseInt(box.querySelector('#nc-annee').value) || anneeActuelle;
      const fin   = box.querySelector('#nc-fin').value.trim();
      window.MAIL.ouvrirMailCampagne(a, g, annee, fin);
    });
  });

  // Bouton "envoyer Ã  tous"
  const btnAll = box.querySelector('#nc-all');
  if (btnAll) {
    btnAll.addEventListener('click', async () => {
      const annee = parseInt(box.querySelector('#nc-annee').value) || anneeActuelle;
      const fin   = box.querySelector('#nc-fin').value.trim();
      btnAll.textContent = 'Ouverture des emailsâ€¦';
      btnAll.disabled = true;
      
      for (let i = 0; i < associesActifs.length; i++) {
        const a     = associesActifs[i];
        const lien  = `${location.origin}/associe.html?token=${a.token}`;
        const ppb   = g.parts_pour_bouteille || 1;
        const prix  = g.prix_bouteille_reference || 0;
        const creds = ((a.parts || 0) / ppb * prix).toFixed(2);
        const sujet = encodeURIComponent(`ğŸ· Campagne GFA ${annee} â€” Passez votre commande`);
        const corps = encodeURIComponent(
`Bonjour ${a.prenom},

La campagne ${annee} est ouverte pour le groupement "${g.nom}".

Vos crÃ©dits disponibles : ${creds} â‚¬${fin ? `\nDate limite : ${fin}` : ''}

Votre espace de commande :
${lien}

Cordialement`);
        window.open(`mailto:${a.email}?subject=${sujet}&body=${corps}`, '_blank');
        await new Promise(r => setTimeout(r, 600));
      }
      
      btnAll.textContent = `âœ“ ${associesActifs.length} email(s) prÃ©parÃ©s`;
    });
  }

  openModal(box);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>
