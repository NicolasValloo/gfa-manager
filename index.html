<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GFA Manager ‚Äî Administration</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Cormorant+Garamond:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<script>
// ‚îÄ‚îÄ Ouvre le client mail avec texte pr√©-rempli (associ√© individuel) ‚îÄ‚îÄ
function ouvrirMailAssocie(associe, groupement) {
  const lien = `${location.origin}/associe.html?token=${associe.token}`;
  const sujet = encodeURIComponent(
    `Votre acc√®s GFA Manager ‚Äî ${groupement.nom}`
  );
  const corps = encodeURIComponent(
`Bonjour ${associe.prenom},

Vous √™tes associ√©(e) au groupement "${groupement.nom}" (${groupement.vigneron || ''}).

Retrouvez votre espace personnel ‚Äî informations, cr√©dits et commandes ‚Äî via le lien ci-dessous :

${lien}

Ce lien vous est personnel. Conservez-le pr√©cieusement.

Cordialement`
  );
  window.location.href = `mailto:${associe.email}?subject=${sujet}&body=${corps}`;
}

// ‚îÄ‚îÄ Ouvre le client mail pour une campagne (associ√© individuel) ‚îÄ‚îÄ
function ouvrirMailCampagne(associe, groupement, annee, dateFin) {
  const lien  = `${location.origin}/associe.html?token=${associe.token}`;
  const ppb   = groupement.parts_pour_bouteille || 1;
  const prix  = groupement.prix_bouteille_reference || 0;
  const creds = ((associe.parts || 0) / ppb * prix).toFixed(2);
  const sujet = encodeURIComponent(
    `üç∑ Campagne GFA ${annee} ‚Äî Passez votre commande`
  );
  const corps = encodeURIComponent(
`Bonjour ${associe.prenom},

La campagne ${annee} est maintenant ouverte pour le groupement "${groupement.nom}".

Vos cr√©dits disponibles : ${creds} ‚Ç¨${dateFin ? `\nDate limite de commande : ${dateFin}` : ''}

Acc√©dez √† votre espace pour passer votre commande :

${lien}

Cordialement`
  );
  window.location.href = `mailto:${associe.email}?subject=${sujet}&body=${corps}`;
}

window.MAIL = { ouvrirMailAssocie, ouvrirMailCampagne };
</script>

<!-- ‚ïê‚ïê FIREBASE (v10 CDN) ‚ïê‚ïê -->
<script type="module">
import { initializeApp }                    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
                                            from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, doc, getDocs, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot }
                                            from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  ‚úÖ  CONFIGURATION FIREBASE ‚Äî Projet : gfa-manager-50a7f    ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
const firebaseConfig = {
  apiKey:            "AIzaSyB6MW35DPPsh59DoOEPVXml6FIvDNFgdI0",
  authDomain:        "gfa-manager-50a7f.firebaseapp.com",
  projectId:         "gfa-manager-50a7f",
  storageBucket:     "gfa-manager-50a7f.firebasestorage.app",
  messagingSenderId: "224596157977",
  appId:             "1:224596157977:web:c8d09907b8185010076c88"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

// ‚îÄ‚îÄ Utilitaires Firestore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getGroupements() {
  const snap = await getDocs(collection(db, "groupements"));
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}
async function saveGroupement(g) {
  if (g.id) {
    await updateDoc(doc(db, "groupements", g.id), g);
    return g.id;
  } else {
    const ref = await addDoc(collection(db, "groupements"), g);
    return ref.id;
  }
}
async function deleteGroupement(id) {
  await deleteDoc(doc(db, "groupements", id));
}
async function saveAssocie(groupementId, associe) {
  const ref = associe.id
    ? doc(db, "groupements", groupementId, "associes", associe.id)
    : doc(collection(db, "groupements", groupementId, "associes"));
  await setDoc(ref, associe);
  return ref.id;
}
async function deleteAssocie(groupementId, associeId) {
  await deleteDoc(doc(db, "groupements", groupementId, "associes", associeId));
}
async function getAssocies(groupementId) {
  const snap = await getDocs(collection(db, "groupements", groupementId, "associes"));
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

// ‚îÄ‚îÄ G√©n√©ration de token unique pour un associ√© ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function genToken() {
  return [...crypto.getRandomValues(new Uint8Array(24))].map(b=>b.toString(16).padStart(2,'0')).join('');
}

// ‚îÄ‚îÄ Exposer sur window pour les fonctions inline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.GFA = { auth, db, getGroupements, saveGroupement, deleteGroupement,
               saveAssocie, deleteAssocie, getAssocies, genToken,
               signInWithEmailAndPassword, onAuthStateChanged, signOut };

// ‚îÄ‚îÄ Helpers DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function $(id){ return document.getElementById(id); }

// ‚îÄ‚îÄ Amorcer l'app d√®s que Firebase est pr√™t ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onAuthStateChanged(auth, (user) => {
  document.dispatchEvent(new CustomEvent('gfa:authchange', { detail: user }));
});

// ‚îÄ‚îÄ Attacher les listeners une fois le DOM pr√™t ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
  // Listener changement d'√©tat auth
  document.addEventListener('gfa:authchange', e => {
    const user = e.detail;
    if(user){
      $('login-screen').style.display='none';
      $('app').style.display='block';
      // loadAll() sera appel√© depuis le script principal
      if(window.loadAll) window.loadAll();
    } else {
      $('login-screen').style.display='flex';
      $('app').style.display='none';
    }
  });

  // Bouton connexion
  const btnLogin = $('l-btn');
  if(btnLogin) {
    btnLogin.addEventListener('click', async () => {
      const email=$('l-email').value.trim(), pwd=$('l-pwd').value;
      if(!email||!pwd) return;
      btnLogin.textContent='Connexion‚Ä¶'; btnLogin.disabled=true;
      try {
        await signInWithEmailAndPassword(auth, email, pwd);
      } catch(err){
        console.error('Erreur de connexion:', err);
        $('login-err').textContent='Email ou mot de passe incorrect.';
        $('login-err').style.display='block';
      }
      btnLogin.textContent='Se connecter'; btnLogin.disabled=false;
    });
  }

  // Enter sur le champ password
  const pwdField = $('l-pwd');
  if(pwdField) {
    pwdField.addEventListener('keydown', e=>{ if(e.key==='Enter') btnLogin?.click(); });
  }

  // Bouton d√©connexion
  const btnLogout = $('logout-btn');
  if(btnLogout) {
    btnLogout.addEventListener('click', () => signOut(auth));
  }

  // Navigation tabs
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      if(window.STATE) {
        window.STATE.activeTab=btn.dataset.tab;
        window.STATE.ficheId=null;
      }
      if(window.render) window.render();
    });
  });
});
</script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --burg:#6B1E3C;--deep:#4A1228;--gold:#C9A961;
  --cream:#F8F5EF;--dark:#2C1810;--sage:#8B9A7E;--terra:#C67B5C;
}
body{font-family:'Cormorant Garamond',serif;background:var(--cream);color:var(--dark);overflow-x:hidden}

/* ‚îÄ‚îÄ GRAIN ‚îÄ‚îÄ */
.grain{position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:.03;
  background:url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='2.5' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
#login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,var(--burg),var(--deep))}
.login-box{background:white;border-radius:4px;padding:3rem;width:100%;max-width:440px;
  box-shadow:0 24px 64px rgba(0,0,0,.35);animation:fadeIn .5s}
.login-logo{font-family:'Playfair Display',serif;font-size:2.8rem;font-weight:900;
  color:var(--burg);text-align:center;margin-bottom:.3rem}
.login-logo span{color:var(--gold);font-style:italic}
.login-sub{text-align:center;color:#999;font-size:1rem;margin-bottom:2.5rem}
.login-err{background:#fdf0f0;border:1px solid #f5c6c6;border-radius:2px;
  padding:.8rem 1rem;color:#a00;font-size:.95rem;margin-bottom:1rem}
.finput{width:100%;padding:1rem 1.1rem;border:2px solid rgba(107,30,60,.2);border-radius:2px;
  font-family:'Cormorant Garamond',serif;font-size:1.05rem;color:var(--dark);
  transition:border-color .25s;margin-bottom:1.2rem;background:white}
.finput:focus{outline:none;border-color:var(--burg);box-shadow:0 0 0 3px rgba(107,30,60,.08)}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header{background:linear-gradient(135deg,var(--burg),var(--deep));color:var(--cream);
  padding:2.5rem 2rem;position:relative;overflow:hidden}
.header::before{content:'';position:absolute;inset:0;
  background:repeating-linear-gradient(45deg,transparent,transparent 35px,rgba(255,255,255,.03) 35px,rgba(255,255,255,.03) 70px),
             repeating-linear-gradient(-45deg,transparent,transparent 35px,rgba(255,255,255,.03) 35px,rgba(255,255,255,.03) 70px);
  pointer-events:none}
.header-inner{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;position:relative;z-index:2}
.logo{font-family:'Playfair Display',serif;font-size:2.8rem;font-weight:900;letter-spacing:-.02em}
.logo span{color:var(--gold);font-style:italic}
.tagline{font-size:1rem;opacity:.8;font-weight:300}
.logout-btn{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:white;
  font-family:'Playfair Display',serif;font-size:.9rem;padding:.6rem 1.4rem;border-radius:2px;
  cursor:pointer;transition:all .25s}
.logout-btn:hover{background:rgba(255,255,255,.25)}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
.nav-bar{background:white;box-shadow:0 4px 20px rgba(107,30,60,.1);position:sticky;top:0;z-index:100}
.nav-inner{max-width:1400px;margin:0 auto;display:flex}
.nav-btn{flex:1;max-width:300px;padding:1.4rem 2rem;border:none;background:transparent;
  font-family:'Playfair Display',serif;font-size:1.05rem;font-weight:600;color:var(--burg);
  cursor:pointer;transition:all .35s;position:relative;border-bottom:3px solid transparent}
.nav-btn::after{content:'';position:absolute;bottom:0;left:50%;width:0;height:3px;
  background:var(--gold);transform:translateX(-50%);transition:width .35s}
.nav-btn:hover::after,.nav-btn.active::after{width:100%}
.nav-btn.active{color:var(--deep);background:linear-gradient(to bottom,rgba(201,169,97,.1),transparent)}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{max-width:1400px;margin:0 auto;padding:3rem 2rem;animation:fadeIn .5s}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card{background:white;border-radius:2px;padding:2.5rem;margin-bottom:2rem;
  box-shadow:0 2px 4px rgba(107,30,60,.08),0 8px 16px rgba(107,30,60,.06),inset 0 0 0 1px rgba(107,30,60,.1);
  transition:transform .3s,box-shadow .3s;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,transparent,rgba(201,169,97,.03));pointer-events:none}
.card-header{display:flex;justify-content:space-between;align-items:center;
  margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:1px solid rgba(107,30,60,.1)}
.card-title{font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;color:var(--burg)}

/* ‚îÄ‚îÄ BOUTONS ‚îÄ‚îÄ */
.btn{padding:1rem 2.5rem;border:none;border-radius:2px;font-family:'Playfair Display',serif;
  font-size:1rem;font-weight:600;letter-spacing:.04em;cursor:pointer;
  transition:all .3s;text-transform:uppercase;position:relative;overflow:hidden}
.btn-primary{background:linear-gradient(135deg,var(--burg),var(--deep));color:white;
  box-shadow:0 4px 16px rgba(107,30,60,.3)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(107,30,60,.4)}
.btn-success{background:linear-gradient(135deg,var(--sage),#6b8a5e);color:white;
  box-shadow:0 4px 16px rgba(139,154,126,.3)}
.btn-gold{background:linear-gradient(135deg,var(--gold),#b89451);color:var(--deep);
  box-shadow:0 4px 16px rgba(201,169,97,.4)}
.btn-secondary{background:#e8e4dc;color:var(--dark)}
.btn-secondary:hover{background:#ddd8cf}
.btn-danger-confirm{background:linear-gradient(135deg,#c0392b,#8B1A1A);color:white;
  box-shadow:0 4px 12px rgba(192,57,43,.3)}
.btn-sm{padding:.65rem 1.4rem;font-size:.85rem}

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.badge{display:inline-block;padding:.4rem 1rem;border-radius:2px;font-size:.82rem;
  font-weight:600;letter-spacing:.05em;text-transform:uppercase}
.badge-success{background:linear-gradient(135deg,var(--sage),#6b8a5e);color:white}
.badge-warning{background:linear-gradient(135deg,var(--terra),#b56a4e);color:white}

/* ‚îÄ‚îÄ INFO ITEMS ‚îÄ‚îÄ */
.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.2rem;margin-top:1.5rem}
.info-item{padding:1.2rem 1.4rem;background:linear-gradient(135deg,rgba(107,30,60,.03),rgba(201,169,97,.03));
  border-left:3px solid var(--burg);border-radius:2px}
.lbl{font-size:.85rem;text-transform:uppercase;letter-spacing:.1em;color:var(--burg);font-weight:600;margin-bottom:.4rem}
.val{font-family:'Playfair Display',serif;font-size:1.25rem;color:var(--dark);font-weight:600}

/* ‚îÄ‚îÄ GROUPEMENT ROW ‚îÄ‚îÄ */
.glist{display:flex;flex-direction:column;gap:1rem}
.grow{display:flex;align-items:stretch;border:1px solid rgba(107,30,60,.12);border-radius:4px;overflow:hidden}
.gcell{flex:1;padding:1.3rem 1.5rem;border-right:1px solid rgba(107,30,60,.1);min-width:0}
.gcell:last-child{border-right:none}
.gcell--name{flex:1.4;background:linear-gradient(135deg,rgba(107,30,60,.03),transparent)}
.gcell--parts{flex:.9}.gcell--nb{flex:.8}
.gcell--actions{flex:0 0 auto;display:flex;flex-direction:column;gap:.6rem;
  padding:1.1rem 1.4rem;background:rgba(248,245,239,.6);align-items:stretch}
.gnom{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:700;color:var(--deep)}
.gdate{font-size:.82rem;color:#999;font-style:italic;margin-top:.2rem}
.parts-sub{font-size:.82rem;color:#999;font-weight:400;margin-left:.3rem}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.backdrop{position:fixed;inset:0;background:rgba(44,24,16,.55);z-index:500;
  display:flex;align-items:center;justify-content:center;padding:1.5rem;animation:fadeIn .2s}
.mbox{background:white;border-radius:4px;width:100%;max-width:700px;
  max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(107,30,60,.35)}
.mbox--sm{max-width:480px}
.mhead{background:linear-gradient(135deg,var(--burg),var(--deep));color:white;
  padding:1.6rem 2rem;display:flex;justify-content:space-between;align-items:center}
.mhead--danger{background:linear-gradient(135deg,#8B1A1A,#c0392b)}
.mtitle{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700}
.mclose{background:none;border:none;color:white;font-size:1.3rem;cursor:pointer;opacity:.8}
.mclose:hover{opacity:1}
.mbody{padding:2rem}
.mfoot{padding:1.4rem 2rem;border-top:1px solid rgba(107,30,60,.1);
  display:flex;justify-content:flex-end;gap:1rem;background:rgba(248,245,239,.5)}
.mfoot--between{justify-content:space-between}
.form2{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem}
.fg{display:flex;flex-direction:column;gap:.5rem;margin-bottom:1.4rem}
.flbl{font-family:'Playfair Display',serif;font-size:.9rem;font-weight:600;
  color:var(--burg);text-transform:uppercase;letter-spacing:.05em}
select.finput,textarea.finput{background:white;cursor:pointer;resize:vertical}
.danger-icon{font-size:3rem;text-align:center;margin:1rem 0}
.danger-msg{text-align:center;font-size:1.1rem;line-height:1.6;margin-bottom:.8rem}
.danger-sub{text-align:center;font-size:.92rem;color:#888;line-height:1.5}
.confirm-box{background:#fdf0f0;border:1px solid #f5c6c6;border-radius:4px;padding:1rem;margin-top:1.2rem}
.btn-del-outline{background:none;border:2px solid #c0392b;color:#c0392b;
  font-family:'Playfair Display',serif;font-size:.85rem;font-weight:600;
  padding:.55rem 1.2rem;border-radius:2px;cursor:pointer;transition:all .25s}
.btn-del-outline:hover{background:#c0392b;color:white}

/* ‚îÄ‚îÄ FICHE ‚îÄ‚îÄ */
.fiche{animation:fadeIn .35s}
.breadcrumb{display:flex;align-items:center;gap:.8rem;margin-bottom:2rem;font-size:1rem;color:#888}
.bc-back{background:none;border:none;color:var(--burg);font-family:'Cormorant Garamond',serif;
  font-size:1rem;font-weight:600;cursor:pointer;padding:0;transition:opacity .2s}
.bc-back:hover{opacity:.7}
.fhead{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:2rem}
.ftitle{font-family:'Playfair Display',serif;font-size:2.6rem;font-weight:900;color:var(--deep)}
.fsub{font-size:.95rem;color:#999;font-style:italic;margin-top:.3rem}
.fhead-right{display:flex;align-items:center;gap:1rem}
.section-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem}
.section-title{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:var(--burg)}

/* ‚îÄ‚îÄ BOUTON SUPPRIMER GROUPEMENT ‚îÄ‚îÄ */
.btn-del-header{background:none;border:2px solid #c0392b;color:#c0392b;
  font-family:'Playfair Display',serif;font-size:.88rem;font-weight:600;
  padding:.5rem 1.1rem;border-radius:2px;cursor:pointer;transition:all .25s}
.btn-del-header:hover{background:#c0392b;color:white}

/* ‚îÄ‚îÄ TABLEAU ASSOCI√âS ‚îÄ‚îÄ */
.twrap{overflow-x:auto;border:1px solid rgba(107,30,60,.1);border-radius:3px}
.tbl{width:100%;border-collapse:collapse;font-size:.92rem}
.tbl th{background:linear-gradient(to bottom,var(--burg),var(--deep));color:var(--cream);
  padding:.85rem 1rem;text-align:left;font-family:'Playfair Display',serif;
  font-size:.82rem;text-transform:uppercase;letter-spacing:.06em;white-space:nowrap}
.tbl td{padding:.8rem 1rem;border-bottom:1px solid rgba(107,30,60,.07);vertical-align:middle}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:rgba(248,245,239,.7)}
.row-off td{opacity:.45}
.td-b{font-weight:700;color:var(--deep)}
.td-c{text-align:center;font-weight:600}
.td-sm{font-size:.85rem;color:#666;max-width:180px}
.td-link{color:var(--burg);text-decoration:none;font-size:.85rem}
.td-link:hover{text-decoration:underline}
.td-nw{white-space:nowrap}
.etat{display:inline-block;padding:.25rem .8rem;border-radius:2px;font-size:.78rem;font-weight:700;text-transform:capitalize}
.etat-bernard{background:rgba(201,169,97,.2);color:#7a5a10}
.etat-vigneron{background:rgba(107,30,60,.12);color:var(--deep)}
.edit-btn{background:none;border:none;font-size:.95rem;cursor:pointer;
  padding:.25rem .45rem;border-radius:3px;opacity:.55;transition:all .2s}
.edit-btn:hover{background:rgba(107,30,60,.08);opacity:1}

/* ‚îÄ‚îÄ LIEN ASSOCI√â ‚îÄ‚îÄ */
.link-box{display:flex;align-items:center;gap:.8rem;margin-top:.5rem}
.link-input{flex:1;padding:.5rem .8rem;border:1px solid rgba(107,30,60,.2);border-radius:2px;
  font-size:.82rem;color:#555;background:#fafafa;font-family:'Cormorant Garamond',serif}
.copy-btn{background:var(--burg);color:white;border:none;padding:.5rem 1rem;
  border-radius:2px;cursor:pointer;font-size:.82rem;font-weight:600;transition:all .2s;white-space:nowrap}
.copy-btn:hover{background:var(--deep)}
.copy-ok{color:var(--sage);font-size:.82rem;font-weight:600}

/* ‚îÄ‚îÄ COMMENTAIRE ‚îÄ‚îÄ */
.comment-area{width:100%;padding:1rem 1.2rem;border:2px solid rgba(107,30,60,.15);border-radius:2px;
  font-family:'Cormorant Garamond',serif;font-size:1.05rem;color:var(--dark);
  resize:vertical;min-height:110px;transition:border-color .25s;margin-top:1rem}
.comment-area:focus{outline:none;border-color:var(--burg);box-shadow:0 0 0 3px rgba(107,30,60,.07)}
.save-ok{color:var(--sage);font-weight:600;font-size:.95rem}

/* ‚îÄ‚îÄ DOCS ‚îÄ‚îÄ */
.doc-row{display:flex;align-items:center;gap:1rem;padding:.9rem 0;border-bottom:1px solid rgba(107,30,60,.07)}
.doc-row:last-child{border-bottom:none}
.doc-icon{font-size:1.4rem;flex-shrink:0}
.doc-info{flex:1;min-width:0}
.doc-name{font-weight:600;color:var(--dark);font-size:.95rem}
.doc-date{font-size:.82rem;color:#999;margin-top:.15rem}
.btn-link{color:var(--burg);font-weight:600;font-size:.85rem;text-decoration:none;
  border:1px solid rgba(107,30,60,.25);padding:.35rem .8rem;border-radius:2px;white-space:nowrap;transition:all .2s}
.btn-link:hover{background:var(--burg);color:white}

/* ‚îÄ‚îÄ CATALOGUES/COMMANDES ‚îÄ‚îÄ */
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:2rem;margin-bottom:2rem}
.annee-row{display:flex;align-items:flex-start;gap:1.5rem;padding:.9rem 0;border-bottom:1px solid rgba(107,30,60,.07)}
.annee-row:last-child{border-bottom:none}
.annee-lbl{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:700;color:var(--burg);min-width:50px}
.annee-links{display:flex;flex-direction:column;gap:.4rem}
.alink{font-size:.88rem;font-weight:600;text-decoration:none;padding:.3rem .8rem;border-radius:2px;transition:all .2s;display:inline-block}
.alink-cat{background:rgba(201,169,97,.15);color:#7a5a10;border:1px solid rgba(201,169,97,.4)}
.alink-cat:hover{background:var(--gold);color:var(--deep)}
.alink-cmd{background:rgba(107,30,60,.08);color:var(--burg);border:1px solid rgba(107,30,60,.2)}
.alink-cmd:hover{background:var(--burg);color:white}

/* ‚îÄ‚îÄ CATALOGUE STANDARD ‚îÄ‚îÄ */
.cat-tags{display:flex;flex-wrap:wrap;gap:.6rem;margin:1.2rem 0 1.4rem}
.ctag{display:flex;align-items:center;gap:.45rem;background:rgba(201,169,97,.15);
  border:1px solid rgba(201,169,97,.5);border-radius:2px;padding:.4rem .8rem .4rem 1rem;
  font-size:.92rem;font-weight:500;color:#6b4c10}
.ctag:hover{background:rgba(201,169,97,.25)}
.ctag-rm{background:none;border:none;cursor:pointer;color:#b89451;font-size:1rem;font-weight:700;transition:color .2s}
.ctag-rm:hover{color:#c0392b}
.cat-add{display:flex;gap:.8rem;align-items:center;margin-top:.5rem}
.cat-add .finput{flex:1;margin-bottom:0}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
.loading{text-align:center;padding:4rem 2rem;font-size:1.3rem;color:var(--burg);
  font-family:'Playfair Display',serif}
.empty{text-align:center;color:#aaa;font-style:italic;padding:1rem 0}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;bottom:2rem;right:2rem;background:white;border-left:4px solid var(--sage);
  padding:1rem 1.5rem;border-radius:2px;box-shadow:0 8px 24px rgba(0,0,0,.15);
  font-size:1rem;font-weight:600;color:var(--dark);z-index:9000;animation:slideUp .3s}
.toast-err{border-color:#c0392b;color:#c0392b}

/* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
@keyframes fadeIn{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeInDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:900px){.two-col{grid-template-columns:1fr}.form2{grid-template-columns:1fr}}
@media(max-width:700px){
  .grow{flex-direction:column}
  .gcell{border-right:none;border-bottom:1px solid rgba(107,30,60,.08)}
  .gcell--actions{flex-direction:row}
}
</style>
</head>
<body>
<div class="grain"></div>

<!-- ‚ïê‚ïê √âCRAN DE CONNEXION ‚ïê‚ïê -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo"><span>GFA</span> Manager</div>
    <div class="login-sub">Espace Administrateur</div>
    <div id="login-err" class="login-err" style="display:none"></div>
    <div class="fg">
      <label class="flbl">Email</label>
      <input class="finput" id="l-email" type="email" placeholder="admin@votredomaine.fr" autocomplete="email">
    </div>
    <div class="fg">
      <label class="flbl">Mot de passe</label>
      <input class="finput" id="l-pwd" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>
    <button class="btn btn-primary" style="width:100%" id="l-btn">Se connecter</button>
  </div>
</div>

<!-- ‚ïê‚ïê APP PRINCIPALE ‚ïê‚ïê -->
<div id="app" style="display:none">
  <header class="header">
    <div class="header-inner">
      <div>
        <div class="logo"><span>GFA</span> Manager</div>
        <div class="tagline">Gestion des Groupements Fonciers Agricoles</div>
      </div>
      <button class="logout-btn" id="logout-btn">D√©connexion</button>
    </div>
  </header>
  <nav class="nav-bar">
    <div class="nav-inner">
      <button class="nav-btn active" data-tab="admin">Administration</button>
      <button class="nav-btn" data-tab="campagnes">Campagnes</button>
      <button class="nav-btn" data-tab="associes">Vue Associ√©s</button>
    </div>
  </nav>
  <main class="main" id="main-content">
    <div class="loading">Chargement‚Ä¶</div>
  </main>
</div>

<!-- ‚ïê‚ïê CONTENEUR MODAUX ‚ïê‚ïê -->
<div id="modals"></div>
<!-- ‚ïê‚ïê TOAST ‚ïê‚ïê -->
<div id="toast" style="display:none"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  √âTAT GLOBAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STATE = {
  user: null,
  groupements: [],
  campagnes: [],
  ficheId: null,
  campagneId: null,
  activeTab: 'admin',
};

// Exposer pour le module Firebase
window.STATE = STATE;

const CATALOGUE_STD_DEFAULT = [
  "Bourgogne Aligot√©","Bourgogne Chardonnay","Bourgogne Pinot Noir",
  "Haute C√¥te de Beaune Rouge","Haute C√¥te de Beaune Blanc",
  "C√¥te de Beaune Village","Beaune Premier Cru",
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITAIRES UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function $(id){ return document.getElementById(id); }
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){
    if(k==='class') e.className=v;
    else if(k.startsWith('on')) e.addEventListener(k.slice(2).toLowerCase(),v);
    else e.setAttribute(k,v);
  }
  children.forEach(c=>{ if(c!=null) e.append(typeof c==='string'?document.createTextNode(c):c); });
  return e;
}
function html(tag, content, cls='', attrs={}){
  const e = document.createElement(tag);
  e.className=cls;
  e.innerHTML=content;
  for(const [k,v] of Object.entries(attrs)){
    if(k==='style') e.setAttribute('style',v);
    else if(k.startsWith('on')) e.addEventListener(k.slice(2).toLowerCase(),v);
    else e.setAttribute(k,v);
  }
  return e;
}
function toast(msg, err=false){
  const t=$('toast'); t.textContent=msg; t.className='toast'+(err?' toast-err':'');
  t.style.display='block'; setTimeout(()=>t.style.display='none',3000);
}
function openModal(content){
  const wrap=document.createElement('div');
  wrap.className='backdrop';
  wrap.addEventListener('click',e=>{ if(e.target===wrap) closeModal(); });
  wrap.appendChild(content);
  $('modals').innerHTML=''; $('modals').appendChild(wrap);
}
function closeModal(){ $('modals').innerHTML=''; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHARGEMENT DONN√âES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAll(){
  try {
    console.log('üîÑ D√©but du chargement...');
    $('main-content').innerHTML='<div class="loading">Chargement‚Ä¶</div>';
    
    // Charger groupements + associ√©s
    console.log('üì¶ Chargement des groupements...');
    STATE.groupements = await window.GFA.getGroupements();
    console.log('‚úÖ Groupements charg√©s:', STATE.groupements.length);
    
    for(const g of STATE.groupements){
      g.associes = await window.GFA.getAssocies(g.id);
    }
    console.log('‚úÖ Associ√©s charg√©s');
    
    // Charger campagnes (peut √©chouer si la collection n'existe pas encore)
    try {
      console.log('üì¶ Chargement des campagnes...');
      const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const campSnap = await getDocs(collection(window.GFA.db, 'campagnes'));
      if(!campSnap.empty) {
        STATE.campagnes = await Promise.all(campSnap.docs.map(async (doc) => {
          const data = {id:doc.id, ...doc.data()};
          // Compter vins et commandes
          const vinsSnap = await getDocs(collection(window.GFA.db, 'campagnes', doc.id, 'vins'));
          const cmdsSnap = await getDocs(collection(window.GFA.db, 'campagnes', doc.id, 'commandes'));
          data.nb_vins = vinsSnap.size;
          data.nb_commandes = cmdsSnap.size;
          return data;
        }));
        STATE.campagnes.sort((a,b)=>(b.annee||0)-(a.annee||0));
        console.log('‚úÖ Campagnes charg√©es:', STATE.campagnes.length);
      } else {
        STATE.campagnes = [];
        console.log('‚ÑπÔ∏è Aucune campagne (normal au premier lancement)');
      }
    } catch(campErr) {
      console.warn('‚ö†Ô∏è Aucune campagne trouv√©e:', campErr);
      STATE.campagnes = [];
    }
    
    console.log('‚úÖ Rendu de l interface...');
    render();
    console.log('‚úÖ Chargement termin√©!');
  } catch(err) {
    console.error('‚ùå Erreur lors du chargement:', err);
    $('main-content').innerHTML='<div class="loading" style="color:#c0392b">Erreur de chargement. V√©rifiez la console (F12).</div>';
  }
}

// Exposer pour le module Firebase
window.loadAll = loadAll;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER PRINCIPAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  const mc=$('main-content');
  mc.innerHTML='';
  if(STATE.activeTab==='admin'){
    if(STATE.ficheId){
      const g=STATE.groupements.find(x=>x.id===STATE.ficheId);
      if(g) mc.appendChild(renderFiche(g));
    } else {
      mc.appendChild(renderAdmin());
    }
  } else if(STATE.activeTab==='campagnes'){
    if(STATE.campagneId){
      const c=STATE.campagnes.find(x=>x.id===STATE.campagneId);
      if(c) mc.appendChild(renderDetailCampagne(c));
    } else {
      mc.appendChild(renderCampagnes());
    }
  } else {
    mc.appendChild(renderAllAssocies());
  }
}

// Exposer pour le module Firebase
window.render = render;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VUE D√âTAIL CAMPAGNE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDetailCampagne(c){
  const wrap=el('div');
  
  // Breadcrumb
  const bc=el('div',{class:'bc'});
  bc.appendChild(html('a','‚Üê Retour aux campagnes','',{href:'#',onClick:(e)=>{e.preventDefault();STATE.campagneId=null;render();}}));
  bc.appendChild(html('span',' / ','bc-sep'));
  bc.appendChild(html('span',`Campagne ${c.annee}`));
  wrap.appendChild(bc);
  
  // En-t√™te avec boutons
  const hdrRow=el('div',{style:'display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:2rem'});
  const hdrLeft=el('div');
  hdrLeft.appendChild(html('h1',`Campagne ${c.annee} ‚Äî ${esc(c.vigneron)}`,'',{style:'font-family:"Playfair Display",serif;font-size:2.4rem;font-weight:900;color:var(--deep)'}));
  if(c.date_fin) hdrLeft.appendChild(html('div',`Cl√¥ture : ${c.date_fin}`,'',{style:'font-size:.95rem;color:#999;font-style:italic;margin-top:.3rem'}));
  hdrRow.appendChild(hdrLeft);
  
  const hdrRight=el('div',{style:'display:flex;align-items:center;gap:1rem'});
  // Badge statut cliquable (toggle)
  const badgeStatut=el('button',{
    class:`badge ${c.actif?'badge-success':'badge-warning'}`,
    style:'cursor:pointer;border:none;font-size:.9rem;padding:.4rem 1rem',
    onClick:async()=>{
      const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const newStatut = !c.actif;
      await updateDoc(doc(window.GFA.db, 'campagnes', c.id), { actif: newStatut });
      c.actif = newStatut;
      toast(`Campagne ${newStatut?'activ√©e':'cl√¥tur√©e'}.`);
      await loadAll();
      render();
    }
  }, c.actif?'Active - cliquer pour cl√¥turer':'Cl√¥tur√©e - cliquer pour r√©activer');
  hdrRight.appendChild(badgeStatut);
  
  // Bouton supprimer
  const btnSuppr=el('button',{
    class:'btn btn-del btn-sm',
    onClick:()=>openModalSupprimerCampagne(c)
  },'üóë Supprimer');
  hdrRight.appendChild(btnSuppr);
  hdrRow.appendChild(hdrRight);
  wrap.appendChild(hdrRow);
  
  // Zone de chargement
  const loadingDiv = el('div',{class:'loading'});
  loadingDiv.textContent = 'Chargement des donn√©es...';
  wrap.appendChild(loadingDiv);
  
  // Charger les donn√©es de mani√®re asynchrone
  (async () => {
    try {
      const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      
      // Charger vins et commandes
      const [vinsSnap, cmdsSnap] = await Promise.all([
        getDocs(collection(window.GFA.db, 'campagnes', c.id, 'vins')),
        getDocs(collection(window.GFA.db, 'campagnes', c.id, 'commandes'))
      ]);
      
      const vins = vinsSnap.docs.map(d=>({id:d.id, ...d.data()}));
      const commandes = cmdsSnap.docs.map(d=>({id:d.id, ...d.data()}));
      
      // Retirer le loading
      loadingDiv.remove();
      
      // Carte infos
      const cardInfo=el('div',{class:'card'});
      const gridInfo=el('div',{style:'display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem'});
      gridInfo.appendChild(html('div',`<div class="lbl">Vins au catalogue</div><div class="val">${vins.length}</div>`,'info-item'));
      gridInfo.appendChild(html('div',`<div class="lbl">Commandes re√ßues</div><div class="val">${commandes.filter(c=>c.validee).length} valid√©es / ${commandes.length} total</div>`,'info-item'));
      gridInfo.appendChild(html('div',`<div class="lbl">Statut</div><div class="val"><span class="badge ${c.actif?'badge-success':'badge-warning'}">${c.actif?'Active':'Cl√¥tur√©e'}</span></div>`,'info-item'));
      cardInfo.appendChild(gridInfo);
      wrap.appendChild(cardInfo);
      
      // Carte Associ√©s concern√©s par cette campagne
      const groupementsConcernes = STATE.groupements.filter(g=>g.vigneron===c.vigneron);
      const associesConcernes = groupementsConcernes.flatMap(g=>(g.associes||[]).map(a=>({...a, groupement:g})));
      
      const cardAssoc=el('div',{class:'card'});
      cardAssoc.appendChild(html('h3',`Associ√©s concern√©s (${associesConcernes.length})`,'section-title'));
      if(!associesConcernes.length){
        cardAssoc.appendChild(html('p','Aucun associ√© dans les groupements de ce vigneron.','empty'));
      } else {
        const tableA=el('table',{class:'tbl'});
        tableA.innerHTML=`<thead><tr><th>Nom</th><th>Pr√©nom</th><th>Groupement</th><th>Email</th><th>Statut commande</th></tr></thead>`;
        const tbodyA=el('tbody');
        associesConcernes.forEach(a=>{
          const cmd = commandes.find(c=>c.associe_id===a.id && c.groupement_id===a.groupement.id);
          const statut = cmd ? (cmd.validee ? '<span class="badge badge-success">Command√©</span>' : '<span class="badge badge-warning">Brouillon</span>') : '<span style="color:#aaa;font-style:italic">En attente</span>';
          
          const tr = el('tr');
          tr.innerHTML = `
            <td class="td-b">${esc(a.nom)}</td>
            <td>${esc(a.prenom)}</td>
            <td class="td-sm">${esc(a.groupement.nom)}</td>
            <td><a href="mailto:${esc(a.email)}" class="td-ml">${esc(a.email)}</a></td>
            <td>${statut}</td>
          `;
          tbodyA.appendChild(tr);
        });
        tableA.appendChild(tbodyA);
        cardAssoc.appendChild(tableA);
      }
      wrap.appendChild(cardAssoc);
      
      // Carte vins
      const cardVins=el('div',{class:'card'});
      cardVins.appendChild(html('h3','Catalogue des vins','section-title'));
      if(!vins.length){
        cardVins.appendChild(html('p','Aucun vin au catalogue.','empty'));
      } else {
        const tableV=el('table',{class:'tbl'});
        tableV.innerHTML=`<thead><tr><th>Vin</th><th>Prix unitaire</th><th>Stock</th><th>Groupement</th></tr></thead>`;
        const tbodyV=el('tbody');
        vins.forEach(v=>{
          const groupement = STATE.groupements.find(g=>g.id===v.groupement_id);
          const tr = el('tr');
          tr.innerHTML = `
            <td class="td-b">${esc(v.nom)}</td>
            <td style="font-family:'Playfair Display',serif;font-weight:700;color:var(--burg)">${v.prix} ‚Ç¨</td>
            <td>${v.stock||'Illimit√©'}</td>
            <td>${groupement?esc(groupement.nom):'‚Äî'}</td>
          `;
          tbodyV.appendChild(tr);
        });
        tableV.appendChild(tbodyV);
        cardVins.appendChild(tableV);
      }
      wrap.appendChild(cardVins);
      
      // Carte commandes
      const cardCmds=el('div',{class:'card'});
      const hdrCmds=el('div',{class:'section-hdr'});
      hdrCmds.appendChild(html('h3','Commandes','section-title'));
      const btnExport=el('button',{class:'btn btn-primary btn-sm',onClick:()=>exportCommandesCSV(c, commandes, vins)},'üìä Exporter CSV');
      hdrCmds.appendChild(btnExport);
      cardCmds.appendChild(hdrCmds);
      
      if(!commandes.length){
        cardCmds.appendChild(html('p','Aucune commande re√ßue.','empty'));
      } else {
        const tableC=el('table',{class:'tbl'});
        tableC.innerHTML=`<thead><tr><th>Associ√©</th><th>Groupement</th><th>Mode</th><th>Statut</th><th>Total</th><th>D√©tail</th><th>Date</th></tr></thead>`;
        const tbodyC=el('tbody');
        commandes.forEach(cmd=>{
          const groupement = STATE.groupements.find(g=>g.id===cmd.groupement_id);
          const associe = groupement?.associes?.find(a=>a.id===cmd.associe_id);
          const total = Object.entries(cmd.panier||{}).reduce((s,[vid,qty])=>{
            const v=vins.find(x=>x.id===vid);
            return s+(v?v.prix*qty:0);
          },0).toFixed(2);
          const detail = Object.entries(cmd.panier||{}).map(([vid,qty])=>{
            const v=vins.find(x=>x.id===vid);
            return v?`${v.nom} √ó${qty}`:'';
          }).filter(Boolean).join(', ');
          
          const tr = el('tr');
          tr.innerHTML = `
            <td class="td-b">${associe?`${esc(associe.prenom)} ${esc(associe.nom)}`:'‚Äî'}</td>
            <td class="td-sm">${groupement?esc(groupement.nom):'‚Äî'}</td>
            <td>${cmd.mode_recup||'‚Äî'}</td>
            <td><span class="badge ${cmd.validee?'badge-success':'badge-warning'}">${cmd.validee?'Valid√©e':'Brouillon'}</span></td>
            <td style="font-family:'Playfair Display',serif;font-weight:700;color:var(--burg)">${total} ‚Ç¨</td>
            <td class="td-sm">${detail}</td>
            <td style="font-size:.82rem;color:#888">${cmd.date_maj?new Date(cmd.date_maj).toLocaleDateString('fr-FR'):'‚Äî'}</td>
          `;
          tbodyC.appendChild(tr);
        });
        tableC.appendChild(tbodyC);
        cardCmds.appendChild(tableC);
      }
      wrap.appendChild(cardCmds);
      
    } catch(err){
      console.error('Erreur chargement campagne:', err);
      loadingDiv.textContent = 'Erreur de chargement.';
      loadingDiv.style.color = '#c0392b';
    }
  })();
  
  return wrap;
}

// Export CSV des commandes
function exportCommandesCSV(campagne, commandes, vins){
  const lines = [];
  lines.push(['Campagne', 'Ann√©e', 'Associ√©', 'Pr√©nom', 'Groupement', 'Mode r√©cup√©ration', 'Statut', 'Vin', 'Quantit√©', 'Prix unitaire', 'Sous-total', 'Total commande', 'Date'].join(';'));
  
  commandes.forEach(cmd=>{
    const groupement = STATE.groupements.find(g=>g.id===cmd.groupement_id);
    const associe = groupement?.associes?.find(a=>a.id===cmd.associe_id);
    const totalCmd = Object.entries(cmd.panier||{}).reduce((s,[vid,qty])=>{
      const v=vins.find(x=>x.id===vid);
      return s+(v?v.prix*qty:0);
    },0).toFixed(2);
    const date = cmd.date_maj?new Date(cmd.date_maj).toLocaleDateString('fr-FR'):'';
    
    Object.entries(cmd.panier||{}).forEach(([vid,qty])=>{
      const v=vins.find(x=>x.id===vid);
      if(!v) return;
      const sousTotal = (v.prix*qty).toFixed(2);
      lines.push([
        campagne.annee+' - '+campagne.vigneron,
        campagne.annee,
        associe?.nom||'',
        associe?.prenom||'',
        groupement?.nom||'',
        cmd.mode_recup||'',
        cmd.validee?'Valid√©e':'Brouillon',
        v.nom,
        qty,
        v.prix,
        sousTotal,
        totalCmd,
        date
      ].join(';'));
    });
  });
  
  const csv = lines.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `campagne_${campagne.annee}_${campagne.vigneron}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  toast('Export CSV t√©l√©charg√©.');
}

// Modal de suppression de campagne
function openModalSupprimerCampagne(campagne){
  const box = el('div', {class:'mbox mbox--sm'});
  box.innerHTML = `
    <div class="mhead mhead--danger">
      <span class="mtitle">Supprimer la campagne</span>
      <button class="mclose">‚úï</button>
    </div>
    <div class="mbody" style="text-align:center">
      <div style="font-size:3rem;margin:1rem 0">‚ö†Ô∏è</div>
      <p style="font-size:1.1rem;margin-bottom:.8rem">Vous allez supprimer la <strong>campagne ${campagne.annee} ‚Äî ${esc(campagne.vigneron)}</strong></p>
      <p style="font-size:.9rem;color:#888">Cette action est irr√©versible. Tous les vins et commandes de cette campagne seront supprim√©s.</p>
    </div>
    <div class="mfoot">
      <button class="btn btn-secondary mclose">Annuler</button>
      <button class="btn" id="btn-confirm-suppr" style="background:linear-gradient(135deg,#c0392b,#8B1A1A);color:white">Confirmer la suppression</button>
    </div>
  `;
  
  box.querySelector('.mclose').onclick = closeModal;
  box.querySelectorAll('.mclose').forEach(b=>b.onclick=closeModal);
  
  box.querySelector('#btn-confirm-suppr').onclick = async () => {
    try {
      const { doc, deleteDoc, collection, getDocs } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      
      // Supprimer les vins
      const vinsSnap = await getDocs(collection(window.GFA.db, 'campagnes', campagne.id, 'vins'));
      for(const vinDoc of vinsSnap.docs){
        await deleteDoc(doc(window.GFA.db, 'campagnes', campagne.id, 'vins', vinDoc.id));
      }
      
      // Supprimer les commandes
      const cmdsSnap = await getDocs(collection(window.GFA.db, 'campagnes', campagne.id, 'commandes'));
      for(const cmdDoc of cmdsSnap.docs){
        await deleteDoc(doc(window.GFA.db, 'campagnes', campagne.id, 'commandes', cmdDoc.id));
      }
      
      // Supprimer la campagne
      await deleteDoc(doc(window.GFA.db, 'campagnes', campagne.id));
      
      closeModal();
      toast('Campagne supprim√©e.');
      STATE.campagneId = null;
      await loadAll();
      render();
      
    } catch(err){
      console.error('Erreur suppression:', err);
      toast('Erreur lors de la suppression.', true);
    }
  };
  
  openModal(box);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VUE ADMIN ‚Äî LISTE GROUPEMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAdmin(){
  const wrap=el('div');
  const card=el('div',{class:'card'});
  const hdr=el('div',{class:'card-header'});
  hdr.appendChild(html('h2','Groupements Actifs','card-title'));
  const btnWrap=el('div',{style:'display:flex;gap:.8rem'});
  btnWrap.appendChild(el('button',{class:'btn btn-primary',onClick:()=>openModalNouvelleCampagne()},'+ Nouvelle Campagne'));
  btnWrap.appendChild(el('button',{class:'btn btn-gold',onClick:()=>openModalGroupement()},'+ Nouveau Groupement'));
  hdr.appendChild(btnWrap);
  card.appendChild(hdr);

  const list=el('div',{class:'glist'});
  if(STATE.groupements.length===0){
    list.appendChild(html('p','Aucun groupement. Cliquez sur "+ Nouveau Groupement" pour commencer.','empty'));
  } else {
    STATE.groupements.forEach(g=>list.appendChild(renderGroupementRow(g)));
  }
  card.appendChild(list);
  wrap.appendChild(card);
  return wrap;
}

function renderGroupementRow(g){
  const row=el('div',{class:'grow'});

  const name=el('div',{class:'gcell gcell--name'});
  name.appendChild(html('div','Groupement','lbl'));
  name.appendChild(html('div',esc(g.nom),'gnom'));
  name.appendChild(html('div',g.date_creation?'Cr√©√© le '+esc(g.date_creation):'','gdate'));
  row.appendChild(name);

  const vig=el('div',{class:'gcell'});
  vig.appendChild(html('div','Vigneron','lbl'));
  vig.appendChild(html('div',esc(g.vigneron),'val'));
  row.appendChild(vig);

  const app=el('div',{class:'gcell'});
  app.appendChild(html('div','Appellation','lbl'));
  app.appendChild(html('div',esc(g.appellation),'val'));
  row.appendChild(app);

  const parts=el('div',{class:'gcell gcell--parts'});
  parts.appendChild(html('div','Parts totales','lbl'));
  parts.appendChild(html('div',
    `<span class="val">${g.nombre_total_parts||0}</span><span class="parts-sub">${g.parts_pour_bouteille||1} / bouteille</span>`
  ));
  row.appendChild(parts);

  const nb=el('div',{class:'gcell gcell--nb'});
  nb.appendChild(html('div','Associ√©s','lbl'));
  nb.appendChild(html('div',
    `<span class="val">${(g.associes||[]).length}</span>&nbsp;<span class="badge badge-success">Actif</span>`
  ));
  row.appendChild(nb);

  const actions=el('div',{class:'gcell gcell--actions'});
  actions.appendChild(el('button',{class:'btn btn-primary btn-sm',
    onClick:()=>{ STATE.ficheId=g.id; render(); }},'Voir D√©tails'));
  row.appendChild(actions);
  return row;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VUE FICHE GROUPEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFiche(g){
  const wrap=el('div',{class:'fiche'});

  // Breadcrumb
  const bc=el('div',{class:'breadcrumb'});
  bc.appendChild(el('button',{class:'bc-back',onClick:()=>{ STATE.ficheId=null; render(); }},'‚Üê Retour aux groupements'));
  bc.appendChild(document.createTextNode(' / '));
  bc.appendChild(html('span',esc(g.nom)));
  wrap.appendChild(bc);

  // En-t√™te
  const fhead=el('div',{class:'fhead'});
  const ftl=el('div');
  ftl.appendChild(html('h2',esc(g.nom),'ftitle'));
  ftl.appendChild(html('div',g.date_creation?'Cr√©√© le '+esc(g.date_creation):'','fsub'));
  fhead.appendChild(ftl);
  const fhr=el('div',{class:'fhead-right'});
  fhr.appendChild(html('span',g.actif?'Actif':'Inactif','badge badge-success'));
  fhr.appendChild(el('button',{class:'btn-del-header',
    onClick:()=>openConfirmSupprimerGroupement(g)},'üóë Supprimer'));
  fhead.appendChild(fhr);
  wrap.appendChild(fhead);

  // Infos
  const cardInfo=el('div',{class:'card'});
  cardInfo.appendChild(html('h3','Informations du groupement','section-title'));
  const igrid=el('div',{class:'info-grid',style:'margin-top:1.5rem'});
  [[g.vigneron,'Vigneron'],[g.appellation,'Appellation'],
   [`${g.nombre_total_parts||0} <span class="parts-sub">${g.parts_pour_bouteille||1} / bouteille</span>`,'Parts totales'],
   [`${(g.associes||[]).length} <span class="parts-sub">(${(g.associes||[]).filter(a=>a.actif).length} actifs)</span>`,'Associ√©s']
  ].forEach(([val,lbl])=>{
    const it=el('div',{class:'info-item'});
    it.appendChild(html('div',lbl,'lbl'));
    it.appendChild(html('div',val,'val'));
    igrid.appendChild(it);
  });
  cardInfo.appendChild(igrid);
  wrap.appendChild(cardInfo);

  // Associ√©s
  wrap.appendChild(renderTableAssocies(g));

  // Commentaire
  wrap.appendChild(renderCommentaire(g));

  // Catalogue standard
  wrap.appendChild(renderCatalogueStd(g));

  // Deux colonnes
  const two=el('div',{class:'two-col'});
  two.appendChild(renderDocuments(g));
  two.appendChild(renderAnnees(g));
  wrap.appendChild(two);
  return wrap;
}

// ‚îÄ‚îÄ Tableau Associ√©s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTableAssocies(g){
  const card=el('div',{class:'card'});
  const hdr=el('div',{class:'section-hdr'});
  hdr.appendChild(html('h3','Associ√©s','section-title'));
  hdr.appendChild(el('button',{class:'btn btn-gold btn-sm',
    onClick:()=>openModalAssocie(g, null)},'+  Ajouter un associ√©'));
  card.appendChild(hdr);

  const twrap=el('div',{class:'twrap'});
  const tbl=el('table',{class:'tbl'});
  tbl.innerHTML=`<thead><tr>
    <th>Nom</th><th>Pr√©nom</th><th>Parts</th><th>Adresse livraison</th>
    <th>Email</th><th>T√©l√©phone</th><th>√âtat</th><th>Statut</th><th>Lien</th><th></th>
  </tr></thead>`;
  const tbody=el('tbody');
  (g.associes||[]).forEach(a=>{
    const tr=el('tr',{class:a.actif?'':'row-off'});
    const token=a.token||'';
    const lien=token?`${location.origin}/associe.html?token=${token}`:'';
    tr.innerHTML=`
      <td class="td-b">${esc(a.nom)}</td>
      <td>${esc(a.prenom)}</td>
      <td class="td-c">${a.parts||0}</td>
      <td class="td-sm">${esc(a.adresse||'')}</td>
      <td><a href="mailto:${esc(a.email)}" class="td-link">${esc(a.email||'')}</a></td>
      <td class="td-nw">${esc(a.tel||'')}</td>
      <td><span class="etat etat-${a.etat}">${esc(a.etat||'')}</span></td>
      <td><span class="badge ${a.actif?'badge-success':'badge-warning'}" style="font-size:.7rem;padding:.2rem .7rem">
        ${a.actif?'Actif':'Inactif'}</span></td>
      <td style="min-width:300px">
        ${lien?`
        <div class="link-box">
          <input class="link-input" value="${esc(lien)}" readonly id="link-${a.id}">
          <button class="copy-btn" data-aid="${a.id}" title="Copier le lien">üìã</button>
          <button class="send-btn" data-aid="${a.id}" title="Envoyer par email">‚úâÔ∏è</button>
        </div>`:'<span style="font-size:.82rem;color:#bbb;font-style:italic">‚Äî</span>'}
      </td>
      <td><button class="edit-btn" data-aid="${a.id}" title="Modifier">‚úèÔ∏è</button></td>`;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
  twrap.appendChild(tbl);
  card.appendChild(twrap);

  // Events sur les boutons du tableau
  card.querySelectorAll('.edit-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const a=(g.associes||[]).find(x=>x.id===btn.dataset.aid);
      if(a) openModalAssocie(g,a);
    });
  });
  card.querySelectorAll('.copy-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const inp=$(`link-${btn.dataset.aid}`);
      if(inp){ inp.select(); navigator.clipboard.writeText(inp.value); toast('Lien copi√© !'); }
    });
  });
  card.querySelectorAll('.send-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const a=(g.associes||[]).find(x=>x.id===btn.dataset.aid);
      if(!a||!a.email){ toast('Cet associ√© n\'a pas d\'adresse email.', true); return; }
      if(!a.token){ toast('Cet associ√© n\'a pas encore de lien g√©n√©r√©.', true); return; }
      window.MAIL.ouvrirMailAssocie(a, g);
    });
  });
  return card;
}

// ‚îÄ‚îÄ Commentaire ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCommentaire(g){
  const card=el('div',{class:'card'});
  card.appendChild(html('h3','Commentaires','section-title'));
  const ta=el('textarea',{class:'comment-area',rows:'4',
    placeholder:'Ajoutez vos notes et commentaires sur ce groupement‚Ä¶'});
  ta.value=g.commentaire||'';
  card.appendChild(ta);
  const row=el('div',{style:'display:flex;align-items:center;gap:1rem;margin-top:1rem'});
  const ok=html('span','','save-ok');
  const btn=el('button',{class:'btn btn-primary btn-sm',onClick:async()=>{
    g.commentaire=ta.value;
    await window.GFA.saveGroupement(g);
    ok.textContent='‚úì Sauvegard√©'; setTimeout(()=>ok.textContent='',2500);
  }},'Enregistrer');
  row.appendChild(btn); row.appendChild(ok);
  card.appendChild(row);
  return card;
}

// ‚îÄ‚îÄ Catalogue standard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCatalogueStd(g){
  if(!g.catalogue_std) g.catalogue_std=[...CATALOGUE_STD_DEFAULT];
  const card=el('div',{class:'card'});
  const hdr=el('div',{class:'section-hdr'});
  hdr.appendChild(html('h3','Catalogue standard','section-title'));
  hdr.appendChild(html('span','Liste des appellations de r√©f√©rence','parts-sub'));
  card.appendChild(hdr);

  const tags=el('div',{class:'cat-tags'}); card.appendChild(tags);
  const renderTags=()=>{
    tags.innerHTML='';
    (g.catalogue_std||[]).forEach(app=>{
      const t=el('div',{class:'ctag'});
      t.appendChild(document.createTextNode(app));
      const rm=el('button',{class:'ctag-rm',title:'Retirer',onClick:async()=>{
        g.catalogue_std=g.catalogue_std.filter(x=>x!==app);
        await window.GFA.saveGroupement(g);
        renderTags();
      }},'√ó');
      t.appendChild(rm); tags.appendChild(t);
    });
  };
  renderTags();

  const addRow=el('div',{class:'cat-add'});
  const inp=el('input',{class:'finput',placeholder:'Ajouter une appellation‚Ä¶'});
  const btn=el('button',{class:'btn btn-gold btn-sm',onClick:async()=>{
    const v=inp.value.trim();
    if(v&&!(g.catalogue_std||[]).includes(v)){
      if(!g.catalogue_std) g.catalogue_std=[];
      g.catalogue_std.push(v);
      await window.GFA.saveGroupement(g);
      inp.value=''; renderTags();
    }
  }},'+  Ajouter');
  inp.addEventListener('keydown',e=>{ if(e.key==='Enter') btn.click(); });
  addRow.appendChild(inp); addRow.appendChild(btn);
  card.appendChild(addRow);
  return card;
}

// ‚îÄ‚îÄ Documents ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDocuments(g){
  const card=el('div',{class:'card'});
  const hdr=el('div',{class:'section-hdr'});
  hdr.appendChild(html('h3','Documents','section-title'));
  hdr.appendChild(el('button',{class:'btn btn-gold btn-sm'},'+ Ajouter'));
  card.appendChild(hdr);
  (g.documents||[]).forEach(d=>{
    const row=el('div',{class:'doc-row'});
    row.appendChild(html('span','üìÑ','doc-icon'));
    const info=el('div',{class:'doc-info'});
    info.appendChild(html('div',esc(d.nom),'doc-name'));
    info.appendChild(html('div',esc(d.date||''),'doc-date'));
    row.appendChild(info);
    row.appendChild(el('a',{href:d.url||'#',class:'btn-link',target:'_blank'},'T√©l√©charger'));
    card.appendChild(row);
  });
  if(!(g.documents||[]).length) card.appendChild(html('p','Aucun document','empty'));
  return card;
}

// ‚îÄ‚îÄ Ann√©es ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAnnees(g){
  const card=el('div',{class:'card'});
  card.appendChild(html('h3','Catalogues & Commandes par ann√©e','section-title'));
  const cats=g.catalogues||[], cmds=g.commandes||[];
  const annees=[...new Set([...cats.map(x=>x.annee),...cmds.map(x=>x.annee)])].sort((a,b)=>b-a);
  if(!annees.length){ card.appendChild(html('p','Aucune ann√©e','empty')); return card; }
  annees.forEach(annee=>{
    const row=el('div',{class:'annee-row'});
    row.appendChild(html('div',String(annee),'annee-lbl'));
    const links=el('div',{class:'annee-links'});
    const cat=cats.find(x=>x.annee===annee);
    const cmd=cmds.find(x=>x.annee===annee);
    if(cat) links.appendChild(el('a',{href:cat.url,class:'alink alink-cat',target:'_blank'},'üìã '+cat.label));
    if(cmd) links.appendChild(el('a',{href:cmd.url,class:'alink alink-cmd',target:'_blank'},'üõí '+cmd.label));
    row.appendChild(links); card.appendChild(row);
  });
  return card;
}

// ‚îÄ‚îÄ Vue tous les associ√©s ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAllAssocies(){
  const wrap=el('div');
  STATE.groupements.forEach(g=>{
    const card=el('div',{class:'card'});
    card.appendChild(html('h3',esc(g.nom),'section-title'));
    card.appendChild(renderTableAssocies(g));
    wrap.appendChild(card);
  });
  if(!STATE.groupements.length) wrap.appendChild(html('p','Aucun groupement','empty'));
  return wrap;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL ‚Äî NOUVEAU / MODIFIER GROUPEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModalGroupement(g=null){
  const isEdit=!!g;
  const box=el('div',{class:'mbox'});
  box.innerHTML=`
    <div class="mhead">
      <span class="mtitle">${isEdit?'Modifier le groupement':'Nouveau Groupement'}</span>
      <button class="mclose">‚úï</button>
    </div>
    <div class="mbody">
      <div class="form2">
        <div class="fg"><label class="flbl">Nom *</label>
          <input class="finput" id="mg-nom" value="${esc(g?.nom||'')}" placeholder="ex. Les Vignerons du Clos"></div>
        <div class="fg"><label class="flbl">Vigneron *</label>
          <input class="finput" id="mg-vig" value="${esc(g?.vigneron||'')}" placeholder="ex. Domaine Loic Durand"></div>
      </div>
      <div class="form2">
        <div class="fg"><label class="flbl">Appellation *</label>
          <input class="finput" id="mg-app" value="${esc(g?.appellation||'')}" placeholder="ex. Haute C√¥te de Beaune"></div>
        <div class="fg"><label class="flbl">Date de cr√©ation</label>
          <input class="finput" id="mg-date" value="${esc(g?.date_creation||'')}" placeholder="ex. 15 janvier 2024"></div>
      </div>
      <div class="form2">
        <div class="fg"><label class="flbl">Nombre total de parts *</label>
          <input class="finput" id="mg-parts" type="number" value="${g?.nombre_total_parts||''}" placeholder="120"></div>
        <div class="fg"><label class="flbl">Parts par bouteille *</label>
          <input class="finput" id="mg-ppb" type="number" value="${g?.parts_pour_bouteille||''}" placeholder="3"></div>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-secondary" id="mg-cancel">Annuler</button>
      <button class="btn btn-gold" id="mg-save">${isEdit?'Enregistrer':'Cr√©er le groupement'}</button>
    </div>`;
  box.querySelector('.mclose').onclick=closeModal;
  box.querySelector('#mg-cancel').onclick=closeModal;
  box.querySelector('#mg-save').onclick=async()=>{
    const nom=box.querySelector('#mg-nom').value.trim();
    const vig=box.querySelector('#mg-vig').value.trim();
    const app=box.querySelector('#mg-app').value.trim();
    if(!nom||!vig||!app){ toast('Nom, vigneron et appellation requis.', true); return; }
    const data={ ...(g||{}), nom, vigneron:vig, appellation:app,
      date_creation:box.querySelector('#mg-date').value.trim(),
      nombre_total_parts:parseInt(box.querySelector('#mg-parts').value)||0,
      parts_pour_bouteille:parseInt(box.querySelector('#mg-ppb').value)||1,
      actif:true, documents:g?.documents||[], catalogues:g?.catalogues||[],
      commandes:g?.commandes||[], commentaire:g?.commentaire||'',
      catalogue_std:g?.catalogue_std||[...CATALOGUE_STD_DEFAULT] };
    const id=await window.GFA.saveGroupement(data);
    if(!data.id) data.id=id;
    closeModal(); await loadAll();
    toast(isEdit?'Groupement mis √† jour.':'Groupement cr√©√©.');
  };
  openModal(box);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL ‚Äî CONFIRM SUPPRESSION GROUPEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openConfirmSupprimerGroupement(g){
  const box=el('div',{class:'mbox mbox--sm'});
  box.innerHTML=`
    <div class="mhead mhead--danger">
      <span class="mtitle">Supprimer le groupement</span>
      <button class="mclose">‚úï</button>
    </div>
    <div class="mbody">
      <div class="danger-icon">‚ö†Ô∏è</div>
      <p class="danger-msg">Vous √™tes sur le point de supprimer<br><strong>¬´ ${esc(g.nom)} ¬ª</strong></p>
      <p class="danger-sub">Cette action est irr√©versible. Toutes les donn√©es seront perdues : associ√©s, documents, catalogues et historique des commandes.</p>
    </div>
    <div class="mfoot">
      <button class="btn btn-secondary" id="ds-cancel">Annuler</button>
      <button class="btn btn-danger-confirm" id="ds-ok">Confirmer la suppression</button>
    </div>`;
  box.querySelector('.mclose').onclick=closeModal;
  box.querySelector('#ds-cancel').onclick=closeModal;
  box.querySelector('#ds-ok').onclick=async()=>{
    await window.GFA.deleteGroupement(g.id);
    STATE.ficheId=null; closeModal(); await loadAll();
    toast('Groupement supprim√©.');
  };
  openModal(box);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL ‚Äî NOUVEAU / MODIFIER ASSOCI√â
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModalAssocie(g, a=null){
  const isEdit=!!a;
  const box=el('div',{class:'mbox'});
  box.innerHTML=`
    <div class="mhead">
      <span class="mtitle">${isEdit?'Modifier l\'associ√©':'Nouvel Associ√©'}</span>
      <button class="mclose">‚úï</button>
    </div>
    <div class="mbody">
      <div class="form2">
        <div class="fg"><label class="flbl">Nom *</label>
          <input class="finput" id="ma-nom" value="${esc(a?.nom||'')}"></div>
        <div class="fg"><label class="flbl">Pr√©nom *</label>
          <input class="finput" id="ma-prenom" value="${esc(a?.prenom||'')}"></div>
      </div>
      <div class="form2">
        <div class="fg"><label class="flbl">Nombre de parts *</label>
          <input class="finput" id="ma-parts" type="number" value="${a?.parts||''}"></div>
        <div class="fg"><label class="flbl">T√©l√©phone</label>
          <input class="finput" id="ma-tel" value="${esc(a?.tel||'')}"></div>
      </div>
      <div class="fg"><label class="flbl">Adresse de livraison</label>
        <input class="finput" id="ma-adresse" value="${esc(a?.adresse||'')}"></div>
      <div class="fg"><label class="flbl">Email *</label>
        <input class="finput" id="ma-email" type="email" value="${esc(a?.email||'')}"></div>
      <div class="form2">
        <div class="fg"><label class="flbl">√âtat</label>
          <select class="finput" id="ma-etat">
            <option value="bernard" ${(a?.etat||'bernard')==='bernard'?'selected':''}>Bernard</option>
            <option value="vigneron" ${a?.etat==='vigneron'?'selected':''}>Vigneron</option>
          </select></div>
        <div class="fg"><label class="flbl">Statut</label>
          <select class="finput" id="ma-actif">
            <option value="1" ${a?.actif!==false?'selected':''}>Actif</option>
            <option value="0" ${a?.actif===false?'selected':''}>Inactif</option>
          </select></div>
      </div>
      <div id="ma-confirm-del"></div>
    </div>
    <div class="mfoot ${isEdit?'mfoot--between':''}">
      ${isEdit?`<button class="btn-del-outline" id="ma-del">üóë Supprimer</button>`:''}
      <div style="display:flex;gap:1rem">
        <button class="btn btn-secondary" id="ma-cancel">Annuler</button>
        <button class="btn btn-gold" id="ma-save">Enregistrer</button>
      </div>
    </div>`;
  box.querySelector('.mclose').onclick=closeModal;
  box.querySelector('#ma-cancel').onclick=closeModal;

  if(isEdit){
    box.querySelector('#ma-del').onclick=()=>{
      const cd=box.querySelector('#ma-confirm-del');
      cd.innerHTML=`<div class="confirm-box">
        <p>Confirmer la suppression de <strong>${esc(a.prenom)} ${esc(a.nom)}</strong> ?</p>
        <div style="display:flex;gap:.8rem;margin-top:.8rem">
          <button class="btn btn-danger-confirm btn-sm" id="ma-del-ok">Oui, supprimer</button>
          <button class="btn btn-secondary btn-sm" id="ma-del-no">Annuler</button>
        </div></div>`;
      cd.querySelector('#ma-del-ok').onclick=async()=>{
        await window.GFA.deleteAssocie(g.id, a.id);
        g.associes=g.associes.filter(x=>x.id!==a.id);
        closeModal(); render(); toast('Associ√© supprim√©.');
      };
      cd.querySelector('#ma-del-no').onclick=()=>{ cd.innerHTML=''; };
    };
  }

  box.querySelector('#ma-save').onclick=async()=>{
    const nom=box.querySelector('#ma-nom').value.trim();
    const prenom=box.querySelector('#ma-prenom').value.trim();
    const email=box.querySelector('#ma-email').value.trim();
    if(!nom||!prenom||!email){ toast('Nom, pr√©nom et email requis.', true); return; }
    const token=a?.token||window.GFA.genToken();
    const data={
      ...(a||{}), nom, prenom, email,
      parts:parseInt(box.querySelector('#ma-parts').value)||0,
      tel:box.querySelector('#ma-tel').value.trim(),
      adresse:box.querySelector('#ma-adresse').value.trim(),
      etat:box.querySelector('#ma-etat').value,
      actif:box.querySelector('#ma-actif').value==='1',
      token, groupement_id:g.id
    };
    const newId = await window.GFA.saveAssocie(g.id, data);
    if(!data.id) data.id = newId;
    if(!g.associes) g.associes = [];
    const idx = g.associes.findIndex(x => x.id === data.id);
    if(idx >= 0) g.associes[idx] = data; else g.associes.push(data);
    closeModal(); render();

    // √Ä la cr√©ation : ouvre directement le client mail avec le lien pr√©-rempli
    if(!isEdit && data.email) {
      window.MAIL.ouvrirMailAssocie(data, g);
    } else {
      toast(isEdit ? 'Associ√© mis √† jour.' : 'Associ√© cr√©√©.');
    }
  };
  openModal(box);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VUE CAMPAGNES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCampagnes(){
  const wrap=el('div');
  const card=el('div',{class:'card'});
  const hdr=el('div',{class:'card-header'});
  hdr.appendChild(html('h2','Campagnes','card-title'));
  hdr.appendChild(el('button',{class:'btn btn-gold',onClick:()=>openModalNouvelleCampagne()},'+ Nouvelle Campagne'));
  card.appendChild(hdr);

  if(!STATE.campagnes||!STATE.campagnes.length){
    card.appendChild(html('p','Aucune campagne. Cliquez sur "+ Nouvelle Campagne" pour en cr√©er une.','empty'));
  } else {
    const list=el('div',{style:'display:flex;flex-direction:column;gap:1rem;margin-top:1.5rem'});
    STATE.campagnes.forEach(c=>{
      const ccard=el('div',{style:'border:1px solid rgba(107,30,60,.12);border-radius:4px;overflow:hidden'});
      const chead=el('div',{style:'display:flex;justify-content:space-between;align-items:center;padding:1.2rem 1.5rem;background:linear-gradient(135deg,rgba(107,30,60,.04),rgba(201,169,97,.04))'});
      const cleft=el('div');
      cleft.appendChild(html('div',`Campagne ${c.annee} ‚Äî ${esc(c.vigneron)}`,'val',{style:'font-family:"Playfair Display",serif;font-size:1.3rem;font-weight:700;color:var(--burg)'}));
      cleft.appendChild(html('div',c.date_fin?`Cl√¥ture : ${c.date_fin}`:'','',{style:'font-size:.85rem;color:#888;margin-top:.2rem'}));
      chead.appendChild(cleft);
      const cright=el('div',{style:'display:flex;align-items:center;gap:.8rem'});
      cright.appendChild(html('span',c.actif?'Active':'Cl√¥tur√©e',`badge ${c.actif?'badge-success':'badge-warning'}`));
      cright.appendChild(el('button',{class:'btn btn-primary btn-sm',onClick:()=>{ STATE.campagneId=c.id; STATE.activeTab='campagnes'; render(); }},'D√©tails'));
      chead.appendChild(cright);
      ccard.appendChild(chead);
      
      const cbody=el('div',{style:'padding:1rem 1.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem'});
      cbody.appendChild(html('div',`<div class="lbl">Vins au catalogue</div><div class="val">${c.nb_vins||0}</div>`,'info-item'));
      cbody.appendChild(html('div',`<div class="lbl">Commandes re√ßues</div><div class="val">${c.nb_commandes||0}</div>`,'info-item'));
      cbody.appendChild(html('div',`<div class="lbl">Prix r√©f√©rence</div><div class="val">${c.prix_bouteille_reference||'‚Äî'} ‚Ç¨</div>`,'info-item'));
      ccard.appendChild(cbody);
      list.appendChild(ccard);
    });
    card.appendChild(list);
  }
  wrap.appendChild(card);
  return wrap;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL ‚Äî NOUVELLE CAMPAGNE (s√©lection vigneron, agr√©gation groupements)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModalNouvelleCampagne() {
  const box = el('div', {class:'mbox'});
  const anneeActuelle = new Date().getFullYear();
  
  // Liste unique des vignerons depuis tous les groupements
  const vignerons = [...new Set(STATE.groupements.map(g=>g.vigneron).filter(Boolean))].sort();
  
  if(!vignerons.length){
    toast('Cr√©ez d\'abord un groupement avant de cr√©er une campagne.',true);
    return;
  }

  // Calculer date de cl√¥ture par d√©faut (+1 mois)
  const dateCloture = new Date();
  dateCloture.setMonth(dateCloture.getMonth() + 1);
  const jourCloture = dateCloture.getDate();
  const moisCloture = dateCloture.toLocaleDateString('fr-FR', { month: 'long' });
  const anneeCloture = dateCloture.getFullYear();
  const dateClotureDefaut = `${jourCloture} ${moisCloture} ${anneeCloture}`;

  box.innerHTML = `
    <div class="mhead">
      <span class="mtitle">Nouvelle Campagne</span>
      <button class="mclose">‚úï</button>
    </div>
    <div class="mbody">
      <div class="form2">
        <div class="fg"><label class="flbl">Ann√©e *</label>
          <input class="finput" id="nc-annee" type="number" value="${anneeActuelle}" required></div>
        <div class="fg"><label class="flbl">Date de cl√¥ture</label>
          <input class="finput" id="nc-fin" value="${dateClotureDefaut}" placeholder="ex. 15 mars ${anneeActuelle}"></div>
      </div>
      
      <div class="fg"><label class="flbl">Vigneron *</label>
        <select class="finput" id="nc-vigneron" required>
          <option value="">-- S√©lectionnez un vigneron --</option>
          ${vignerons.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join('')}
        </select>
      </div>
      
      <div id="nc-catalogue-zone" style="display:none;margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid rgba(107,30,60,.1)">
        <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;color:var(--burg);margin-bottom:.5rem">
          Catalogue des vins
        </div>
        <div id="nc-groupements-info" style="font-size:.88rem;color:#777;margin-bottom:1rem"></div>
        <div id="nc-vins-list" style="display:grid;gap:.8rem;max-height:300px;overflow-y:auto;padding-right:.5rem"></div>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn btn-secondary" id="nc-cancel">Annuler</button>
      <button class="btn btn-gold" id="nc-create" disabled>Cr√©er la campagne</button>
    </div>`;

  box.querySelector('.mclose').onclick = closeModal;
  box.querySelector('#nc-cancel').onclick = closeModal;

  // Bloquer le scroll de la souris sur les inputs number (A3)
  box.querySelectorAll('input[type="number"]').forEach(inp => {
    inp.addEventListener('wheel', e => e.preventDefault(), { passive: false });
  });

  // Changement de vigneron ‚Üí afficher les groupements + catalogue
  box.querySelector('#nc-vigneron').addEventListener('change', (e) => {
    const vigneron = e.target.value;
    const catalogueZone = box.querySelector('#nc-catalogue-zone');
    const createBtn = box.querySelector('#nc-create');
    
    if(!vigneron){
      catalogueZone.style.display='none';
      createBtn.disabled=true;
      return;
    }

    // Filtrer les groupements de ce vigneron
    const groupementsVigneron = STATE.groupements.filter(g=>g.vigneron===vigneron);
    
    // Agr√©ger tous les catalogues standards
    const toutesAppellations = [];
    groupementsVigneron.forEach(g=>{
      (g.catalogue_std||[]).forEach(app=>{
        if(!toutesAppellations.find(a=>a.nom===app)){
          toutesAppellations.push({nom:app, groupement_id:g.id, groupement_nom:g.nom});
        }
      });
    });

    // Afficher infos groupements
    const infoDiv = box.querySelector('#nc-groupements-info');
    infoDiv.textContent = `${groupementsVigneron.length} groupement(s) : ${groupementsVigneron.map(g=>g.nom).join(', ')}`;

    // Afficher liste vins
    const vinsDiv = box.querySelector('#nc-vins-list');
    if(!toutesAppellations.length){
      vinsDiv.innerHTML='<p style="color:#aaa;font-style:italic;font-size:.9rem">Aucune appellation dans les catalogues de ce vigneron.</p>';
    } else {
      vinsDiv.innerHTML = toutesAppellations.map(app=>`
        <div style="display:flex;align-items:center;gap:.8rem;padding:.7rem;background:rgba(248,245,239,.6);border-radius:2px">
          <div style="flex:1.5">
            <div style="font-weight:600;color:var(--dark)">${esc(app.nom)}</div>
            <div style="font-size:.8rem;color:#999">${esc(app.groupement_nom)}</div>
          </div>
          <div style="flex:1;display:flex;align-items:center;gap:.5rem">
            <input class="finput vin-prix" data-nom="${esc(app.nom)}" data-gid="${app.groupement_id}" type="number" step="0.01" 
              placeholder="Prix ‚Ç¨" style="margin:0;flex:1">
            <input class="finput vin-stock" type="number" placeholder="Stock" 
              style="margin:0;width:90px" title="Stock limit√© (laisser vide = illimit√©)">
          </div>
        </div>
      `).join('');
      
      // Bloquer le scroll sur ces nouveaux inputs
      vinsDiv.querySelectorAll('input[type="number"]').forEach(inp => {
        inp.addEventListener('wheel', e => e.preventDefault(), { passive: false });
      });
    }

    catalogueZone.style.display='block';
    createBtn.disabled=false;
  });

  // Bouton cr√©er
  box.querySelector('#nc-create').onclick = async () => {
    const annee     = parseInt(box.querySelector('#nc-annee').value) || anneeActuelle;
    const fin       = box.querySelector('#nc-fin').value.trim();
    const vigneron  = box.querySelector('#nc-vigneron').value;
    const createBtn = box.querySelector('#nc-create');
    
    if(!vigneron){
      toast('Veuillez s√©lectionner un vigneron.',true);
      return;
    }

    // Collecter les vins
    const vins = [];
    box.querySelectorAll('.vin-prix').forEach(inp => {
      const prix = parseFloat(inp.value);
      const nom  = inp.dataset.nom;
      const gid  = inp.dataset.gid;
      const stock= inp.nextElementSibling?.value ? parseInt(inp.nextElementSibling.value) : null;
      if (prix && prix > 0) {
        vins.push({ nom, prix, stock, groupement_id:gid, description: '' });
      }
    });

    if (vins.length === 0) {
      toast('Veuillez indiquer au moins un prix pour cr√©er la campagne.', true);
      return;
    }

    createBtn.textContent = 'Cr√©ation en cours‚Ä¶';
    createBtn.disabled = true;

    try {
      const { db } = window.GFA;
      const { collection, doc, setDoc, addDoc, getDocs, updateDoc, query, where } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

      // Cr√©er la campagne √† la racine
      const campagneRef = doc(collection(db, 'campagnes'));
      await setDoc(campagneRef, {
        annee,
        vigneron,
        actif: true,
        date_fin: fin,
        cree_le: new Date().toISOString()
      });

      // D√©sactiver les autres campagnes de ce vigneron
      const autresCampagnes = await getDocs(
        query(collection(db, 'campagnes'), where('vigneron', '==', vigneron), where('actif', '==', true))
      );
      for (const campDoc of autresCampagnes.docs) {
        if (campDoc.id !== campagneRef.id) {
          await updateDoc(doc(db, 'campagnes', campDoc.id), { actif: false });
        }
      }

      // Cr√©er les vins
      for (const vin of vins) {
        await addDoc(collection(db, 'campagnes', campagneRef.id, 'vins'), {
          nom: vin.nom,
          prix: vin.prix,
          stock: vin.stock,
          groupement_id: vin.groupement_id,
          description: vin.description
        });
      }

      closeModal();
      toast(`Campagne ${annee} cr√©√©e avec ${vins.length} vin${vins.length>1?'s':''}.`);
      
      // Recharger les campagnes et rediriger vers le d√©tail
      await loadAll();
      STATE.campagneId = campagneRef.id;
      STATE.activeTab = 'campagnes';
      render();

    } catch(err) {
      console.error(err);
      toast('Erreur lors de la cr√©ation. V√©rifiez la console.', true);
      createBtn.textContent = 'Cr√©er la campagne';
      createBtn.disabled = false;
    }
  };

  openModal(box);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL ‚Äî ANCIENNE VERSION (sera supprim√©e)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModalNouvelleCampagne_OLD(g) {
  const box = el('div', {class:'mbox'});
  const anneeActuelle = new Date().getFullYear();
  const associesActifs = (g.associes||[]).filter(a=>a.actif&&a.email&&a.token);
  const catalogue = g.catalogue_std || [];

  box.innerHTML = `
    <div class="mhead">
      <span class="mtitle">Nouvelle Campagne ‚Äî ${esc(g.nom)}</span>
      <button class="mclose">‚úï</button>
    </div>
    <div class="mbody">
      <div class="form2">
        <div class="fg"><label class="flbl">Ann√©e *</label>
          <input class="finput" id="nc-annee" type="number" value="${anneeActuelle}" required></div>
        <div class="fg"><label class="flbl">Date de cl√¥ture</label>
          <input class="finput" id="nc-fin" placeholder="ex. 15 mars ${anneeActuelle}"></div>
      </div>
      <div class="fg"><label class="flbl">Prix de r√©f√©rence par bouteille (‚Ç¨)</label>
        <input class="finput" id="nc-prix-ref" type="number" step="0.01" value="${g.prix_bouteille_reference||''}" placeholder="ex. 12.50"></div>
      
      <div style="margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid rgba(107,30,60,.1)">
        <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;color:var(--burg);margin-bottom:.8rem">
          Catalogue des vins
        </div>
        ${!catalogue.length ? `
          <p style="color:#aaa;font-style:italic;font-size:.9rem;margin-bottom:1rem">
            Aucune appellation dans le catalogue standard. Ajoutez-en dans la fiche du groupement, puis recr√©ez la campagne.
          </p>
        ` : `
          <div style="font-size:.88rem;color:#777;margin-bottom:1rem">
            Indiquez le prix pour chaque appellation. Laissez vide pour ne pas inclure ce vin dans la campagne.
          </div>
          <div style="display:grid;gap:.8rem;max-height:300px;overflow-y:auto;padding-right:.5rem">
            ${catalogue.map((app,i)=>`
              <div style="display:flex;align-items:center;gap:.8rem;padding:.7rem;background:rgba(248,245,239,.6);border-radius:2px">
                <div style="flex:1.5;font-weight:600;color:var(--dark)">${esc(app)}</div>
                <div style="flex:1;display:flex;align-items:center;gap:.5rem">
                  <input class="finput vin-prix" data-nom="${esc(app)}" type="number" step="0.01" 
                    placeholder="Prix ‚Ç¨" style="margin:0;flex:1">
                  <input class="finput vin-stock" type="number" placeholder="Stock" 
                    style="margin:0;width:90px" title="Stock limit√© (laisser vide = illimit√©)">
                </div>
              </div>
            `).join('')}
          </div>
        `}
      </div>

      <div style="margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid rgba(107,30,60,.1)">
        <div style="font-family:'Playfair Display',serif;font-size:1rem;font-weight:600;color:var(--burg);margin-bottom:.8rem">
          Notifier les associ√©s (${associesActifs.length})
        </div>
        <div style="font-size:.88rem;color:#777;margin-bottom:.8rem">
          Cliquez sur chaque associ√© pour ouvrir un email pr√©-rempli avec son lien personnel.
        </div>
        <div id="nc-assoc-list" style="display:flex;flex-direction:column;gap:.5rem;max-height:200px;overflow-y:auto">
          ${associesActifs.map(a=>`
            <div style="display:flex;align-items:center;justify-content:space-between;
              padding:.6rem 1rem;border:1px solid rgba(107,30,60,.12);border-radius:3px;
              background:rgba(248,245,239,.6)">
              <span style="font-size:.9rem"><strong>${esc(a.prenom)} ${esc(a.nom)}</strong>
                <span style="color:#999;font-size:.82rem;margin-left:.5rem">${esc(a.email)}</span>
              </span>
              <button class="nc-mail-btn btn btn-gold btn-sm" data-aid="${a.id}" style="flex-shrink:0">
                ‚úâÔ∏è Envoyer
              </button>
            </div>`).join('')}
          ${!associesActifs.length ? '<p style="color:#aaa;font-style:italic;font-size:.85rem">Aucun associ√© actif.</p>' : ''}
        </div>
      </div>
    </div>
    <div class="mfoot" style="justify-content:space-between">
      <button class="btn btn-secondary" id="nc-cancel">Annuler</button>
      <div style="display:flex;gap:.8rem">
        ${associesActifs.length > 1 ? `<button class="btn btn-primary" id="nc-all">‚úâÔ∏è Envoyer √† tous</button>` : ''}
        <button class="btn btn-gold" id="nc-create">Cr√©er la campagne</button>
      </div>
    </div>`;

  box.querySelector('.mclose').onclick = closeModal;
  box.querySelector('#nc-cancel').onclick = closeModal;

  // Bouton cr√©er campagne
  box.querySelector('#nc-create').onclick = async () => {
    const annee   = parseInt(box.querySelector('#nc-annee').value) || anneeActuelle;
    const fin     = box.querySelector('#nc-fin').value.trim();
    const prixRef = parseFloat(box.querySelector('#nc-prix-ref').value) || null;
    const createBtn = box.querySelector('#nc-create');
    
    // Collecter les vins avec prix
    const vins = [];
    box.querySelectorAll('.vin-prix').forEach(inp => {
      const prix  = parseFloat(inp.value);
      const nom   = inp.dataset.nom;
      const stock = inp.nextElementSibling?.value ? parseInt(inp.nextElementSibling.value) : null;
      if (prix && prix > 0) {
        vins.push({ nom, prix, stock, description: '' });
      }
    });

    if (vins.length === 0) {
      toast('Veuillez indiquer au moins un prix pour cr√©er la campagne.', true);
      return;
    }

    createBtn.textContent = 'Cr√©ation en cours‚Ä¶';
    createBtn.disabled = true;

    try {
      const { db } = window.GFA;
      const { collection, doc, setDoc, addDoc, getDocs, updateDoc, query, where } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

      // 1. Sauvegarder prix de r√©f√©rence si fourni
      if (prixRef) {
        g.prix_bouteille_reference = prixRef;
        await window.GFA.saveGroupement(g);
      }

      // 2. Cr√©er la campagne
      const campagneRef = doc(collection(db, 'groupements', g.id, 'campagnes'));
      await setDoc(campagneRef, {
        annee,
        actif: true,
        date_fin: fin,
        prix_bouteille_reference: prixRef,
        cree_le: new Date().toISOString()
      });

      // D√©sactiver les autres campagnes actives du groupement
      const autresCampagnes = await getDocs(
        query(collection(db, 'groupements', g.id, 'campagnes'), where('actif', '==', true))
      );
      for (const campDoc of autresCampagnes.docs) {
        if (campDoc.id !== campagneRef.id) {
          await updateDoc(doc(db, 'groupements', g.id, 'campagnes', campDoc.id), { actif: false });
        }
      }

      // 3. Cr√©er les vins dans la sous-collection
      for (const vin of vins) {
        await addDoc(collection(db, 'groupements', g.id, 'campagnes', campagneRef.id, 'vins'), {
          nom: vin.nom,
          prix: vin.prix,
          stock: vin.stock,
          description: vin.description
        });
      }

      closeModal();
      toast(`Campagne ${annee} cr√©√©e avec ${vins.length} vin${vins.length>1?'s':''}.`);
      
      // Recharger pour afficher la nouvelle campagne
      setTimeout(() => location.reload(), 1500);

    } catch(err) {
      console.error(err);
      toast('Erreur lors de la cr√©ation. V√©rifiez la console.', true);
      createBtn.textContent = 'Cr√©er la campagne';
      createBtn.disabled = false;
    }
  };

  // Boutons email individuels
  box.querySelectorAll('.nc-mail-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const a = associesActifs.find(x => x.id === btn.dataset.aid);
      if (!a) return;
      const annee = parseInt(box.querySelector('#nc-annee').value) || anneeActuelle;
      const fin   = box.querySelector('#nc-fin').value.trim();
      window.MAIL.ouvrirMailCampagne(a, g, annee, fin);
    });
  });

  // Bouton "envoyer √† tous"
  const btnAll = box.querySelector('#nc-all');
  if (btnAll) {
    btnAll.addEventListener('click', async () => {
      const annee = parseInt(box.querySelector('#nc-annee').value) || anneeActuelle;
      const fin   = box.querySelector('#nc-fin').value.trim();
      btnAll.textContent = 'Ouverture des emails‚Ä¶';
      btnAll.disabled = true;
      
      for (let i = 0; i < associesActifs.length; i++) {
        const a     = associesActifs[i];
        const lien  = `${location.origin}/associe.html?token=${a.token}`;
        const ppb   = g.parts_pour_bouteille || 1;
        const prix  = g.prix_bouteille_reference || 0;
        const creds = ((a.parts || 0) / ppb * prix).toFixed(2);
        const sujet = encodeURIComponent(`üç∑ Campagne GFA ${annee} ‚Äî Passez votre commande`);
        const corps = encodeURIComponent(
`Bonjour ${a.prenom},

La campagne ${annee} est ouverte pour le groupement "${g.nom}".

Vos cr√©dits disponibles : ${creds} ‚Ç¨${fin ? `\nDate limite : ${fin}` : ''}

Votre espace de commande :
${lien}

Cordialement`);
        window.open(`mailto:${a.email}?subject=${sujet}&body=${corps}`, '_blank');
        await new Promise(r => setTimeout(r, 600));
      }
      
      btnAll.textContent = `‚úì ${associesActifs.length} email(s) pr√©par√©s`;
    });
  }

  openModal(box);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>
